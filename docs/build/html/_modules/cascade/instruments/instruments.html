
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>cascade.instruments.instruments &#8212; CASCADe 0.9 beta documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for cascade.instruments.instruments</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">CASCADe</span>

<span class="sd">Observatory and Instruments specific Module</span>

<span class="sd">@author: bouwman</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="k">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span><span class="p">,</span> <span class="n">abstractproperty</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="k">import</span> <span class="n">SimpleNamespace</span>
<span class="kn">import</span> <span class="nn">gc</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">ascii</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="k">import</span> <span class="n">Time</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="k">import</span> <span class="n">coordinates</span> <span class="k">as</span> <span class="n">coord</span>
<span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="k">import</span> <span class="n">WCS</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="k">import</span> <span class="n">sigma_clipped_stats</span>
<span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="k">import</span> <span class="n">Gaussian2DKernel</span><span class="p">,</span> <span class="n">interpolate_replace_nans</span>
<span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="k">import</span> <span class="n">Gaussian1DKernel</span>
<span class="kn">from</span> <span class="nn">photutils</span> <span class="k">import</span> <span class="n">IRAFStarFinder</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">interpolate</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">nnls</span>
<span class="kn">from</span> <span class="nn">skimage.feature</span> <span class="k">import</span> <span class="n">register_translation</span>
<span class="kn">from</span> <span class="nn">skimage.morphology</span> <span class="k">import</span> <span class="n">dilation</span>
<span class="kn">from</span> <span class="nn">skimage.morphology</span> <span class="k">import</span> <span class="n">square</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">..initialize</span> <span class="k">import</span> <span class="n">cascade_configuration</span>
<span class="kn">from</span> <span class="nn">..data_model</span> <span class="k">import</span> <span class="n">SpectralDataTimeSeries</span>
<span class="kn">from</span> <span class="nn">..utilities</span> <span class="k">import</span> <span class="n">find</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Observation&#39;</span><span class="p">,</span> <span class="s1">&#39;Spitzer&#39;</span><span class="p">,</span>
           <span class="s1">&#39;SpitzerIRS&#39;</span><span class="p">,</span> <span class="s1">&#39;HST&#39;</span><span class="p">,</span> <span class="s1">&#39;HSTWFC3&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="Observation"><a class="viewcode-back" href="../../../cascade.instruments.html#cascade.instruments.instruments.Observation">[docs]</a><span class="k">class</span> <span class="nc">Observation</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class handles the selection of the correct observatory and</span>
<span class="sd">    instrument classes and loads the time series data to be analyzed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">observatory_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_observatory_name</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__check_observation_type</span><span class="p">()</span>
        <span class="n">observations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__do_observations</span><span class="p">(</span><span class="n">observatory_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">observations</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_parameters</span> <span class="o">=</span> <span class="n">observations</span><span class="o">.</span><span class="n">par</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">observations</span><span class="p">,</span> <span class="s1">&#39;data_background&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset_background</span> <span class="o">=</span> <span class="n">observations</span><span class="o">.</span><span class="n">data_background</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observatory</span> <span class="o">=</span> <span class="n">observations</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span> <span class="o">=</span> <span class="n">observations</span><span class="o">.</span><span class="n">instrument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectral_trace</span> <span class="o">=</span> <span class="n">observations</span><span class="o">.</span><span class="n">spectral_trace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instrument_calibration</span> <span class="o">=</span> <span class="n">observations</span><span class="o">.</span><span class="n">instrument_calibration</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__valid_observatories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;SPITZER&quot;</span><span class="p">:</span> <span class="n">Spitzer</span><span class="p">,</span> <span class="s2">&quot;HST&quot;</span><span class="p">:</span> <span class="n">HST</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__valid_observation_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;TRANSIT&quot;</span><span class="p">,</span> <span class="s2">&quot;ECLIPSE&quot;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__do_observations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observatory</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_observatories</span><span class="p">[</span><span class="n">observatory</span><span class="p">]()</span>

    <span class="k">def</span> <span class="nf">__get_observatory_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">isInitialized</span><span class="p">:</span>
            <span class="n">observatory</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">instrument_observatory</span>
            <span class="k">if</span> <span class="n">observatory</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_observatories</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Observatory not recognized, </span><span class="se">\</span>
<span class="s2">                                 check your init file for the following </span><span class="se">\</span>
<span class="s2">                                 valid observatories: </span><span class="si">{}</span><span class="s2">. Aborting loading </span><span class="se">\</span>
<span class="s2">                                 observatory&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span>
                                 <span class="n">__valid_observatories</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CASCADe not initialized, </span><span class="se">\</span>
<span class="s2">                                 aborting loading Observations&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">observatory</span>

    <span class="k">def</span> <span class="nf">__check_observation_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">isInitialized</span><span class="p">:</span>
            <span class="n">observation_type</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">observations_type</span>
            <span class="k">if</span> <span class="n">observation_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_observation_type</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Observation type not recognized, </span><span class="se">\</span>
<span class="s2">                                 check your init file for the following </span><span class="se">\</span>
<span class="s2">                                 valid observatories: </span><span class="si">{}</span><span class="s2">. Aborting loading </span><span class="se">\</span>
<span class="s2">                                 observatory&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span>
                                 <span class="n">__valid_observation_type</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CASCADe not initialized, </span><span class="se">\</span>
<span class="s2">                                 aborting loading Observations&quot;</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">ObservatoryBase</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="nd">@abstractproperty</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@abstractproperty</span>
    <span class="k">def</span> <span class="nf">location</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@abstractproperty</span>
    <span class="k">def</span> <span class="nf">NAIF_ID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@abstractproperty</span>
    <span class="k">def</span> <span class="nf">observatory_instruments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">InstrumentBase</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_instrument_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@abstractproperty</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>


<div class="viewcode-block" id="HST"><a class="viewcode-back" href="../../../cascade.instruments.html#cascade.instruments.instruments.HST">[docs]</a><span class="k">class</span> <span class="nc">HST</span><span class="p">(</span><span class="n">ObservatoryBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This observatory class defines the instuments and data handling for the</span>
<span class="sd">    spectropgraphs of the Spitzer Space telescope</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># check if cascade is initialized</span>
        <span class="k">if</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">isInitialized</span><span class="p">:</span>
            <span class="c1"># check if model is implemented and pick model</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cascade_configuration</span><span class="o">.</span><span class="n">instrument</span> <span class="ow">in</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">observatory_instruments</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">instrument</span> <span class="o">==</span> <span class="s1">&#39;WFC3&#39;</span><span class="p">:</span>
                    <span class="n">factory</span> <span class="o">=</span> <span class="n">HSTWFC3</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">par</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">par</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">data</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spectral_trace</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">spectral_trace</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_has_backgr&#39;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data_background</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">data_background</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">name</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">instrument_calibration</span> <span class="o">=</span> \
                        <span class="n">factory</span><span class="o">.</span><span class="n">instrument_calibration</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;HST instrument not recognized, </span><span class="se">\</span>
<span class="s2">                                 check your init file for the following </span><span class="se">\</span>
<span class="s2">                                 valid instruments: </span><span class="si">{}</span><span class="s2">. Aborting loading </span><span class="se">\</span>
<span class="s2">                                 instrument&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_instruments</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CASCADe not initialized, </span><span class="se">\</span>
<span class="s2">                                 aborting loading Observatory&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;HST&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">location</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;SPACE&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">NAIF_ID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">48</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">observatory_instruments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span><span class="p">{</span><span class="s2">&quot;WFC3&quot;</span><span class="p">}</span></div>


<div class="viewcode-block" id="HSTWFC3"><a class="viewcode-back" href="../../../cascade.instruments.html#cascade.instruments.instruments.HSTWFC3">[docs]</a><span class="k">class</span> <span class="nc">HSTWFC3</span><span class="p">(</span><span class="n">InstrumentBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This instrument class defines the properties of the WFC3 instrument of</span>
<span class="sd">    the Hubble Space Telescope</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__valid_sub_array</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IRSUB128&#39;</span><span class="p">,</span> <span class="s1">&#39;IRSUB256&#39;</span><span class="p">,</span> <span class="s1">&#39;IRSUB512&#39;</span><span class="p">,</span> <span class="s1">&#39;GRISM128&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;GRISM256&#39;</span><span class="p">,</span> <span class="s1">&#39;GRISM512&#39;</span><span class="p">}</span>
    <span class="n">__valid_spectroscopic_filter</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;G141&#39;</span><span class="p">}</span>
    <span class="n">__valid_imaging_filter</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;F139M&#39;</span><span class="p">,</span> <span class="s1">&#39;F132N&#39;</span><span class="p">,</span> <span class="s1">&#39;F167N&#39;</span><span class="p">}</span>
    <span class="n">__valid_beams</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">}</span>
    <span class="n">__valid_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SPECTRUM&#39;</span><span class="p">,</span> <span class="s1">&#39;SPECTRAL_IMAGE&#39;</span><span class="p">}</span>
    <span class="n">__valid_observing_strategy</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;STARING&#39;</span><span class="p">}</span>
    <span class="n">__valid_data_products</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SPC&#39;</span><span class="p">,</span> <span class="s1">&#39;flt&#39;</span><span class="p">,</span> <span class="s1">&#39;COE&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instrument_setup</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_has_backgr&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_background</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectral_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectral_trace</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_define_region_of_interest</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instrument_calibration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instrument_calibration</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;WFC3&quot;</span>

<div class="viewcode-block" id="HSTWFC3.load_data"><a class="viewcode-back" href="../../../cascade.instruments.html#cascade.instruments.instruments.HSTWFC3.load_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;obs_data&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SPECTRUM&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectra</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_has_backgr&#39;</span><span class="p">]:</span>
                <span class="n">data_back</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectra</span><span class="p">(</span><span class="n">is_background</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;obs_data&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SPECTRAL_IMAGE&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectral_images</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_has_backgr&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_uses_backgr_model&#39;</span><span class="p">]:</span>
                    <span class="n">data_back</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectral_images</span><span class="p">(</span><span class="n">is_background</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_background_cal_data</span><span class="p">()</span>
                    <span class="n">data_back</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_background</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_has_backgr&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_back</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="HSTWFC3.get_instrument_setup"><a class="viewcode-back" href="../../../cascade.instruments.html#cascade.instruments.instruments.HSTWFC3.get_instrument_setup">[docs]</a>    <span class="k">def</span> <span class="nf">get_instrument_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve all relevant parameters defining the instrument and data setup</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># instrument parameters</span>
        <span class="n">inst_inst_name</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">instrument</span>
        <span class="n">inst_filter</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">instrument_filter</span>
        <span class="n">inst_cal_filter</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">instrument_cal_filter</span>
        <span class="n">inst_aperture</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">instrument_aperture</span>
        <span class="n">inst_cal_aperture</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">instrument_cal_aperture</span>
        <span class="n">inst_beam</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">instrument_beam</span>
        <span class="c1"># object parameters</span>
        <span class="n">obj_period</span> <span class="o">=</span> \
            <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">cascade_configuration</span><span class="o">.</span><span class="n">object_period</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
        <span class="n">obj_period</span> <span class="o">=</span> <span class="n">obj_period</span><span class="o">.</span><span class="n">value</span>
        <span class="n">obj_ephemeris</span> <span class="o">=</span> \
            <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">cascade_configuration</span><span class="o">.</span><span class="n">object_ephemeris</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
        <span class="n">obj_ephemeris</span> <span class="o">=</span> <span class="n">obj_ephemeris</span><span class="o">.</span><span class="n">value</span>
        <span class="c1"># observation parameters</span>
        <span class="n">obs_mode</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">observations_mode</span>
        <span class="n">obs_data</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">observations_data</span>
        <span class="n">obs_path</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">observations_path</span>
        <span class="n">obs_cal_path</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">observations_cal_path</span>
        <span class="n">obs_id</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">observations_id</span>
        <span class="n">obs_cal_version</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">observations_cal_version</span>
        <span class="n">obs_data_product</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">observations_data_product</span>
        <span class="n">obs_target_name</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">observations_target_name</span>
        <span class="n">obs_has_backgr</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">cascade_configuration</span><span class="o">.</span>
                                          <span class="n">observations_has_background</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obs_uses_backgr_model</span> <span class="o">=</span> \
                <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">cascade_configuration</span><span class="o">.</span>
                                 <span class="n">observations_uses_background_model</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">obs_uses_backgr_model</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">obs_has_backgr</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">obs_uses_backgr_model</span><span class="p">:</span>
            <span class="n">obs_backgr_id</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">observations_background_id</span>
            <span class="n">obs_backgr_target_name</span> <span class="o">=</span> \
                <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">observations_background_name</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">obs_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_data</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data type not recognized, </span><span class="se">\</span>
<span class="s2">                     check your init file for the following </span><span class="se">\</span>
<span class="s2">                     valid types: </span><span class="si">{}</span><span class="s2">. </span><span class="se">\</span>
<span class="s2">                     Aborting loading data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__valid_data</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">obs_mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_observing_strategy</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Observational stategy not recognized, </span><span class="se">\</span>
<span class="s2">                     check your init file for the following </span><span class="se">\</span>
<span class="s2">                     valid types: </span><span class="si">{}</span><span class="s2">. </span><span class="se">\</span>
<span class="s2">                     Aborting loading data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__valid_data</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inst_filter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_spectroscopic_filter</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Instrument spectroscopic filter not recognized, </span><span class="se">\</span>
<span class="s2">                     check your init file for the following </span><span class="se">\</span>
<span class="s2">                     valid types: </span><span class="si">{}</span><span class="s2">. Aborting loading </span><span class="se">\</span>
<span class="s2">                     data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__valid_spectroscopic_filter</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inst_cal_filter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_imaging_filter</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Filter of calibration image not recognized, </span><span class="se">\</span>
<span class="s2">                     check your init file for the following </span><span class="se">\</span>
<span class="s2">                     valid types: </span><span class="si">{}</span><span class="s2">. Aborting loading </span><span class="se">\</span>
<span class="s2">                     data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__valid_imaging_filter</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inst_aperture</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_sub_array</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Spectroscopic subarray not recognized, </span><span class="se">\</span>
<span class="s2">                     check your init file for the following </span><span class="se">\</span>
<span class="s2">                     valid types: </span><span class="si">{}</span><span class="s2">. Aborting loading </span><span class="se">\</span>
<span class="s2">                     data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__valid_sub_array</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inst_cal_aperture</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_sub_array</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Calibration image subarray not recognized, </span><span class="se">\</span>
<span class="s2">                     check your init file for the following </span><span class="se">\</span>
<span class="s2">                     valid types: </span><span class="si">{}</span><span class="s2">. Aborting loading </span><span class="se">\</span>
<span class="s2">                     data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__valid_sub_array</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inst_beam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_beams</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Beam (spectral order) not recognized, </span><span class="se">\</span>
<span class="s2">                     check your init file for the following </span><span class="se">\</span>
<span class="s2">                     valid types: </span><span class="si">{}</span><span class="s2">. Aborting loading </span><span class="se">\</span>
<span class="s2">                     data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__valid_beams</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">obs_data_product</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_data_products</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data product not recognized, </span><span class="se">\</span>
<span class="s2">                     check your init file for the following </span><span class="se">\</span>
<span class="s2">                     valid types: </span><span class="si">{}</span><span class="s2">. Aborting loading </span><span class="se">\</span>
<span class="s2">                     data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__valid_data_products</span><span class="p">))</span>
        <span class="n">par</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="n">inst_inst_name</span><span class="o">=</span><span class="n">inst_inst_name</span><span class="p">,</span>
                                      <span class="n">inst_filter</span><span class="o">=</span><span class="n">inst_filter</span><span class="p">,</span>
                                      <span class="n">inst_cal_filter</span><span class="o">=</span><span class="n">inst_cal_filter</span><span class="p">,</span>
                                      <span class="n">inst_aperture</span><span class="o">=</span><span class="n">inst_aperture</span><span class="p">,</span>
                                      <span class="n">inst_cal_aperture</span><span class="o">=</span><span class="n">inst_cal_aperture</span><span class="p">,</span>
                                      <span class="n">inst_beam</span><span class="o">=</span><span class="n">inst_beam</span><span class="p">,</span>
                                      <span class="n">obj_period</span><span class="o">=</span><span class="n">obj_period</span><span class="p">,</span>
                                      <span class="n">obj_ephemeris</span><span class="o">=</span><span class="n">obj_ephemeris</span><span class="p">,</span>
                                      <span class="n">obs_mode</span><span class="o">=</span><span class="n">obs_mode</span><span class="p">,</span>
                                      <span class="n">obs_data</span><span class="o">=</span><span class="n">obs_data</span><span class="p">,</span>
                                      <span class="n">obs_path</span><span class="o">=</span><span class="n">obs_path</span><span class="p">,</span>
                                      <span class="n">obs_cal_path</span><span class="o">=</span><span class="n">obs_cal_path</span><span class="p">,</span>
                                      <span class="n">obs_id</span><span class="o">=</span><span class="n">obs_id</span><span class="p">,</span>
                                      <span class="n">obs_cal_version</span><span class="o">=</span><span class="n">obs_cal_version</span><span class="p">,</span>
                                      <span class="n">obs_data_product</span><span class="o">=</span><span class="n">obs_data_product</span><span class="p">,</span>
                                      <span class="n">obs_target_name</span><span class="o">=</span><span class="n">obs_target_name</span><span class="p">,</span>
                                      <span class="n">obs_has_backgr</span><span class="o">=</span><span class="n">obs_has_backgr</span><span class="p">,</span>
                                      <span class="n">obs_uses_backgr_model</span><span class="o">=</span><span class="n">obs_uses_backgr_model</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obs_has_backgr</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">obs_uses_backgr_model</span><span class="p">:</span>
            <span class="n">par</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;obs_backgr_id&#39;</span><span class="p">:</span> <span class="n">obs_backgr_id</span><span class="p">})</span>
            <span class="n">par</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;obs_backgr_target_name&#39;</span><span class="p">:</span> <span class="n">obs_backgr_target_name</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">par</span></div>

<div class="viewcode-block" id="HSTWFC3.get_spectra"><a class="viewcode-back" href="../../../cascade.instruments.html#cascade.instruments.instruments.HSTWFC3.get_spectra">[docs]</a>    <span class="k">def</span> <span class="nf">get_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_background</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        read (uncalibrated) spectral timeseries, phase and wavelength</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get data files</span>
        <span class="k">if</span> <span class="n">is_background</span><span class="p">:</span>
            <span class="c1"># obsid = self.par[&#39;obs_backgr_id&#39;]</span>
            <span class="n">target_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_backgr_target_name&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># obsid = self.par[&#39;obs_id&#39;]</span>
            <span class="n">target_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_target_name&#39;</span><span class="p">]</span>

        <span class="n">path_to_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_path&#39;</span><span class="p">],</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_inst_name&#39;</span><span class="p">],</span>
                                     <span class="n">target_name</span><span class="p">,</span>
                                     <span class="s1">&#39;SPECTRA/&#39;</span><span class="p">)</span>
        <span class="n">data_files</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_data_product&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="n">path_to_files</span><span class="p">)</span>

        <span class="c1"># number of integrations</span>
        <span class="n">nintegrations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_files</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nintegrations</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;No Timeseries data found in dir &quot;</span> <span class="o">+</span>
                                 <span class="n">path_to_files</span><span class="p">)</span>

        <span class="n">spectral_data_file</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">spectral_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">spectral_data_file</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">nwavelength</span> <span class="o">=</span> <span class="n">spectral_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># get the data</span>
        <span class="n">spectral_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nwavelength</span><span class="p">,</span> <span class="n">nintegrations</span><span class="p">))</span>
        <span class="n">uncertainty_spectral_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nwavelength</span><span class="p">,</span> <span class="n">nintegrations</span><span class="p">))</span>
        <span class="n">wavelength_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nwavelength</span><span class="p">,</span> <span class="n">nintegrations</span><span class="p">))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">make_mask_none</span><span class="p">(</span><span class="n">spectral_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nintegrations</span><span class="p">))</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nintegrations</span><span class="p">))</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nintegrations</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">im</span><span class="p">,</span> <span class="n">spectral_data_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">data_files</span><span class="p">,</span>
                                                     <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
            <span class="c1"># WARNING fits data is single precision!!</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">spectral_data_file</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">spectral_data</span><span class="p">[:,</span> <span class="n">im</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;FLUX&#39;</span><span class="p">]</span>
            <span class="n">uncertainty_spectral_data</span><span class="p">[:,</span> <span class="n">im</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;FERROR&#39;</span><span class="p">]</span>
            <span class="n">wavelength_data</span><span class="p">[:,</span> <span class="n">im</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;LAMBDA&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mask</span><span class="p">[:,</span> <span class="n">im</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">position</span><span class="p">[</span><span class="n">im</span><span class="p">]</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">spectral_data_file</span><span class="p">,</span> <span class="s2">&quot;POSITION&quot;</span><span class="p">,</span>
                                           <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">phase</span><span class="p">[</span><span class="n">im</span><span class="p">]</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">spectral_data_file</span><span class="p">,</span> <span class="s2">&quot;PHASE&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">hasPhase</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">hasPhase</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">time</span><span class="p">[</span><span class="n">im</span><span class="p">]</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">spectral_data_file</span><span class="p">,</span> <span class="s2">&quot;TIME_BJD&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">hasTimeBJD</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">hasTimeBJD</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">exptime</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">spectral_data_file</span><span class="p">,</span> <span class="s2">&quot;EXPTIME&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">expstart</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">spectral_data_file</span><span class="p">,</span> <span class="s2">&quot;EXPSTART&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">time</span><span class="p">[</span><span class="n">im</span><span class="p">]</span> <span class="o">=</span> <span class="n">expstart</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">exptime</span><span class="o">/</span><span class="p">(</span><span class="mf">24.0</span><span class="o">*</span><span class="mf">3600.0</span><span class="p">))</span>
<span class="c1"># BUG FIX</span>
<span class="c1">#        if hasPhase:</span>
<span class="c1">#            idx = np.argsort(phase)</span>
<span class="c1">#        else:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">spectral_data</span> <span class="o">=</span> <span class="n">spectral_data</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span>
        <span class="n">uncertainty_spectral_data</span> <span class="o">=</span> <span class="n">uncertainty_spectral_data</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span>
        <span class="n">wavelength_data</span> <span class="o">=</span> <span class="n">wavelength_data</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span>
        <span class="n">data_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">position</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">hasTimeBJD</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">hasPhase</span><span class="p">):</span>
            <span class="c1"># convert to BJD</span>
            <span class="n">ra_target</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">data_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;RA_TARG&quot;</span><span class="p">)</span>
            <span class="n">dec_target</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">data_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;DEC_TARG&quot;</span><span class="p">)</span>
            <span class="n">target_coord</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra_target</span><span class="p">,</span> <span class="n">dec_target</span><span class="p">,</span>
                                          <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span>
            <span class="n">time_obs</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;mjd&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">,</span>
                            <span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;0d&#39;</span><span class="p">,</span> <span class="s1">&#39;0d&#39;</span><span class="p">))</span>
            <span class="n">ltt_bary_jpl</span> <span class="o">=</span> <span class="n">time_obs</span><span class="o">.</span><span class="n">light_travel_time</span><span class="p">(</span><span class="n">target_coord</span><span class="p">,</span>
                                                      <span class="n">ephemeris</span><span class="o">=</span><span class="s1">&#39;jpl&#39;</span><span class="p">)</span>
            <span class="n">time_barycentre</span> <span class="o">=</span> <span class="n">time_obs</span><span class="o">.</span><span class="n">tdb</span> <span class="o">+</span> <span class="n">ltt_bary_jpl</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">time_barycentre</span><span class="o">.</span><span class="n">jd</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">hasPhase</span><span class="p">:</span>
            <span class="c1"># orbital phase</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obj_ephemeris&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obj_period&#39;</span><span class="p">]</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">phase</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">+</span> <span class="mf">1.0</span>

        <span class="c1"># set the units of the observations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_data_product&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;COE&#39;</span><span class="p">:</span>
            <span class="n">flux_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;electron/s&quot;</span><span class="p">)</span>
            <span class="n">wave_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;micron&#39;</span><span class="p">)</span>
            <span class="n">time_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">day</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flux_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;erg cm-2 s-1 Angstrom-1&quot;</span><span class="p">)</span>
            <span class="n">wave_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;Angstrom&#39;</span><span class="p">)</span>
            <span class="n">time_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">day</span>

        <span class="n">time</span> <span class="o">=</span> <span class="n">time</span> <span class="o">*</span> <span class="n">time_unit</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_define_convolution_kernel</span><span class="p">()</span>

        <span class="n">SpectralTimeSeries</span> <span class="o">=</span> \
            <span class="n">SpectralDataTimeSeries</span><span class="p">(</span><span class="n">wavelength</span><span class="o">=</span><span class="n">wavelength_data</span><span class="p">,</span>
                                   <span class="n">wavelength_unit</span><span class="o">=</span><span class="n">wave_unit</span><span class="p">,</span>
                                   <span class="n">data</span><span class="o">=</span><span class="n">spectral_data</span><span class="p">,</span>
                                   <span class="n">data_unit</span><span class="o">=</span><span class="n">flux_unit</span><span class="p">,</span>
                                   <span class="n">uncertainty</span><span class="o">=</span><span class="n">uncertainty_spectral_data</span><span class="p">,</span>
                                   <span class="n">time</span><span class="o">=</span><span class="n">phase</span><span class="p">,</span>
                                   <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                                   <span class="n">time_bjd</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
                                   <span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
                                   <span class="n">isRampFitted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">isNodded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">dataFiles</span><span class="o">=</span><span class="n">data_files</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SpectralTimeSeries</span></div>

<div class="viewcode-block" id="HSTWFC3.get_spectral_images"><a class="viewcode-back" href="../../../cascade.instruments.html#cascade.instruments.instruments.HSTWFC3.get_spectral_images">[docs]</a>    <span class="k">def</span> <span class="nf">get_spectral_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_background</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        read uncalibrated spectral images (flt data product)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get data files</span>
        <span class="k">if</span> <span class="n">is_background</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_uses_backgr_model&#39;</span><span class="p">]:</span>
            <span class="n">target_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_backgr_target_name&#39;</span><span class="p">]</span>
            <span class="c1"># obsid = self.par[&#39;obs_backgr_id&#39;]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># obsid = self.par[&#39;obs_id&#39;]</span>
            <span class="n">target_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_target_name&#39;</span><span class="p">]</span>

        <span class="n">path_to_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_path&#39;</span><span class="p">],</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_inst_name&#39;</span><span class="p">],</span>
                                     <span class="n">target_name</span><span class="p">,</span>
                                     <span class="s1">&#39;SPECTRAL_IMAGES/&#39;</span><span class="p">)</span>
        <span class="n">data_files</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;*_&#39;</span> <span class="o">+</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_data_product&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="n">path_to_files</span><span class="p">)</span>

        <span class="c1"># check if time series data can be found</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_files</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;No Timeseries data found in the </span><span class="se">\</span>
<span class="s2">                                 directory: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_to_files</span><span class="p">))</span>

        <span class="c1"># get the data</span>
        <span class="n">calibration_image_cube</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">spectral_image_cube</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">spectral_image_unc_cube</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">spectral_image_dq_cube</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">time</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cal_time</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">spectral_data_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">calibration_data_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">im</span><span class="p">,</span> <span class="n">image_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">data_files</span><span class="p">,</span> <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
                <span class="n">instrument_fiter</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">]</span>
                <span class="n">exptime</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">]</span>
                <span class="n">expstart</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXPSTART&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">instrument_fiter</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;inst_filter&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">instrument_fiter</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;inst_cal_filter&quot;</span><span class="p">]:</span>
                        <span class="n">calibration_image</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                        <span class="n">calibration_image_cube</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calibration_image</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                        <span class="n">calibration_data_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span>
                        <span class="n">cal_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expstart</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">exptime</span><span class="o">/</span><span class="p">(</span><span class="mf">24.0</span><span class="o">*</span><span class="mf">3600.0</span><span class="p">)))</span>
                        <span class="k">del</span> <span class="n">calibration_image</span>
                    <span class="k">continue</span>
                <span class="n">spectral_image</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                <span class="n">spectral_image_cube</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spectral_image</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                <span class="n">spectral_image_unc</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="s1">&#39;ERR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                <span class="n">spectral_image_unc_cube</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spectral_image_unc</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                <span class="n">spectral_image_dq</span> <span class="o">=</span> <span class="n">spectral_image_unc</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="s1">&#39;DQ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                <span class="n">spectral_image_dq_cube</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spectral_image_dq</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                <span class="n">spectral_data_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expstart</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">exptime</span><span class="o">/</span><span class="p">(</span><span class="mf">24.0</span><span class="o">*</span><span class="mf">3600.0</span><span class="p">)))</span>
                <span class="k">del</span> <span class="n">spectral_image</span>
                <span class="k">del</span> <span class="n">spectral_image_unc</span>
                <span class="k">del</span> <span class="n">spectral_image_dq</span>
                <span class="k">del</span> <span class="n">instrument_fiter</span>
                <span class="k">del</span> <span class="n">expstart</span>
                <span class="k">del</span> <span class="n">exptime</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectral_image_cube</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No science data found for the </span><span class="se">\</span>
<span class="s2">                             filter: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;inst_filter&quot;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">calibration_image_cube</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No calibration image found for the </span><span class="se">\</span>
<span class="s2">                             filter: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;inst_cal_filter&quot;</span><span class="p">]))</span>

        <span class="c1"># WARNING fits data is single precision!!</span>
        <span class="n">spectral_image_cube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spectral_image_cube</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">spectral_image_unc_cube</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spectral_image_unc_cube</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">spectral_image_dq_cube</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spectral_image_dq_cube</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">calibration_image_cube</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calibration_image_cube</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">cal_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cal_time</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="n">idx_time_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="n">idx_time_sort</span><span class="p">]</span>
        <span class="n">spectral_image_cube</span> <span class="o">=</span> <span class="n">spectral_image_cube</span><span class="p">[</span><span class="n">idx_time_sort</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">spectral_image_unc_cube</span> <span class="o">=</span> <span class="n">spectral_image_unc_cube</span><span class="p">[</span><span class="n">idx_time_sort</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">spectral_image_dq_cube</span> <span class="o">=</span> <span class="n">spectral_image_dq_cube</span><span class="p">[</span><span class="n">idx_time_sort</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">spectral_data_files</span> <span class="o">=</span> \
            <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spectral_data_files</span><span class="p">)[</span><span class="n">idx_time_sort</span><span class="p">])</span>

        <span class="n">idx_time_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">cal_time</span><span class="p">)</span>
        <span class="n">cal_time</span> <span class="o">=</span> <span class="n">cal_time</span><span class="p">[</span><span class="n">idx_time_sort</span><span class="p">]</span>
        <span class="n">calibration_image_cube</span> <span class="o">=</span> <span class="n">calibration_image_cube</span><span class="p">[</span><span class="n">idx_time_sort</span><span class="p">]</span>
        <span class="n">calibration_data_files</span> <span class="o">=</span> \
            <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calibration_data_files</span><span class="p">)[</span><span class="n">idx_time_sort</span><span class="p">])</span>

        <span class="n">nintegrations</span><span class="p">,</span> <span class="n">mpix</span><span class="p">,</span> <span class="n">npix</span> <span class="o">=</span> <span class="n">spectral_image_cube</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">nintegrations_cal</span><span class="p">,</span> <span class="n">ypix_cal</span><span class="p">,</span> <span class="n">xpix_cal</span> <span class="o">=</span> <span class="n">calibration_image_cube</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">spectral_image_dq_cube</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="n">spectral_image_dq_cube</span> <span class="o">!=</span> <span class="mi">8192</span><span class="p">))</span>

        <span class="c1"># convert to BJD</span>
        <span class="n">ra_target</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">spectral_data_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;RA_TARG&quot;</span><span class="p">)</span>
        <span class="n">dec_target</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">spectral_data_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;DEC_TARG&quot;</span><span class="p">)</span>
        <span class="n">target_coord</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra_target</span><span class="p">,</span> <span class="n">dec_target</span><span class="p">,</span>
                                      <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span>
        <span class="n">time_obs</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;mjd&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">,</span>
                        <span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;0d&#39;</span><span class="p">,</span> <span class="s1">&#39;0d&#39;</span><span class="p">))</span>
        <span class="n">cal_time_obs</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">cal_time</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;mjd&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">,</span>
                            <span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;0d&#39;</span><span class="p">,</span> <span class="s1">&#39;0d&#39;</span><span class="p">))</span>
        <span class="n">ltt_bary_jpl</span> <span class="o">=</span> <span class="n">time_obs</span><span class="o">.</span><span class="n">light_travel_time</span><span class="p">(</span><span class="n">target_coord</span><span class="p">,</span>
                                                  <span class="n">ephemeris</span><span class="o">=</span><span class="s1">&#39;jpl&#39;</span><span class="p">)</span>
        <span class="n">time_barycentre</span> <span class="o">=</span> <span class="n">time_obs</span><span class="o">.</span><span class="n">tdb</span> <span class="o">+</span> <span class="n">ltt_bary_jpl</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">time_barycentre</span><span class="o">.</span><span class="n">jd</span>
        <span class="n">cal_ltt_bary_jpl</span> <span class="o">=</span> <span class="n">cal_time_obs</span><span class="o">.</span><span class="n">light_travel_time</span><span class="p">(</span><span class="n">target_coord</span><span class="p">,</span>
                                                          <span class="n">ephemeris</span><span class="o">=</span><span class="s1">&#39;jpl&#39;</span><span class="p">)</span>
        <span class="n">cal_time_barycentre</span> <span class="o">=</span> <span class="n">cal_time_obs</span><span class="o">.</span><span class="n">tdb</span> <span class="o">+</span> <span class="n">cal_ltt_bary_jpl</span>
        <span class="n">cal_time</span> <span class="o">=</span> <span class="n">cal_time_barycentre</span><span class="o">.</span><span class="n">jd</span>

        <span class="c1"># orbital phase</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obj_ephemeris&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obj_period&#39;</span><span class="p">]</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">phase</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">+</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">-</span> <span class="mf">1.0</span>
        <span class="n">cal_phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">cal_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obj_ephemeris&#39;</span><span class="p">])</span> <span class="o">/</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obj_period&#39;</span><span class="p">]</span>
        <span class="n">cal_phase</span> <span class="o">=</span> <span class="n">cal_phase</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cal_phase</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cal_phase</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">cal_phase</span> <span class="o">=</span> <span class="n">cal_phase</span> <span class="o">+</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">cal_phase</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">cal_phase</span> <span class="o">=</span> <span class="n">cal_phase</span> <span class="o">-</span> <span class="mf">1.0</span>

        <span class="c1"># self._determine_relative_source_position(spectral_image_cube, mask)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_define_convolution_kernel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_determine_source_position_from_cal_image</span><span class="p">(</span>
                <span class="n">calibration_image_cube</span><span class="p">,</span> <span class="n">calibration_data_files</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_grism_configuration_files</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_reference_pixel_file</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_subarray_size</span><span class="p">(</span><span class="n">calibration_image_cube</span><span class="p">,</span> <span class="n">spectral_image_cube</span><span class="p">)</span>

        <span class="n">wave_cal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_wavelength_calibration</span><span class="p">()</span>

        <span class="n">flux_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">electron</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">second</span>
        <span class="n">spectral_image_cube</span> <span class="o">=</span> <span class="n">spectral_image_cube</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">flux_unit</span>
        <span class="n">spectral_image_unc_cube</span> <span class="o">=</span> <span class="n">spectral_image_unc_cube</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">flux_unit</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">T</span>

        <span class="n">time_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">day</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">time</span> <span class="o">*</span> <span class="n">time_unit</span>

        <span class="c1"># position = self.wfc3_cal.relative_source_shift[&#39;cross_disp_shift&#39;]</span>
        <span class="c1"># position = -position-np.median(-position)</span>

        <span class="n">SpectralTimeSeries</span> <span class="o">=</span> \
            <span class="n">SpectralDataTimeSeries</span><span class="p">(</span><span class="n">wavelength</span><span class="o">=</span><span class="n">wave_cal</span><span class="p">,</span>
                                   <span class="n">data</span><span class="o">=</span><span class="n">spectral_image_cube</span><span class="p">,</span>
                                   <span class="n">uncertainty</span><span class="o">=</span><span class="n">spectral_image_unc_cube</span><span class="p">,</span>
                                   <span class="n">time</span><span class="o">=</span><span class="n">phase</span><span class="p">,</span>
                                   <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                                   <span class="c1"># position=position,</span>
                                   <span class="n">time_bjd</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
                                   <span class="n">isRampFitted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">isNodded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">dataFiles</span><span class="o">=</span><span class="n">spectral_data_files</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_background</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_uses_backgr_model&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_background_cal_data</span><span class="p">()</span>
            <span class="n">SpectralTimeSeries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_background</span><span class="p">(</span><span class="n">SpectralTimeSeries</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SpectralTimeSeries</span></div>

    <span class="k">def</span> <span class="nf">_define_convolution_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define the instrument specific convolution kernel which will be used</span>
<span class="sd">        in the correction procedure of bad pixels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;obs_data&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SPECTRUM&#39;</span><span class="p">:</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="n">Gaussian1DKernel</span><span class="p">(</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">x_size</span><span class="o">=</span><span class="mi">19</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="n">Gaussian2DKernel</span><span class="p">(</span><span class="n">x_stddev</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">y_stddev</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
                                      <span class="n">theta</span><span class="o">=-</span><span class="mf">0.0092</span><span class="p">,</span> <span class="n">x_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">y_size</span><span class="o">=</span><span class="mi">19</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">convolution_kernel</span> <span class="o">=</span> <span class="n">kernel</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_define_region_of_interest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Defines region on detector which containes the intended target star.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;inst_beam&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
            <span class="n">wavelength_min</span> <span class="o">=</span> <span class="mf">1.082</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">micron</span>
            <span class="n">wavelength_max</span> <span class="o">=</span> <span class="mf">1.678</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">micron</span>
            <span class="c1"># wavelength_min = 1.100*u.micron</span>
            <span class="c1"># wavelength_max = 1.670*u.micron</span>
            <span class="n">roi_width</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_trace</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">mask_min</span> <span class="o">=</span> <span class="n">trace</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">wavelength_min</span>
        <span class="n">mask_max</span> <span class="o">=</span> <span class="n">trace</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">wavelength_max</span>
        <span class="n">mask_not_defined</span> <span class="o">=</span> <span class="n">trace</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.</span>
        <span class="n">idx_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s1">&#39;wavelength_pixel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask_min</span><span class="p">]))</span>
        <span class="n">idx_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s1">&#39;wavelength_pixel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask_max</span><span class="p">]))</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
            <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">idx_min</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">roi</span><span class="p">[</span><span class="n">idx_max</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">roi</span><span class="p">[</span><span class="n">mask_not_defined</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">center_pix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s1">&#39;positional_pixel&#39;</span><span class="p">]</span><span class="o">.</span>
                                     <span class="n">value</span><span class="p">[</span><span class="n">idx_min</span><span class="p">:</span><span class="n">idx_max</span><span class="p">]))</span>
            <span class="n">min_idx_pix</span> <span class="o">=</span> <span class="n">center_pix</span> <span class="o">-</span> <span class="n">roi_width</span><span class="o">//</span><span class="mi">2</span>
            <span class="n">max_idx_pix</span> <span class="o">=</span> <span class="n">center_pix</span> <span class="o">+</span> <span class="n">roi_width</span><span class="o">//</span><span class="mi">2</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">dim</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
            <span class="n">roi</span><span class="p">[</span><span class="n">idx_min</span><span class="p">:</span><span class="n">idx_max</span><span class="p">,</span> <span class="n">min_idx_pix</span><span class="p">:</span><span class="n">max_idx_pix</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">roi</span> <span class="o">=</span> <span class="n">roi</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_get_background_cal_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the calibration data from which the background in the science</span>
<span class="sd">        images can be determined.  For further details see:</span>
<span class="sd">        http://www.stsci.edu/hst/wfc3/documents/ISRs/WFC3-2015-17.pdf</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_applied_flatfields</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;G141&quot;</span><span class="p">:</span> <span class="s2">&quot;uc72113oi_pfl.fits&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;G102&quot;</span><span class="p">:</span> <span class="s2">&quot;uc721143i_pfl.fits&quot;</span><span class="p">}</span>
        <span class="n">_zodi_cal_files</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;G141&quot;</span><span class="p">:</span> <span class="s2">&quot;zodi_G141_clean.fits&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;G102&quot;</span><span class="p">:</span> <span class="s2">&quot;zodi_G102_clean.fits&quot;</span><span class="p">}</span>
        <span class="n">_helium_cal_files</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;G141&quot;</span><span class="p">:</span> <span class="s2">&quot;excess_lo_G141_clean.fits&quot;</span><span class="p">,</span>
                             <span class="s2">&quot;G102&quot;</span><span class="p">:</span> <span class="s2">&quot;excess_G102_clean.fits&quot;</span><span class="p">}</span>
        <span class="n">_scattered_cal_files</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;G141&quot;</span><span class="p">:</span> <span class="s2">&quot;G141_scattered_light.fits&quot;</span><span class="p">}</span>

        <span class="n">calibration_file_name_flatfield</span> <span class="o">=</span> \
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_cal_path&#39;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_inst_name&#39;</span><span class="p">],</span>
                         <span class="n">_applied_flatfields</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_filter&#39;</span><span class="p">]])</span>
        <span class="n">calibration_file_name_zodi</span> <span class="o">=</span> \
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_cal_path&#39;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_inst_name&#39;</span><span class="p">],</span>
                         <span class="n">_zodi_cal_files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_filter&#39;</span><span class="p">]])</span>
        <span class="n">calibration_file_name_helium</span> <span class="o">=</span> \
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_cal_path&#39;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_inst_name&#39;</span><span class="p">],</span>
                         <span class="n">_helium_cal_files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_filter&#39;</span><span class="p">]])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">zodi</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">calibration_file_name_zodi</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Calibration file </span><span class="si">{}</span><span class="s2"> for the </span><span class="se">\</span>
<span class="s2">                                contribution of the zodi to the </span><span class="se">\</span>
<span class="s2">                                background not found. </span><span class="se">\</span>
<span class="s2">                                Aborting&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">calibration_file_name_zodi</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">helium</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">calibration_file_name_helium</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Calibration file </span><span class="si">{}</span><span class="s2"> for the </span><span class="se">\</span>
<span class="s2">                                contribution of the helium excess to the </span><span class="se">\</span>
<span class="s2">                                background not found. </span><span class="se">\</span>
<span class="s2">                                Aborting&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">calibration_file_name_helium</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_filter&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;G141&#39;</span><span class="p">:</span>
            <span class="n">calibration_file_name_scattered</span> <span class="o">=</span> \
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_cal_path&#39;</span><span class="p">],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_inst_name&#39;</span><span class="p">],</span>
                             <span class="n">_scattered_cal_files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_filter&#39;</span><span class="p">]])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">scattered</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">calibration_file_name_scattered</span><span class="p">,</span>
                                         <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Calibration file </span><span class="si">{}</span><span class="s2"> for the </span><span class="se">\</span>
<span class="s2">                                        contribution of the excess excess </span><span class="se">\</span>
<span class="s2">                                        scattered light to the </span><span class="se">\</span>
<span class="s2">                                        background not found. </span><span class="se">\</span>
<span class="s2">                                        Aborting&quot;</span><span class="o">.</span>
                                        <span class="nb">format</span><span class="p">(</span><span class="n">calibration_file_name_helium</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scattered</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flatfield</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">calibration_file_name_flatfield</span><span class="p">,</span>
                                     <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">10</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Flatfield calibration file </span><span class="si">{}</span><span class="s2"> not </span><span class="se">\</span>
<span class="s2">                            found. </span><span class="se">\</span>
<span class="s2">                            Aborting&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">calibration_file_name_flatfield</span><span class="p">))</span>
        <span class="n">zodi</span> <span class="o">=</span> <span class="n">zodi</span><span class="o">*</span><span class="n">flatfield</span>
        <span class="n">helium</span> <span class="o">=</span> <span class="n">helium</span><span class="o">*</span><span class="n">flatfield</span>
        <span class="n">scattered</span> <span class="o">=</span> <span class="n">scattered</span><span class="o">*</span><span class="n">flatfield</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">subarray_sizes</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Necessary calibration data not yet defined. </span><span class="se">\</span>
<span class="s2">                                 Aborting loading background calibration file&quot;</span><span class="p">)</span>
        <span class="n">subarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">subarray_sizes</span><span class="p">[</span><span class="s1">&#39;science_image_size&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">subarray</span> <span class="o">&lt;</span> <span class="mi">1014</span><span class="p">:</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1014</span> <span class="o">-</span> <span class="n">subarray</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">zodi</span> <span class="o">=</span> <span class="n">zodi</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span> <span class="n">i0</span> <span class="o">+</span> <span class="n">subarray</span><span class="p">,</span> <span class="n">i0</span><span class="p">:</span> <span class="n">i0</span> <span class="o">+</span> <span class="n">subarray</span><span class="p">]</span>
            <span class="n">helium</span> <span class="o">=</span> <span class="n">helium</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span> <span class="n">i0</span> <span class="o">+</span> <span class="n">subarray</span><span class="p">,</span> <span class="n">i0</span><span class="p">:</span> <span class="n">i0</span> <span class="o">+</span> <span class="n">subarray</span><span class="p">]</span>
            <span class="n">scattered</span> <span class="o">=</span> <span class="n">scattered</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span> <span class="n">i0</span> <span class="o">+</span> <span class="n">subarray</span><span class="p">,</span> <span class="n">i0</span><span class="p">:</span> <span class="n">i0</span> <span class="o">+</span> <span class="n">subarray</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">background_cal_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;zodi&quot;</span><span class="p">:</span> <span class="n">zodi</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                             <span class="s2">&quot;helium&quot;</span><span class="p">:</span> <span class="n">helium</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                             <span class="s2">&quot;scattered&quot;</span><span class="p">:</span> <span class="n">scattered</span><span class="o">.</span><span class="n">T</span><span class="p">}</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_fit_background</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">science_data_in</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fits the background in the HST Grism data using the method described</span>
<span class="sd">        in: http://www.stsci.edu/hst/wfc3/documents/ISRs/WFC3-2015-17.pdf</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">background_cal_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">background_cal_data</span>
            <span class="n">zodi</span> <span class="o">=</span> <span class="n">background_cal_data</span><span class="p">[</span><span class="s1">&#39;zodi&#39;</span><span class="p">]</span>
            <span class="n">helium</span> <span class="o">=</span> <span class="n">background_cal_data</span><span class="p">[</span><span class="s1">&#39;helium&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Necessary calibration data not yet defined. </span><span class="se">\</span>
<span class="s2">                                 Aborting fitting background level&quot;</span><span class="p">)</span>

        <span class="n">mask_science_data_in</span> <span class="o">=</span> <span class="n">science_data_in</span><span class="o">.</span><span class="n">mask</span>
        <span class="n">data_science_data_in</span> <span class="o">=</span> <span class="n">science_data_in</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span>
        <span class="n">uncertainty_science_data_in</span> <span class="o">=</span> <span class="n">science_data_in</span><span class="o">.</span><span class="n">uncertainty</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span>
        <span class="n">time_science_data_in</span> <span class="o">=</span> <span class="n">science_data_in</span><span class="o">.</span><span class="n">time</span>
        <span class="n">wavelength_science_data_in</span> <span class="o">=</span> <span class="n">science_data_in</span><span class="o">.</span><span class="n">wavelength</span>

        <span class="c1"># step 1</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_science_data_in</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">uncertainty_science_data_in</span><span class="p">)</span>
        <span class="n">weights</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">uncertainty_science_data_in</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span><span class="o">**-</span><span class="mi">2</span>

        <span class="c1"># step 2a</span>
        <span class="n">fited_background</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data_science_data_in</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                     <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">nflagged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">iter_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span><span class="p">(</span><span class="n">iter_count</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iteration background fit: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iter_count</span><span class="p">))</span>
            <span class="c1"># step 2b</span>
            <span class="n">residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">*</span>
                              <span class="p">(</span><span class="n">data_science_data_in</span><span class="o">-</span><span class="n">fited_background</span><span class="p">))</span>
            <span class="n">mask_source</span> <span class="o">=</span> <span class="n">residual</span> <span class="o">&gt;</span> <span class="mf">3.0</span>

            <span class="c1"># step 3</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">mask_source</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
            <span class="n">nflagged_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nflagged_new</span> <span class="o">!=</span> <span class="n">nflagged</span><span class="p">:</span>
                <span class="n">nflagged</span> <span class="o">=</span> <span class="n">nflagged_new</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no additional sources found, stopping iteration&quot;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="c1"># step 4</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="c1"># step 5</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">nint</span> <span class="o">=</span> <span class="n">data_science_data_in</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">design_matrix</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">helium</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">helium</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                          <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">zodi</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">zodi</span><span class="o">.</span><span class="n">T</span><span class="p">)]))</span>
            <span class="n">design_matrix</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">helium</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">zodi</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                            <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">design_matrix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">design_matrix</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">helium</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span>
                                       <span class="n">data_science_data_in</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">zodi</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span>
                                       <span class="n">data_science_data_in</span><span class="o">.</span><span class="n">T</span><span class="p">)])</span>

            <span class="n">fit_parameters</span><span class="p">,</span> <span class="n">chi</span> <span class="o">=</span> <span class="n">nnls</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">,</span> <span class="n">vector</span><span class="p">)</span>

            <span class="n">fitted_backgroud</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">helium</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="p">(</span><span class="n">nint</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> \
                <span class="n">fit_parameters</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">zodi</span><span class="o">*</span><span class="n">fit_parameters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>

            <span class="c1"># update iter count and break if to many iterations</span>
            <span class="n">iter_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">sigma_hat_sqr</span> <span class="o">=</span> <span class="n">chi</span> <span class="o">/</span> <span class="p">(</span><span class="n">fit_parameters</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">err_fit_parameters</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma_hat_sqr</span> <span class="o">*</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                                 <span class="n">design_matrix</span><span class="p">))))</span>

        <span class="n">background</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;parameter&#39;</span><span class="p">:</span> <span class="n">fit_parameters</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">err_fit_parameters</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">background_model_parameters</span> <span class="o">=</span> <span class="n">background</span>

        <span class="n">uncertainty_background_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">helium</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="p">(</span><span class="n">nint</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> \
            <span class="n">err_fit_parameters</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">zodi</span><span class="o">*</span><span class="n">err_fit_parameters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>

        <span class="n">data_init</span> <span class="o">=</span> <span class="n">science_data_in</span><span class="o">.</span><span class="n">data_unit</span>
        <span class="n">uncertainty_background_model</span> <span class="o">=</span> <span class="n">uncertainty_background_model</span><span class="o">*</span><span class="n">data_init</span>
        <span class="n">fitted_backgroud</span> <span class="o">=</span> <span class="n">fitted_backgroud</span><span class="o">*</span><span class="n">data_init</span>

        <span class="n">SpectralTimeSeries</span> <span class="o">=</span> \
            <span class="n">SpectralDataTimeSeries</span><span class="p">(</span><span class="n">wavelength</span><span class="o">=</span><span class="n">wavelength_science_data_in</span><span class="p">,</span>
                                   <span class="n">data</span><span class="o">=</span><span class="n">fitted_backgroud</span><span class="p">,</span>
                                   <span class="n">uncertainty</span><span class="o">=</span><span class="n">uncertainty_background_model</span><span class="p">,</span>
                                   <span class="n">time</span><span class="o">=</span><span class="n">time_science_data_in</span><span class="p">,</span>
                                   <span class="n">mask</span><span class="o">=</span><span class="n">mask_science_data_in</span><span class="p">,</span>
                                   <span class="n">isRampFitted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">isNodded</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SpectralTimeSeries</span>

    <span class="k">def</span> <span class="nf">_determine_relative_source_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectral_image_cube</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the shift of the spectra (source) relative to the first</span>
<span class="sd">        integration. Note that it is important for this to work properly</span>
<span class="sd">        to have identified bad pixels and to correct the values using an edge</span>
<span class="sd">        preserving correction, i.e. an correction which takes into account</span>
<span class="sd">        the dispersion direction and psf size (relative to pixel size)</span>
<span class="sd">        Input:</span>
<span class="sd">        ------</span>
<span class="sd">            spectral_image_cube</span>

<span class="sd">            mask</span>

<span class="sd">        Output:</span>
<span class="sd">        ------</span>
<span class="sd">            relative x and y position as a function of time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nintegrations</span><span class="p">,</span> <span class="n">mpix</span><span class="p">,</span> <span class="n">npix</span> <span class="o">=</span> <span class="n">spectral_image_cube</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">image_cube_use</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spectral_image_cube</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">set_fill_value</span><span class="p">(</span><span class="n">image_cube_use</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;NaN&quot;</span><span class="p">))</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">Gaussian2DKernel</span><span class="p">(</span><span class="n">x_stddev</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">y_stddev</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">image0</span> <span class="o">=</span> <span class="n">image_cube_use</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">cleaned_image0</span> <span class="o">=</span> <span class="n">interpolate_replace_nans</span><span class="p">(</span><span class="n">image0</span><span class="o">.</span><span class="n">filled</span><span class="p">(),</span>
                                                  <span class="n">kernel</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;extend&#39;</span><span class="p">)</span>

        <span class="n">yshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nintegrations</span><span class="p">))</span>
        <span class="n">xshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nintegrations</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nintegrations</span><span class="p">):</span>
            <span class="n">cleaned_shifted_image</span> <span class="o">=</span> \
                <span class="n">interpolate_replace_nans</span><span class="p">(</span><span class="n">image_cube_use</span><span class="p">[</span><span class="n">it</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">filled</span><span class="p">(),</span>
                                         <span class="n">kernel</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;extend&#39;</span><span class="p">)</span>
            <span class="c1"># subpixel precision by oversmpling pixel by a factor of 100</span>
            <span class="n">shift</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">diffphase</span> <span class="o">=</span> \
                <span class="n">register_translation</span><span class="p">(</span><span class="n">cleaned_image0</span><span class="p">,</span>
                                     <span class="n">cleaned_shifted_image</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
            <span class="n">yshift</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">xshift</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">relative_source_shift</span> <span class="o">=</span> \
            <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="n">cross_disp_shift</span><span class="o">=</span><span class="n">yshift</span><span class="p">,</span>
                                    <span class="n">disp_shift</span><span class="o">=</span><span class="n">xshift</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">relative_source_shift</span> <span class="o">=</span> <span class="n">relative_source_shift</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_determine_source_position_from_cal_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calibration_image_cube</span><span class="p">,</span>
                                                  <span class="n">calibration_data_files</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines the source position on the detector of the target source in</span>
<span class="sd">        the calibration image takes prior to the spectroscopic observations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">calibration_source_position</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">im</span><span class="p">,</span> <span class="n">image_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">calibration_data_files</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
                <span class="n">ra_target</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;RA_TARG&#39;</span><span class="p">]</span>
                <span class="n">dec_target</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DEC_TARG&#39;</span><span class="p">]</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
                <span class="c1"># BUG FIX</span>
                <span class="c1">#            ra_target = fits.getval(image_file, &quot;RA_TARG&quot;)</span>
                <span class="c1">#            dec_target = fits.getval(image_file, &quot;DEC_TARG&quot;)</span>
                <span class="c1">#            hdu = fits.open(image_file)[1]</span>
                <span class="c1">#            w = WCS(hdu.header)</span>
                <span class="n">expected_target_position</span> <span class="o">=</span> \
                    <span class="n">w</span><span class="o">.</span><span class="n">all_world2pix</span><span class="p">(</span><span class="n">ra_target</span><span class="p">,</span> <span class="n">dec_target</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">expexted_xcentroid</span> <span class="o">=</span> <span class="n">expected_target_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">expected_ycentroid</span> <span class="o">=</span> <span class="n">expected_target_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> \
                    <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">calibration_image_cube</span><span class="p">[</span><span class="n">im</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                                        <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">iters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

                <span class="n">iraffind</span> <span class="o">=</span> <span class="n">IRAFStarFinder</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">30.</span><span class="o">*</span><span class="n">std</span><span class="p">)</span>

                <span class="n">sources</span> <span class="o">=</span> <span class="n">iraffind</span><span class="p">(</span><span class="n">calibration_image_cube</span><span class="p">[</span><span class="n">im</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">median</span><span class="p">)</span>
                <span class="n">distances</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">expexted_xcentroid</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                            <span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">expected_ycentroid</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">idx_target</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
                <span class="n">source_position</span> <span class="o">=</span> <span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="n">idx_target</span><span class="p">][</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span>
                                   <span class="n">sources</span><span class="p">[</span><span class="n">idx_target</span><span class="p">][</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">])</span>
                <span class="n">calibration_source_position</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source_position</span><span class="p">)</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">calibration_source_position</span> <span class="o">=</span> \
                <span class="n">calibration_source_position</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_read_grism_configuration_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the relevant data from WFC3 configuration files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">calibration_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_cal_path&#39;</span><span class="p">],</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_inst_name&#39;</span><span class="p">],</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_filter&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_cal_filter&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.V&#39;</span> <span class="o">+</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_cal_version&#39;</span><span class="p">]</span> <span class="o">+</span>
                                             <span class="s1">&#39;.conf&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">calibration_file_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">content_file</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">content_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">flag_DYDX0</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">flag_DYDX1</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">flag_DLDP0</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">flag_DLDP1</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
            <span class="c1"># parameters spectral trace</span>
            <span class="k">if</span> <span class="s1">&#39;DYDX_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_beam&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_0&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">DYDX0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
                <span class="n">flag_DYDX0</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s1">&#39;DYDX_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_beam&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_1&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">DYDX1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
                <span class="n">flag_DYDX1</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>
            <span class="c1"># parameters wavelength calibration</span>
            <span class="k">if</span> <span class="s1">&#39;DLDP_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_beam&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_0&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">DLDP0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
                <span class="n">flag_DLDP0</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s1">&#39;DLDP_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_beam&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_1&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">DLDP1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
                <span class="n">flag_DLDP1</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">flag_DYDX0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Spectral trace not found in calibration file, </span><span class="se">\</span>
<span class="s2">                     check </span><span class="si">{}</span><span class="s2"> file for the following entry: </span><span class="si">{}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                     Aborting&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">calibration_file_name</span><span class="p">,</span>
                                      <span class="s1">&#39;DYDX_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_beam&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_0&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">flag_DYDX1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Spectral trace not found in calibration file, </span><span class="se">\</span>
<span class="s2">                     check </span><span class="si">{}</span><span class="s2"> file for the following entry: </span><span class="si">{}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                     Aborting&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">calibration_file_name</span><span class="p">,</span>
                                      <span class="s1">&#39;DYDX_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_beam&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_1&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">flag_DLDP0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wavelength definition not found in calibration </span><span class="se">\</span>
<span class="s2">                     file, check </span><span class="si">{}</span><span class="s2"> file for the following entry: </span><span class="si">{}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                     Aborting&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">calibration_file_name</span><span class="p">,</span>
                                      <span class="s1">&#39;DLDP_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_beam&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_0&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">flag_DLDP1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wavelength definition not found in calibration </span><span class="se">\</span>
<span class="s2">                     file, check </span><span class="si">{}</span><span class="s2"> file for the following entry: </span><span class="si">{}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                     Aborting&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">calibration_file_name</span><span class="p">,</span>
                                      <span class="s1">&#39;DLDP_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_beam&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_1&#39;</span><span class="p">))</span>
        <span class="n">DYDX</span> <span class="o">=</span> <span class="p">[</span><span class="n">DYDX0</span><span class="p">,</span> <span class="n">DYDX1</span><span class="p">]</span>
        <span class="n">DLDP</span> <span class="o">=</span> <span class="p">[</span><span class="n">DLDP0</span><span class="p">,</span> <span class="n">DLDP1</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">DYDX</span> <span class="o">=</span> <span class="n">DYDX</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">DLDP</span> <span class="o">=</span> <span class="n">DLDP</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_read_reference_pixel_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the calibration file containig the definition</span>
<span class="sd">        of the reference pixel appropriate for a given sub array and or filer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">calibration_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_cal_path&#39;</span><span class="p">],</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_inst_name&#39;</span><span class="p">],</span>
                                             <span class="s1">&#39;wavelength_ref_pixel_&#39;</span> <span class="o">+</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_inst_name&#39;</span><span class="p">]</span><span class="o">.</span>
                                             <span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span><span class="p">)</span>

        <span class="n">ptable_cal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">calibration_file_name</span><span class="p">,</span>
                                   <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                   <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;APERTURE&#39;</span><span class="p">,</span> <span class="s1">&#39;FILTER&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;XREF&#39;</span><span class="p">,</span> <span class="s1">&#39;YREF&#39;</span><span class="p">])</span>

        <span class="n">XREF_GRISM</span><span class="p">,</span> <span class="n">YREF_GRISM</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_search_ref_pixel_cal_file</span><span class="p">(</span><span class="n">ptable_cal</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;inst_aperture&quot;</span><span class="p">],</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;inst_filter&quot;</span><span class="p">])</span>
        <span class="n">XREF_IMAGE</span><span class="p">,</span> <span class="n">YREF_IMAGE</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_search_ref_pixel_cal_file</span><span class="p">(</span><span class="n">ptable_cal</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;inst_cal_aperture&quot;</span><span class="p">],</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;inst_cal_filter&quot;</span><span class="p">])</span>

        <span class="n">reference_pixels</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="n">XREF_GRISM</span><span class="o">=</span><span class="n">XREF_GRISM</span><span class="p">,</span>
                                                   <span class="n">YREF_GRISM</span><span class="o">=</span><span class="n">YREF_GRISM</span><span class="p">,</span>
                                                   <span class="n">XREF_IMAGE</span><span class="o">=</span><span class="n">XREF_IMAGE</span><span class="p">,</span>
                                                   <span class="n">YREF_IMAGE</span><span class="o">=</span><span class="n">YREF_IMAGE</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">reference_pixels</span> <span class="o">=</span> <span class="n">reference_pixels</span>

        <span class="k">return</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_search_ref_pixel_cal_file</span><span class="p">(</span><span class="n">ptable</span><span class="p">,</span> <span class="n">inst_aperture</span><span class="p">,</span> <span class="n">inst_filter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search the reference pixel calibration file for the reference pixel</span>
<span class="sd">        given the instrument aperture and filter.</span>
<span class="sd">        See also http://www.stsci.edu/hst/observatory/apertures/wfc3.html</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ptable_aperture</span> <span class="o">=</span> \
            <span class="n">ptable</span><span class="p">[(</span><span class="n">ptable</span><span class="o">.</span><span class="n">APERTURE</span> <span class="o">==</span> <span class="n">inst_aperture</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">ptable_aperture</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">XREF</span> <span class="o">=</span> <span class="n">ptable_aperture</span><span class="o">.</span><span class="n">XREF</span><span class="o">.</span><span class="n">values</span>
            <span class="n">YREF</span> <span class="o">=</span> <span class="n">ptable_aperture</span><span class="o">.</span><span class="n">YREF</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ptable_aperture_filter</span> <span class="o">=</span> \
                <span class="n">ptable_aperture</span><span class="p">[(</span><span class="n">ptable_aperture</span><span class="o">.</span><span class="n">FILTER</span> <span class="o">==</span> <span class="n">inst_filter</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">ptable_aperture_filter</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">XREF</span> <span class="o">=</span> <span class="n">ptable_aperture_filter</span><span class="o">.</span><span class="n">XREF</span><span class="o">.</span><span class="n">values</span>
                <span class="n">YREF</span> <span class="o">=</span> <span class="n">ptable_aperture_filter</span><span class="o">.</span><span class="n">YREF</span><span class="o">.</span><span class="n">values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ptable_grism_filter</span> <span class="o">=</span> \
                    <span class="n">ptable_aperture</span><span class="p">[(</span><span class="n">ptable_aperture</span><span class="o">.</span><span class="n">FILTER</span><span class="o">.</span><span class="n">isnull</span><span class="p">())]</span>
                <span class="k">if</span> <span class="n">ptable_grism_filter</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">XREF</span> <span class="o">=</span> <span class="n">ptable_grism_filter</span><span class="o">.</span><span class="n">XREF</span><span class="o">.</span><span class="n">values</span>
                    <span class="n">YREF</span> <span class="o">=</span> <span class="n">ptable_grism_filter</span><span class="o">.</span><span class="n">YREF</span><span class="o">.</span><span class="n">values</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Filter or Aperture not found in, </span><span class="se">\</span>
<span class="s2">                     reference pixel calibration file, Aborting&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">XREF</span><span class="p">,</span> <span class="n">YREF</span>

    <span class="k">def</span> <span class="nf">_get_subarray_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calibration_data</span><span class="p">,</span> <span class="n">spectral_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nintegrations</span><span class="p">,</span> <span class="n">nspatial</span><span class="p">,</span> <span class="n">nwavelength</span> <span class="o">=</span> <span class="n">spectral_data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">nintegrations_cal</span><span class="p">,</span> <span class="n">npix_y_cal</span><span class="p">,</span> <span class="n">npix_x_cal</span> <span class="o">=</span> <span class="n">calibration_data</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">subarray_sizes</span> <span class="o">=</span> \
            <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="n">cal_image_size</span><span class="o">=</span><span class="n">npix_x_cal</span><span class="p">,</span>
                                    <span class="n">science_image_size</span><span class="o">=</span><span class="n">nwavelength</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">subarray_sizes</span> <span class="o">=</span> <span class="n">subarray_sizes</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_get_wavelength_calibration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the wavelength calibration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Necessary calibration data not yet defined. </span><span class="se">\</span>
<span class="s2">                                 Aborting wavelength to pixel assignment&quot;</span><span class="p">)</span>

        <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">calibration_source_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">DYDX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">DYDX</span>
        <span class="n">DLDP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">DLDP</span>
        <span class="n">reference_pixels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">reference_pixels</span>
        <span class="n">subarray_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">subarray_sizes</span>

        <span class="n">wave_cal</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_WFC3Dispersion</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">DYDX</span><span class="p">,</span> <span class="n">DLDP</span><span class="p">,</span>
                                 <span class="n">xref</span><span class="o">=</span><span class="n">reference_pixels</span><span class="p">[</span><span class="s2">&quot;XREF_IMAGE&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="n">yref</span><span class="o">=</span><span class="n">reference_pixels</span><span class="p">[</span><span class="s2">&quot;YREF_IMAGE&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="n">xref_grism</span><span class="o">=</span><span class="n">reference_pixels</span><span class="p">[</span><span class="s2">&quot;XREF_GRISM&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="n">yref_grism</span><span class="o">=</span><span class="n">reference_pixels</span><span class="p">[</span><span class="s2">&quot;YREF_GRISM&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="n">subarray</span><span class="o">=</span><span class="n">subarray_sizes</span><span class="p">[</span><span class="s1">&#39;cal_image_size&#39;</span><span class="p">],</span>
                                 <span class="n">subarray_grism</span><span class="o">=</span><span class="n">subarray_sizes</span><span class="p">[</span><span class="s1">&#39;science_image_size&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">wave_cal</span>

<div class="viewcode-block" id="HSTWFC3.get_spectral_trace"><a class="viewcode-back" href="../../../cascade.instruments.html#cascade.instruments.instruments.HSTWFC3.get_spectral_trace">[docs]</a>    <span class="k">def</span> <span class="nf">get_spectral_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get spectral trace</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
<span class="c1">#        wavelength_unit = self.data.wavelength_unit</span>

        <span class="n">wave_pixel_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;obs_data&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SPECTRUM&#39;</span><span class="p">:</span>
            <span class="n">position_pixel_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">wave_pixel_grid</span><span class="p">)</span>
            <span class="n">spectral_trace</span> <span class="o">=</span> \
                <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="n">wavelength_pixel</span><span class="o">=</span><span class="n">wave_pixel_grid</span><span class="p">,</span>
                                        <span class="n">positional_pixel</span><span class="o">=</span><span class="n">position_pixel_grid</span><span class="p">,</span>
                                        <span class="n">wavelength</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">wavelength</span><span class="o">.</span>
                                        <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">spectral_trace</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Necessary calibration data not yet defined. </span><span class="se">\</span>
<span class="s2">                                 Aborting trace determination&quot;</span><span class="p">)</span>

        <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">calibration_source_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">DYDX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">DYDX</span>
        <span class="n">DLDP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">DLDP</span>
        <span class="n">reference_pixels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">reference_pixels</span>
        <span class="n">subarray_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfc3_cal</span><span class="o">.</span><span class="n">subarray_sizes</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_WFC3Trace</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">DYDX</span><span class="p">,</span>
                                <span class="n">xref</span><span class="o">=</span><span class="n">reference_pixels</span><span class="p">[</span><span class="s2">&quot;XREF_IMAGE&quot;</span><span class="p">],</span>
                                <span class="n">yref</span><span class="o">=</span><span class="n">reference_pixels</span><span class="p">[</span><span class="s2">&quot;YREF_IMAGE&quot;</span><span class="p">],</span>
                                <span class="n">xref_grism</span><span class="o">=</span><span class="n">reference_pixels</span><span class="p">[</span><span class="s2">&quot;XREF_GRISM&quot;</span><span class="p">],</span>
                                <span class="n">yref_grism</span><span class="o">=</span><span class="n">reference_pixels</span><span class="p">[</span><span class="s2">&quot;YREF_GRISM&quot;</span><span class="p">],</span>
                                <span class="n">subarray</span><span class="o">=</span><span class="n">subarray_sizes</span><span class="p">[</span><span class="s1">&#39;cal_image_size&#39;</span><span class="p">],</span>
                                <span class="n">subarray_grism</span><span class="o">=</span><span class="n">subarray_sizes</span><span class="p">[</span><span class="s1">&#39;science_image_size&#39;</span><span class="p">])</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">trace</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span>

        <span class="n">wavelength</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_WFC3Dispersion</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">DYDX</span><span class="p">,</span> <span class="n">DLDP</span><span class="p">,</span>
                                 <span class="n">xref</span><span class="o">=</span><span class="n">reference_pixels</span><span class="p">[</span><span class="s2">&quot;XREF_IMAGE&quot;</span><span class="p">],</span>
                                 <span class="n">yref</span><span class="o">=</span><span class="n">reference_pixels</span><span class="p">[</span><span class="s2">&quot;YREF_IMAGE&quot;</span><span class="p">],</span>
                                 <span class="n">xref_grism</span><span class="o">=</span><span class="n">reference_pixels</span><span class="p">[</span><span class="s2">&quot;XREF_GRISM&quot;</span><span class="p">],</span>
                                 <span class="n">yref_grism</span><span class="o">=</span><span class="n">reference_pixels</span><span class="p">[</span><span class="s2">&quot;YREF_GRISM&quot;</span><span class="p">],</span>
                                 <span class="n">subarray</span><span class="o">=</span><span class="n">subarray_sizes</span><span class="p">[</span><span class="s1">&#39;cal_image_size&#39;</span><span class="p">],</span>
                                 <span class="n">subarray_grism</span><span class="o">=</span><span class="n">subarray_sizes</span><span class="p">[</span><span class="s1">&#39;science_image_size&#39;</span><span class="p">])</span>

        <span class="n">spectral_trace</span> <span class="o">=</span> \
            <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="n">wavelength_pixel</span><span class="o">=</span><span class="n">wave_pixel_grid</span><span class="p">,</span>
                                    <span class="n">positional_pixel</span><span class="o">=</span><span class="n">trace</span><span class="p">,</span>
                                    <span class="n">wavelength</span><span class="o">=</span><span class="n">wavelength</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">spectral_trace</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_WFC3Trace</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">DYDX</span><span class="p">,</span> <span class="n">xref</span><span class="o">=</span><span class="mi">522</span><span class="p">,</span> <span class="n">yref</span><span class="o">=</span><span class="mi">522</span><span class="p">,</span> <span class="n">xref_grism</span><span class="o">=</span><span class="mi">522</span><span class="p">,</span>
                   <span class="n">yref_grism</span><span class="o">=</span><span class="mi">522</span><span class="p">,</span> <span class="n">subarray</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">subarray_grism</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function defines the spectral trace for the wfc3 grism modes.</span>
<span class="sd">        Details can be found in:</span>
<span class="sd">           http://www.stsci.edu/hst/wfc3/documents/ISRs/WFC3-2016-15.pdf</span>
<span class="sd">        and</span>
<span class="sd">           http://www.stsci.edu/hst/observatory/apertures/wfc3.html</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># adjust position in case different subarrays are used.</span>
        <span class="n">xc</span> <span class="o">=</span> <span class="n">xc</span> <span class="o">-</span> <span class="p">(</span><span class="n">xref</span> <span class="o">-</span> <span class="n">xref_grism</span><span class="p">)</span>
        <span class="n">yc</span> <span class="o">=</span> <span class="n">yc</span> <span class="o">-</span> <span class="p">(</span><span class="n">yref</span> <span class="o">-</span> <span class="n">yref_grism</span><span class="p">)</span>

        <span class="n">coord0</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1014</span> <span class="o">-</span> <span class="n">subarray</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">xc</span> <span class="o">=</span> <span class="n">xc</span> <span class="o">+</span> <span class="n">coord0</span>
        <span class="n">yc</span> <span class="o">=</span> <span class="n">yc</span> <span class="o">+</span> <span class="n">coord0</span>

        <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1014</span><span class="p">)</span> <span class="o">-</span> <span class="n">xc</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">DYDX</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">DYDX</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">xc</span> <span class="o">+</span> <span class="n">DYDX</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">yc</span> <span class="o">+</span>
                           <span class="n">DYDX</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">xc</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">DYDX</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">xc</span> <span class="o">*</span> <span class="n">yc</span> <span class="o">+</span>
                           <span class="n">DYDX</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">yc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                    <span class="p">)</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">M</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="n">DYDX</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">DYDX</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">xc</span> <span class="o">+</span> <span class="n">DYDX</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">yc</span> <span class="o">+</span>
                 <span class="n">DYDX</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">xc</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">DYDX</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">xc</span><span class="o">*</span><span class="n">yc</span> <span class="o">+</span> <span class="n">DYDX</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">yc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> \
            <span class="n">dp</span> <span class="o">*</span> <span class="p">(</span><span class="n">DYDX</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">DYDX</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">xc</span> <span class="o">+</span> <span class="n">DYDX</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">yc</span> <span class="o">+</span>
                  <span class="n">DYDX</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">xc</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">DYDX</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">xc</span><span class="o">*</span><span class="n">yc</span> <span class="o">+</span> <span class="n">DYDX</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">yc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">M</span>
        <span class="k">if</span> <span class="n">subarray</span> <span class="o">&lt;</span> <span class="mi">1014</span><span class="p">:</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1014</span> <span class="o">-</span> <span class="n">subarray</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">trace</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span> <span class="n">i0</span> <span class="o">+</span> <span class="n">subarray</span><span class="p">]</span>

        <span class="n">idx_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">subarray</span><span class="o">-</span><span class="n">subarray_grism</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">idx_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">subarray</span><span class="o">-</span><span class="n">subarray_grism</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="n">subarray_grism</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">trace</span><span class="p">[</span><span class="n">idx_min</span><span class="p">:</span><span class="n">idx_max</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">trace</span> <span class="o">+</span> <span class="n">yc</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1014</span> <span class="o">-</span> <span class="n">subarray_grism</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_WFC3Dispersion</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">DYDX</span><span class="p">,</span> <span class="n">DLDP</span><span class="p">,</span> <span class="n">xref</span><span class="o">=</span><span class="mi">522</span><span class="p">,</span> <span class="n">yref</span><span class="o">=</span><span class="mi">522</span><span class="p">,</span>
                        <span class="n">xref_grism</span><span class="o">=</span><span class="mi">522</span><span class="p">,</span> <span class="n">yref_grism</span><span class="o">=</span><span class="mi">522</span><span class="p">,</span> <span class="n">subarray</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
                        <span class="n">subarray_grism</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert pixel coordinate to wavelength. Method and coefficient</span>
<span class="sd">        adopted from Kuntschner et al. (2009), Wilkins et al. (2014). See also</span>
<span class="sd">        http://www.stsci.edu/hst/wfc3/documents/ISRs/WFC3-2016-15.pdf</span>

<span class="sd">        In case the direct image and spectral image are not taken with the</span>
<span class="sd">        same aperture, the centroid measurement is adjusted according to the</span>
<span class="sd">        table in: http://www.stsci.edu/hst/observatory/apertures/wfc3.html</span>

<span class="sd">        Input:</span>
<span class="sd">        ------</span>
<span class="sd">            xc:</span>
<span class="sd">                X coordinate of direct image centroid</span>
<span class="sd">            yc:</span>
<span class="sd">                Y coordinate of direct image centroid</span>
<span class="sd">        xref</span>
<span class="sd">        yref</span>
<span class="sd">        xref_grism</span>
<span class="sd">        yref_grism</span>
<span class="sd">        subarray</span>
<span class="sd">        subarray_grism</span>

<span class="sd">        Output:</span>
<span class="sd">        -------</span>
<span class="sd">            wavelength:</span>
<span class="sd">                return wavelength mapping of x coordinate in micron</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># adjust position in case different subarrays are used.</span>
        <span class="n">xc</span> <span class="o">=</span> <span class="n">xc</span> <span class="o">-</span> <span class="p">(</span><span class="n">xref</span> <span class="o">-</span> <span class="n">xref_grism</span><span class="p">)</span>
        <span class="n">yc</span> <span class="o">=</span> <span class="n">yc</span> <span class="o">-</span> <span class="p">(</span><span class="n">yref</span> <span class="o">-</span> <span class="n">yref_grism</span><span class="p">)</span>

        <span class="n">coord0</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1014</span> <span class="o">-</span> <span class="n">subarray</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">xc</span> <span class="o">=</span> <span class="n">xc</span> <span class="o">+</span> <span class="n">coord0</span>
        <span class="n">yc</span> <span class="o">=</span> <span class="n">yc</span> <span class="o">+</span> <span class="n">coord0</span>

        <span class="c1"># calculate field dependent dispersion coefficient</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="p">(</span><span class="n">DLDP</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">DLDP</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">xc</span> <span class="o">+</span> <span class="n">DLDP</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">yc</span> <span class="o">+</span>
              <span class="n">DLDP</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">xc</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">DLDP</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">xc</span><span class="o">*</span><span class="n">yc</span> <span class="o">+</span> <span class="n">DLDP</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">yc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="p">(</span><span class="n">DLDP</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">DLDP</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">xc</span> <span class="o">+</span> <span class="n">DLDP</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">yc</span> <span class="o">+</span>
              <span class="n">DLDP</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">xc</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">DLDP</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">xc</span><span class="o">*</span><span class="n">yc</span> <span class="o">+</span> <span class="n">DLDP</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">yc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1014</span><span class="p">)</span> <span class="o">-</span> <span class="n">xc</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">DYDX</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">DYDX</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">xc</span> <span class="o">+</span> <span class="n">DYDX</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">yc</span> <span class="o">+</span>
                           <span class="n">DYDX</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">xc</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">DYDX</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">xc</span><span class="o">*</span><span class="n">yc</span> <span class="o">+</span>
                           <span class="n">DYDX</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">yc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                    <span class="p">)</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">M</span>

        <span class="n">wavelength</span> <span class="o">=</span> <span class="p">(</span><span class="n">p0</span> <span class="o">+</span> <span class="n">dp</span> <span class="o">*</span> <span class="n">p1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">subarray</span> <span class="o">&lt;</span> <span class="mi">1014</span><span class="p">:</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1014</span> <span class="o">-</span> <span class="n">subarray</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">wavelength</span> <span class="o">=</span> <span class="n">wavelength</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span> <span class="n">i0</span> <span class="o">+</span> <span class="n">subarray</span><span class="p">]</span>

        <span class="n">idx_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">subarray</span><span class="o">-</span><span class="n">subarray_grism</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">idx_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">subarray</span><span class="o">-</span><span class="n">subarray_grism</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="n">subarray_grism</span>
        <span class="n">wavelength</span> <span class="o">=</span> <span class="n">wavelength</span><span class="p">[</span><span class="n">idx_min</span><span class="p">:</span><span class="n">idx_max</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Angstrom</span>
        <span class="k">return</span> <span class="n">wavelength</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">micron</span><span class="p">)</span></div>


<div class="viewcode-block" id="Spitzer"><a class="viewcode-back" href="../../../cascade.instruments.html#cascade.instruments.instruments.Spitzer">[docs]</a><span class="k">class</span> <span class="nc">Spitzer</span><span class="p">(</span><span class="n">ObservatoryBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This observatory class defines the instuments and data handling for the</span>
<span class="sd">    spectropgraphs of the Spitzer Space telescope</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># check if cascade is initialized</span>
        <span class="k">if</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">isInitialized</span><span class="p">:</span>
            <span class="c1"># check if model is implemented and pick model</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cascade_configuration</span><span class="o">.</span><span class="n">instrument</span> <span class="ow">in</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">observatory_instruments</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">instrument</span> <span class="o">==</span> <span class="s1">&#39;IRS&#39;</span><span class="p">:</span>
                    <span class="n">factory</span> <span class="o">=</span> <span class="n">SpitzerIRS</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">par</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">par</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">data</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spectral_trace</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">spectral_trace</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_has_backgr&#39;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data_background</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">data_background</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">name</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">instrument_calibration</span> <span class="o">=</span> \
                        <span class="n">factory</span><span class="o">.</span><span class="n">instrument_calibration</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Spitzer instrument not recognized, </span><span class="se">\</span>
<span class="s2">                                 check your init file for the following </span><span class="se">\</span>
<span class="s2">                                 valid instruments: </span><span class="si">{}</span><span class="s2">. Aborting loading </span><span class="se">\</span>
<span class="s2">                                 instrument&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_instruments</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CASCADe not initialized, </span><span class="se">\</span>
<span class="s2">                                 aborting loading Observatory&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;SPITZER&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">location</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;SPACE&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">NAIF_ID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">79</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">observatory_instruments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span><span class="p">{</span><span class="s2">&quot;IRS&quot;</span><span class="p">}</span></div>


<div class="viewcode-block" id="SpitzerIRS"><a class="viewcode-back" href="../../../cascade.instruments.html#cascade.instruments.instruments.SpitzerIRS">[docs]</a><span class="k">class</span> <span class="nc">SpitzerIRS</span><span class="p">(</span><span class="n">InstrumentBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This instrument class defines the properties of the IRS instrument of</span>
<span class="sd">    the Spitzer Space Telescope</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__valid_arrays</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SL&#39;</span><span class="p">,</span> <span class="s1">&#39;LL&#39;</span><span class="p">}</span>
    <span class="n">__valid_orders</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">}</span>
    <span class="n">__valid_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SPECTRUM&#39;</span><span class="p">,</span> <span class="s1">&#39;SPECTRAL_IMAGE&#39;</span><span class="p">,</span> <span class="s1">&#39;SPECTRAL_DETECTOR_CUBE&#39;</span><span class="p">}</span>
    <span class="n">__valid_observing_strategy</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;STARING&#39;</span><span class="p">,</span> <span class="s1">&#39;NODDED&#39;</span><span class="p">}</span>
    <span class="n">__valid_data_products</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;droop&#39;</span><span class="p">,</span> <span class="s1">&#39;COE&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instrument_setup</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_has_backgr&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_background</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectral_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectral_trace</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_define_region_of_interest</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instrument_calibration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IRS_cal</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instrument_calibration</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;IRS&quot;</span>

<div class="viewcode-block" id="SpitzerIRS.load_data"><a class="viewcode-back" href="../../../cascade.instruments.html#cascade.instruments.instruments.SpitzerIRS.load_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;obs_data&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SPECTRUM&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectra</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_has_backgr&#39;</span><span class="p">]:</span>
                <span class="n">data_back</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectra</span><span class="p">(</span><span class="n">is_background</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;obs_data&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SPECTRAL_IMAGE&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectral_images</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_has_backgr&#39;</span><span class="p">]:</span>
                <span class="n">data_back</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectral_images</span><span class="p">(</span><span class="n">is_background</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;obs_data&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SPECTRAL_DETECTOR_CUBE&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_detector_cubes</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_has_backgr&#39;</span><span class="p">]:</span>
                <span class="n">data_back</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_detector_cubes</span><span class="p">(</span><span class="n">is_background</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_has_backgr&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_back</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="SpitzerIRS.get_instrument_setup"><a class="viewcode-back" href="../../../cascade.instruments.html#cascade.instruments.instruments.SpitzerIRS.get_instrument_setup">[docs]</a>    <span class="k">def</span> <span class="nf">get_instrument_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve all relevant parameters defining the instrument and data setup</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inst_inst_name</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">instrument</span>
        <span class="n">inst_mode</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">instrument_mode</span>
        <span class="n">inst_order</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">instrument_order</span>
        <span class="n">obj_period</span> <span class="o">=</span> \
            <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">cascade_configuration</span><span class="o">.</span><span class="n">object_period</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
        <span class="n">obj_period</span> <span class="o">=</span> <span class="n">obj_period</span><span class="o">.</span><span class="n">value</span>
        <span class="n">obj_ephemeris</span> <span class="o">=</span> \
            <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">cascade_configuration</span><span class="o">.</span><span class="n">object_ephemeris</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
        <span class="n">obj_ephemeris</span> <span class="o">=</span> <span class="n">obj_ephemeris</span><span class="o">.</span><span class="n">value</span>
        <span class="n">obs_mode</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">observations_mode</span>
        <span class="n">obs_data</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">observations_data</span>
        <span class="n">obs_path</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">observations_path</span>
        <span class="n">obs_cal_path</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">observations_cal_path</span>
        <span class="n">obs_cal_version</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">observations_cal_version</span>
        <span class="n">obs_data_product</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">observations_data_product</span>
        <span class="n">obs_id</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">observations_id</span>
        <span class="n">obs_target_name</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">observations_target_name</span>
        <span class="n">obs_has_backgr</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">cascade_configuration</span><span class="o">.</span>
                                          <span class="n">observations_has_background</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obs_has_backgr</span><span class="p">:</span>
            <span class="n">obs_backgr_id</span> <span class="o">=</span> <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">observations_background_id</span>
            <span class="n">obs_backgr_target_name</span> <span class="o">=</span> \
                <span class="n">cascade_configuration</span><span class="o">.</span><span class="n">observations_background_name</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">obs_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_data</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data type not recognized, </span><span class="se">\</span>
<span class="s2">                     check your init file for the following </span><span class="se">\</span>
<span class="s2">                     valid types: </span><span class="si">{}</span><span class="s2">. </span><span class="se">\</span>
<span class="s2">                     Aborting loading data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__valid_data</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">obs_mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_observing_strategy</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Observational stategy not recognized, </span><span class="se">\</span>
<span class="s2">                     check your init file for the following </span><span class="se">\</span>
<span class="s2">                     valid types: </span><span class="si">{}</span><span class="s2">. </span><span class="se">\</span>
<span class="s2">                     Aborting loading data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__valid_data</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inst_mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_arrays</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Instrument mode not recognized, </span><span class="se">\</span>
<span class="s2">                     check your init file for the following </span><span class="se">\</span>
<span class="s2">                     valid types: </span><span class="si">{}</span><span class="s2">. </span><span class="se">\</span>
<span class="s2">                     Aborting loading data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__valid_arrays</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inst_order</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_orders</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Spectral order not recognized, </span><span class="se">\</span>
<span class="s2">                     check your init file for the following </span><span class="se">\</span>
<span class="s2">                     valid types: </span><span class="si">{}</span><span class="s2">. </span><span class="se">\</span>
<span class="s2">                     Aborting loading data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__valid_orders</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">obs_data_product</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_data_products</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data product not recognized, </span><span class="se">\</span>
<span class="s2">                     check your init file for the following </span><span class="se">\</span>
<span class="s2">                     valid types: </span><span class="si">{}</span><span class="s2">. Aborting loading </span><span class="se">\</span>
<span class="s2">                     data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__valid_data_products</span><span class="p">))</span>
        <span class="n">par</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="n">inst_inst_name</span><span class="o">=</span><span class="n">inst_inst_name</span><span class="p">,</span>
                                      <span class="n">inst_mode</span><span class="o">=</span><span class="n">inst_mode</span><span class="p">,</span>
                                      <span class="n">inst_order</span><span class="o">=</span><span class="n">inst_order</span><span class="p">,</span>
                                      <span class="n">obj_period</span><span class="o">=</span><span class="n">obj_period</span><span class="p">,</span>
                                      <span class="n">obj_ephemeris</span><span class="o">=</span><span class="n">obj_ephemeris</span><span class="p">,</span>
                                      <span class="n">obs_mode</span><span class="o">=</span><span class="n">obs_mode</span><span class="p">,</span>
                                      <span class="n">obs_data</span><span class="o">=</span><span class="n">obs_data</span><span class="p">,</span>
                                      <span class="n">obs_path</span><span class="o">=</span><span class="n">obs_path</span><span class="p">,</span>
                                      <span class="n">obs_cal_path</span><span class="o">=</span><span class="n">obs_cal_path</span><span class="p">,</span>
                                      <span class="n">obs_data_product</span><span class="o">=</span><span class="n">obs_data_product</span><span class="p">,</span>
                                      <span class="n">obs_cal_version</span><span class="o">=</span><span class="n">obs_cal_version</span><span class="p">,</span>
                                      <span class="n">obs_id</span><span class="o">=</span><span class="n">obs_id</span><span class="p">,</span>
                                      <span class="n">obs_target_name</span><span class="o">=</span><span class="n">obs_target_name</span><span class="p">,</span>
                                      <span class="n">obs_has_backgr</span><span class="o">=</span><span class="n">obs_has_backgr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obs_has_backgr</span><span class="p">:</span>
            <span class="n">par</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;obs_backgr_id&#39;</span><span class="p">:</span> <span class="n">obs_backgr_id</span><span class="p">})</span>
            <span class="n">par</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;obs_backgr_target_name&#39;</span><span class="p">:</span> <span class="n">obs_backgr_target_name</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">par</span></div>

<div class="viewcode-block" id="SpitzerIRS.get_spectra"><a class="viewcode-back" href="../../../cascade.instruments.html#cascade.instruments.instruments.SpitzerIRS.get_spectra">[docs]</a>    <span class="k">def</span> <span class="nf">get_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_background</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        read uncalibrated spectral timeseries, phase and wavelength</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get data files</span>
        <span class="k">if</span> <span class="n">is_background</span><span class="p">:</span>
            <span class="c1"># obsid = self.par[&#39;obs_backgr_id&#39;]</span>
            <span class="n">target_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_backgr_target_name&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># obsid = self.par[&#39;obs_id&#39;]</span>
            <span class="n">target_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_target_name&#39;</span><span class="p">]</span>

        <span class="n">path_to_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_path&#39;</span><span class="p">]</span> <span class="o">+</span> \
            <span class="n">target_name</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_cal_version&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_mode&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_order&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
        <span class="n">data_files</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_mode&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_order&#39;</span><span class="p">]</span> <span class="o">+</span>
                          <span class="s1">&#39;*cycle*.fits&#39;</span><span class="p">,</span> <span class="n">path_to_files</span><span class="p">)</span>

        <span class="c1"># number of integrations</span>
        <span class="n">nintegrations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_files</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nintegrations</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;No Timeseries data found in dir &quot;</span> <span class="o">+</span>
                                 <span class="n">path_to_files</span><span class="p">)</span>

        <span class="c1"># read in the first image and get information on the observations</span>
        <span class="c1"># get the size of the spectral images</span>
        <span class="n">image_file</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">spectral_image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">npix</span><span class="p">,</span> <span class="n">mpix</span> <span class="o">=</span> <span class="n">spectral_image</span><span class="o">.</span><span class="n">shape</span>
        <span class="c1"># get frametime from fits header (duration of ramp in sec)</span>
        <span class="n">framtime</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="s2">&quot;FRAMTIME&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># get the FOVID from the header and check for nodded observations</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fovid</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="s2">&quot;FOVID&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FOVID not set in fits files&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using &#39;observations_mode&#39; parameter instead&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;STARING&quot;</span><span class="p">:</span>
                <span class="n">fovid</span> <span class="o">=</span> <span class="mi">28</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fovid</span> <span class="o">=</span> <span class="mi">26</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fovid</span> <span class="o">!=</span> <span class="mi">28</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fovid</span> <span class="o">!=</span> <span class="mi">34</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fovid</span> <span class="o">!=</span> <span class="mi">40</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fovid</span> <span class="o">!=</span> <span class="mi">46</span><span class="p">):</span>
            <span class="n">isNodded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">isNodded</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># get the unit of the spectral images</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flux_unit_string</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="s2">&quot;BUNIT&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">flux_unit_string</span> <span class="o">=</span> <span class="n">flux_unit_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;e-&quot;</span><span class="p">,</span> <span class="s2">&quot;electron&quot;</span><span class="p">)</span>
            <span class="n">flux_unit_string</span> <span class="o">=</span> <span class="n">flux_unit_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;sec&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span>
            <span class="n">flux_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">flux_unit_string</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No flux unit set in fits files&quot;</span><span class="p">)</span>
            <span class="n">flux_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span>

        <span class="c1"># get the spectra</span>
        <span class="n">path_to_spectra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_path&#39;</span><span class="p">]</span> <span class="o">+</span> \
            <span class="n">target_name</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_cal_version&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_mode&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_order&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
        <span class="n">spectral_file</span> <span class="o">=</span> <span class="n">target_name</span><span class="o">+</span><span class="s1">&#39;_no_fluxcal_droop_&#39;</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_mode&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_order&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.yaar&#39;</span>
        <span class="n">spectral_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">path_to_spectra</span><span class="o">+</span><span class="n">spectral_file</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">spectral_data</span><span class="p">[</span><span class="s1">&#39;FLUX&#39;</span><span class="p">]</span>
        <span class="n">nwave</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="n">nintegrations</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">nwave</span><span class="p">,</span> <span class="n">nintegrations</span><span class="p">))</span> <span class="o">*</span> <span class="n">flux_unit</span>
        <span class="n">wave_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;um&#39;</span><span class="p">)</span>
        <span class="n">wavelength</span> <span class="o">=</span> <span class="n">spectral_data</span><span class="p">[</span><span class="s1">&#39;WAVE&#39;</span><span class="p">]</span>
        <span class="n">wavelength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="p">(</span><span class="n">nwave</span><span class="p">,</span> <span class="n">nintegrations</span><span class="p">))</span> <span class="o">*</span> <span class="n">wave_unit</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">make_mask_none</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># get the spectral images to get the timing and positional info</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nintegrations</span><span class="p">))</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nintegrations</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_order&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
            <span class="n">position_keyword</span> <span class="o">=</span> <span class="s2">&quot;S_O1P1A&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">position_keyword</span> <span class="o">=</span> <span class="s2">&quot;S_O2P1A&quot;</span>
        <span class="k">for</span> <span class="n">im</span><span class="p">,</span> <span class="n">image_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_files</span><span class="p">):</span>
            <span class="c1"># WARNING fits data is single precision!!</span>
            <span class="n">time</span><span class="p">[</span><span class="n">im</span><span class="p">]</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="s2">&quot;BMJD_OBS&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">position_string</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="n">position_keyword</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">position</span><span class="p">[</span><span class="n">im</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">position_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># The time in the spitzer fits header is -2400000.5 and</span>
        <span class="c1"># it is the time at the start of the ramp</span>
        <span class="c1"># As we are using fitted ramps,</span>
        <span class="c1"># shift time by half ramp of length framtime</span>
        <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span> <span class="o">+</span> <span class="mf">2400000.5</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.50</span><span class="o">*</span><span class="n">framtime</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">24.0</span><span class="o">*</span><span class="mf">3600.0</span><span class="p">)</span>  <span class="c1"># in days</span>
        <span class="c1"># orbital phase</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obj_ephemeris&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obj_period&#39;</span><span class="p">]</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">phase</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">+</span> <span class="mf">1.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_define_convolution_kernel</span><span class="p">()</span>

        <span class="c1"># ROI</span>
        <span class="c1">#self._define_region_of_interest(data)</span>

        <span class="n">SpectralTimeSeries</span> <span class="o">=</span> <span class="n">SpectralDataTimeSeries</span><span class="p">(</span><span class="n">wavelength</span><span class="o">=</span><span class="n">wavelength</span><span class="p">,</span>
                                                    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">phase</span><span class="p">,</span>
                                                    <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                                                    <span class="n">uncertainty</span><span class="o">=</span><span class="n">uncertainty</span><span class="p">,</span>
                                                    <span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">,</span>
                                                    <span class="n">time_bjd</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
                                                    <span class="n">isRampFitted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                    <span class="n">isNodded</span><span class="o">=</span><span class="n">isNodded</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SpectralTimeSeries</span></div>

<div class="viewcode-block" id="SpitzerIRS.get_spectral_images"><a class="viewcode-back" href="../../../cascade.instruments.html#cascade.instruments.instruments.SpitzerIRS.get_spectral_images">[docs]</a>    <span class="k">def</span> <span class="nf">get_spectral_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_background</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        read uncalibrated spectral images</span>

<span class="sd">        Notes on FOV:</span>

<span class="sd">        # in the fits header the following relevant info is used:</span>
<span class="sd">        # FOVID     26     IRS_Short-Lo_1st_Order_1st_Position</span>
<span class="sd">        # FOVID     27     IRS_Short-Lo_1st_Order_2nd_Position</span>
<span class="sd">        # FOVID     28     IRS_Short-Lo_1st_Order_Center_Position</span>
<span class="sd">        # FOVID     29     IRS_Short-Lo_Module_Center</span>
<span class="sd">        # FOVID     32     IRS_Short-Lo_2nd_Order_1st_Position</span>
<span class="sd">        # FOVID     33     IRS_Short-Lo_2nd_Order_2nd_Position</span>
<span class="sd">        # FOVID     34     IRS_Short-Lo_2nd_Order_Center_Position</span>
<span class="sd">        # FOVID     40     IRS_Long-Lo_1st_Order_Center_Position</span>
<span class="sd">        # FOVID     46     IRS_Long-Lo_2nd_Order_Center_Position</span>

<span class="sd">        Notes on timing:</span>

<span class="sd">        # FRAMTIME the total effective exposure time (ramp length) in seconds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># order mask</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_order_mask</span><span class="p">()</span>

        <span class="c1"># wavelength calibration</span>
        <span class="n">wave_cal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_wavelength_calibration</span><span class="p">()</span>

        <span class="c1"># get data files</span>
        <span class="k">if</span> <span class="n">is_background</span><span class="p">:</span>
            <span class="n">obsid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_backgr_id&#39;</span><span class="p">]</span>
            <span class="n">target_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_backgr_target_name&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obsid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_id&#39;</span><span class="p">]</span>
            <span class="n">target_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_target_name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SL&#39;</span><span class="p">:</span>
            <span class="n">path_to_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_path&#39;</span><span class="p">]</span> <span class="o">+</span> \
                <span class="n">target_name</span> <span class="o">+</span> <span class="s1">&#39;/IRSX/&#39;</span> <span class="o">+</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_cal_version&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/bcd/ch0/&#39;</span>
            <span class="n">data_files</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="s1">&#39;SPITZER_S0*&#39;</span><span class="o">+</span><span class="n">obsid</span> <span class="o">+</span>
                              <span class="s1">&#39;*droop.fits&#39;</span><span class="p">,</span> <span class="n">path_to_files</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path_to_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_path&#39;</span><span class="p">]</span> <span class="o">+</span> \
                <span class="n">target_name</span> <span class="o">+</span> <span class="s1">&#39;/IRSX/&#39;</span> <span class="o">+</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_cal_version&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/bcd/ch2/&#39;</span>
            <span class="n">data_files</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="s1">&#39;SPITZER_S2*&#39;</span><span class="o">+</span><span class="n">obsid</span> <span class="o">+</span>
                              <span class="s1">&#39;*droop.fits&#39;</span><span class="p">,</span> <span class="n">path_to_files</span><span class="p">)</span>

        <span class="c1"># number of integrations</span>
        <span class="n">nintegrations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_files</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nintegrations</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;No Timeseries data found in dir &quot;</span> <span class="o">+</span>
                                 <span class="n">path_to_files</span><span class="p">)</span>

        <span class="c1"># read in the first image and get information on the observations</span>
        <span class="c1"># get the size of the spectral images</span>
        <span class="n">image_file</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">spectral_image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">npix</span><span class="p">,</span> <span class="n">mpix</span> <span class="o">=</span> <span class="n">spectral_image</span><span class="o">.</span><span class="n">shape</span>
        <span class="c1"># get frametime from fits header (duration of ramp in sec)</span>
        <span class="n">framtime</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="s2">&quot;FRAMTIME&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># get the FOVID from the header and check for nodded observations</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fovid</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="s2">&quot;FOVID&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FOVID not set in fits files&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using &#39;observations_mode&#39; parameter instead&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;STARING&quot;</span><span class="p">:</span>
                <span class="n">fovid</span> <span class="o">=</span> <span class="mi">28</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fovid</span> <span class="o">=</span> <span class="mi">26</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fovid</span> <span class="o">!=</span> <span class="mi">28</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fovid</span> <span class="o">!=</span> <span class="mi">34</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fovid</span> <span class="o">!=</span> <span class="mi">40</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fovid</span> <span class="o">!=</span> <span class="mi">46</span><span class="p">):</span>
            <span class="n">isNodded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">isNodded</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># get the unit of the spectral images</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flux_unit_string</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="s2">&quot;BUNIT&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">flux_unit_string</span> <span class="o">=</span> <span class="n">flux_unit_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;e-&quot;</span><span class="p">,</span> <span class="s2">&quot;electron&quot;</span><span class="p">)</span>
            <span class="n">flux_unit_string</span> <span class="o">=</span> <span class="n">flux_unit_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;sec&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span>
            <span class="n">flux_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">flux_unit_string</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No flux unit set in fits files&quot;</span><span class="p">)</span>
            <span class="n">flux_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span>

        <span class="c1"># define mask and fill with data  from order mask</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="p">(</span><span class="n">nintegrations</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># get the data</span>
        <span class="n">image_cube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npix</span><span class="p">,</span> <span class="n">mpix</span><span class="p">,</span> <span class="n">nintegrations</span><span class="p">))</span>
        <span class="n">image_unc_cube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npix</span><span class="p">,</span> <span class="n">mpix</span><span class="p">,</span> <span class="n">nintegrations</span><span class="p">))</span>
        <span class="n">image_dq_cube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npix</span><span class="p">,</span> <span class="n">mpix</span><span class="p">,</span> <span class="n">nintegrations</span><span class="p">))</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nintegrations</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">im</span><span class="p">,</span> <span class="n">image_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">data_files</span><span class="p">,</span> <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
            <span class="c1"># WARNING fits data is single precision!!</span>
            <span class="n">spectral_image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">image_cube</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">im</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectral_image</span>
            <span class="n">time</span><span class="p">[</span><span class="n">im</span><span class="p">]</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="s2">&quot;BMJD_OBS&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">unc_image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">image_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;droop.fits&quot;</span><span class="p">,</span>
                                                        <span class="s2">&quot;drunc.fits&quot;</span><span class="p">),</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">image_unc_cube</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">im</span><span class="p">]</span> <span class="o">=</span> <span class="n">unc_image</span>
            <span class="n">dq_image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">image_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;droop.fits&quot;</span><span class="p">,</span>
                                                       <span class="s2">&quot;bmask.fits&quot;</span><span class="p">),</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">image_dq_cube</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">im</span><span class="p">]</span> <span class="o">=</span> <span class="n">dq_image</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">image_cube</span> <span class="o">*</span> <span class="n">flux_unit</span>
        <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">image_unc_cube</span> <span class="o">*</span> <span class="n">flux_unit</span>
        <span class="n">npix</span><span class="p">,</span> <span class="n">mpix</span><span class="p">,</span> <span class="n">nintegrations</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">mask_dq</span> <span class="o">=</span> <span class="n">image_dq_cube</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;10000000&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask_dq</span><span class="p">)</span>

        <span class="c1"># The time in the spitzer fits header is -2400000.5 and</span>
        <span class="c1"># it is the time at the start of the ramp</span>
        <span class="c1"># As we are using fitted ramps,</span>
        <span class="c1"># shift time by half ramp of length framtime</span>
        <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span> <span class="o">+</span> <span class="mf">2400000.5</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.50</span><span class="o">*</span><span class="n">framtime</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">24.0</span><span class="o">*</span><span class="mf">3600.0</span><span class="p">)</span>  <span class="c1"># in days</span>
        <span class="c1"># orbital phase</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obj_ephemeris&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obj_period&#39;</span><span class="p">]</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">phase</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">+</span> <span class="mf">1.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_define_convolution_kernel</span><span class="p">()</span>

        <span class="c1"># ROI</span>
        <span class="c1">#self._define_region_of_interest(data)</span>

        <span class="n">SpectralTimeSeries</span> <span class="o">=</span> <span class="n">SpectralDataTimeSeries</span><span class="p">(</span><span class="n">wavelength</span><span class="o">=</span><span class="n">wave_cal</span><span class="p">,</span>
                                                    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">phase</span><span class="p">,</span>
                                                    <span class="n">uncertainty</span><span class="o">=</span><span class="n">uncertainty</span><span class="p">,</span>
                                                    <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                                                    <span class="n">time_bjd</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
                                                    <span class="n">isRampFitted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                    <span class="n">isNodded</span><span class="o">=</span><span class="n">isNodded</span><span class="p">,</span>
                                                    <span class="n">dataFiles</span><span class="o">=</span><span class="n">data_files</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SpectralTimeSeries</span></div>

    <span class="k">def</span> <span class="nf">_define_convolution_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define the instrument specific convolution kernel which will be used</span>
<span class="sd">        in the correction procedure of bad pixels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;obs_data&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SPECTRUM&#39;</span><span class="p">:</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="n">Gaussian1DKernel</span><span class="p">(</span><span class="mf">2.2</span><span class="p">,</span> <span class="n">x_size</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="n">Gaussian2DKernel</span><span class="p">(</span><span class="n">x_stddev</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">y_stddev</span><span class="o">=</span><span class="mf">2.2</span><span class="p">,</span> <span class="n">theta</span><span class="o">=-</span><span class="mf">0.076</span><span class="p">,</span>
                                      <span class="n">x_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">y_size</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">IRS_cal</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">IRS_cal</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">IRS_cal</span><span class="o">.</span><span class="n">convolution_kernel</span> <span class="o">=</span> <span class="n">kernel</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_define_region_of_interest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Defines region on detector which containes the intended target star.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
            <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">roi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_order_mask</span><span class="p">()</span>
            <span class="n">selem</span> <span class="o">=</span> <span class="n">square</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="n">dilation</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="n">selem</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">IRS_cal</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">IRS_cal</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">IRS_cal</span><span class="o">.</span><span class="n">roi</span> <span class="o">=</span> <span class="n">roi</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_get_order_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the mask which defines the pixels used with a given spectral order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># order mask</span>
        <span class="n">order_mask_file_name</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_cal_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_cal_version&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/&#39;</span> <span class="o">+</span> \
            <span class="s1">&#39;IRSX_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_mode&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_cal_version&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_cal.omask.fits&#39;</span>
        <span class="n">order_masks</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">order_mask_file_name</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_order&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">order_masks</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">order_masks</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># as there are often problems at the edge of the detector array,</span>
            <span class="c1"># cut first and last row</span>
            <span class="n">row_check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">idx_row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># remove last row</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">idx_row</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">row_check</span><span class="p">)][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># remove first row</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">idx_row</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">row_check</span><span class="p">)][</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_order&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_order&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">):</span>
            <span class="c1"># SL2 or LL2</span>
            <span class="n">mask1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">order_masks</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
            <span class="n">mask1</span><span class="p">[</span><span class="n">order_masks</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># as there are often problems at the edge of the detector array,</span>
            <span class="c1"># cut first and last row</span>
            <span class="n">row_check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">mask1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">idx_row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mask1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># remove last row</span>
            <span class="n">mask1</span><span class="p">[</span><span class="n">idx_row</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">row_check</span><span class="p">)][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># remove first row</span>
            <span class="n">mask1</span><span class="p">[</span><span class="n">idx_row</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">row_check</span><span class="p">)][</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># SL3 or LL3</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">order_masks</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
            <span class="n">mask2</span><span class="p">[</span><span class="n">order_masks</span> <span class="o">==</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># as there are often problems at the edge of the detector array,</span>
            <span class="c1"># cut first and last row</span>
            <span class="n">row_check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">mask2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">idx_row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mask2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># remove last row</span>
            <span class="n">mask2</span><span class="p">[</span><span class="n">idx_row</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">row_check</span><span class="p">)][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># remove first row</span>
            <span class="n">mask2</span><span class="p">[</span><span class="n">idx_row</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">row_check</span><span class="p">)][</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">mask1</span><span class="p">,</span> <span class="n">mask2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mask</span>

    <span class="k">def</span> <span class="nf">_get_wavelength_calibration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get wavelength calibration file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wave_cal_name</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_cal_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_cal_version&#39;</span><span class="p">]</span> <span class="o">+</span> \
            <span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="s1">&#39;IRSX_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_mode&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_cal_version&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_cal.wavsamp_wave.fits&#39;</span>
        <span class="n">wave_cal</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">wave_cal_name</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># units</span>
        <span class="n">wave_unit_string</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">wave_cal_name</span><span class="p">,</span> <span class="s2">&quot;BUNIT&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wave_unit_string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;microns&#39;</span><span class="p">:</span>
            <span class="n">wave_unit_string</span> <span class="o">=</span> <span class="s1">&#39;um&#39;</span>
        <span class="n">wave_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">wave_unit_string</span><span class="p">)</span>
        <span class="n">wave_cal</span> <span class="o">=</span> <span class="n">wave_cal</span> <span class="o">*</span> <span class="n">wave_unit</span>
        <span class="k">return</span> <span class="n">wave_cal</span>

<div class="viewcode-block" id="SpitzerIRS.get_detector_cubes"><a class="viewcode-back" href="../../../cascade.instruments.html#cascade.instruments.instruments.SpitzerIRS.get_detector_cubes">[docs]</a>    <span class="k">def</span> <span class="nf">get_detector_cubes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_background</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get detector cube data</span>

<span class="sd">        Notes on timing in header:</span>

<span class="sd">        There are several integration-time-related keywords.</span>
<span class="sd">        Of greatest interest to the observer is the</span>
<span class="sd">        effective integration time, which is the time on-chip between</span>
<span class="sd">        the first and last non-destructive reads for each pixel. It is called:</span>
<span class="sd">            RAMPTIME = Total integration time for the current DCE.</span>
<span class="sd">        The value of RAMPTIME gives the usable portion of the integration ramp,</span>
<span class="sd">        occurring between the beginning of the first read and the end of the</span>
<span class="sd">        last read. It excludes detector array pre-conditioning time.</span>
<span class="sd">        It may also be of interest to know the exposure time at other points</span>
<span class="sd">        along the ramp. The SUR sequence consists of the time taken at the</span>
<span class="sd">        beginning of a SUR sequence to condition the array</span>
<span class="sd">        (header keyword DEADTIME), the time taken to complete one read and</span>
<span class="sd">        one spin through the array (GRPTIME), and the non-destructive reads</span>
<span class="sd">        separated by uniform wait times. The wait consists of clocking</span>
<span class="sd">        through the array without reading or resetting. The time it takes to</span>
<span class="sd">        clock through the array once is given by the SAMPTIME keyword.</span>
<span class="sd">        So, for an N-read ramp:</span>
<span class="sd">            RAMPTIME = 2x(N-1)xSAMPTIME</span>
<span class="sd">        and</span>
<span class="sd">           DCE duration = DEADTIME + GRPTIME + RAMPTIME</span>
<span class="sd">        Note that peak-up data is not obtained in SUR mode. It is obtained in</span>
<span class="sd">        Double Correlated Sampling (DCS) mode. In that case, RAMPTIME gives the</span>
<span class="sd">        time interval between the 2nd sample and the preceeding reset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># order mask</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_order_mask</span><span class="p">()</span>

        <span class="c1"># wavelength calibration</span>
        <span class="n">wave_cal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_wavelength_calibration</span><span class="p">()</span>

<span class="c1">#        # make list of all spectral images</span>
<span class="c1">#        def find(pattern, path):</span>
<span class="c1">#            result = []</span>
<span class="c1">#            for root, dirs, files in os.walk(path):</span>
<span class="c1">#                for name in files:</span>
<span class="c1">#                    if fnmatch.fnmatch(name, pattern):</span>
<span class="c1">#                        result.append(os.path.join(root, name))</span>
<span class="c1">#            return sorted(result)</span>

        <span class="c1"># get data files</span>
        <span class="k">if</span> <span class="n">is_background</span><span class="p">:</span>
            <span class="n">obsid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_backgr_id&#39;</span><span class="p">]</span>
            <span class="n">target_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_backgr_target_name&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obsid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_id&#39;</span><span class="p">]</span>
            <span class="n">target_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_target_name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SL&#39;</span><span class="p">:</span>
            <span class="n">path_to_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_path&#39;</span><span class="p">]</span> <span class="o">+</span> \
                <span class="n">target_name</span> <span class="o">+</span> <span class="s1">&#39;/IRSX/&#39;</span> <span class="o">+</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_cal_version&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/bcd/ch0/&#39;</span>
            <span class="n">data_files</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="s1">&#39;SPITZER_S0*&#39;</span><span class="o">+</span><span class="n">obsid</span> <span class="o">+</span>
                              <span class="s1">&#39;*lnz.fits&#39;</span><span class="p">,</span> <span class="n">path_to_files</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path_to_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_path&#39;</span><span class="p">]</span> <span class="o">+</span> \
                <span class="n">target_name</span> <span class="o">+</span> <span class="s1">&#39;/IRSX/&#39;</span> <span class="o">+</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_cal_version&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/bcd/ch2/&#39;</span>
            <span class="n">data_files</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="s1">&#39;SPITZER_S2*&#39;</span><span class="o">+</span><span class="n">obsid</span> <span class="o">+</span>
                              <span class="s1">&#39;*lnz.fits&#39;</span><span class="p">,</span> <span class="n">path_to_files</span><span class="p">)</span>

        <span class="c1"># number of integrations</span>
        <span class="n">nintegrations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_files</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nintegrations</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;No Timeseries data found in dir &quot;</span> <span class="o">+</span>
                                 <span class="n">path_to_files</span><span class="p">)</span>

        <span class="c1"># get the size of the spectral images</span>
        <span class="c1"># In the spitzer IRS detector cubes, the first axis is</span>
        <span class="c1"># the number of frames. To get it in the proper data format</span>
        <span class="c1"># we need to move the frames axis to the back.</span>
        <span class="n">image_file</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># WARNING fits data is single precision!!</span>
        <span class="n">spectral_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># wavelength, spatial, frames axis</span>
        <span class="n">npix</span><span class="p">,</span> <span class="n">mpix</span><span class="p">,</span> <span class="n">nframes</span> <span class="o">=</span> <span class="n">spectral_image</span><span class="o">.</span><span class="n">shape</span>
        <span class="c1"># get frametime from fits header (duration of ramp in sec)</span>
        <span class="n">framtime</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="s2">&quot;FRAMTIME&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># get deadtime etc. from fits header</span>
        <span class="c1"># deadtime = fits.getval(image_file, &quot;DEADTIME&quot;, ext=0)</span>
        <span class="n">samptime</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="s2">&quot;SAMPTIME&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># get the FOVID from the header and check for nodded observations</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fovid</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="s2">&quot;FOVID&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FOVID not set in fits files&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using &#39;observations_mode&#39; parameter instead&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;STARING&quot;</span><span class="p">:</span>
                <span class="n">fovid</span> <span class="o">=</span> <span class="mi">28</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fovid</span> <span class="o">=</span> <span class="mi">26</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fovid</span> <span class="o">!=</span> <span class="mi">28</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fovid</span> <span class="o">!=</span> <span class="mi">34</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fovid</span> <span class="o">!=</span> <span class="mi">40</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fovid</span> <span class="o">!=</span> <span class="mi">46</span><span class="p">):</span>
            <span class="n">isNodded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">isNodded</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># get the unit of the spectral images</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flux_unit_string</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="s2">&quot;BUNIT&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">flux_unit_string</span> <span class="o">=</span> <span class="n">flux_unit_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;e-&quot;</span><span class="p">,</span> <span class="s2">&quot;electron&quot;</span><span class="p">)</span>
            <span class="n">flux_unit_string</span> <span class="o">=</span> <span class="n">flux_unit_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;sec&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span>
            <span class="n">flux_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">flux_unit_string</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No flux unit set in fits files&quot;</span><span class="p">)</span>
            <span class="n">flux_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span>

        <span class="c1"># define mask and fill with data  from order mask</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="p">(</span><span class="n">nintegrations</span><span class="p">,</span> <span class="n">nframes</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># get the data</span>
        <span class="c1"># make sure time is last axis</span>
        <span class="n">image_cube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npix</span><span class="p">,</span> <span class="n">mpix</span><span class="p">,</span> <span class="n">nframes</span><span class="p">,</span> <span class="n">nintegrations</span><span class="p">))</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nintegrations</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">im</span><span class="p">,</span> <span class="n">image_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">data_files</span><span class="p">,</span> <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
            <span class="c1"># WARNING fits data is single precision!!</span>
            <span class="n">spectral_image</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">image_cube</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">im</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectral_image</span>
            <span class="n">time</span><span class="p">[</span><span class="n">im</span><span class="p">]</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="s2">&quot;BMJD_OBS&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">image_cube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">image_cube</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">flux_unit</span> <span class="o">=</span> <span class="n">flux_unit</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">samptime</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">image_cube</span> <span class="o">*</span> <span class="n">flux_unit</span>
        <span class="n">npix</span><span class="p">,</span> <span class="n">mpix</span><span class="p">,</span> <span class="n">nframes</span><span class="p">,</span> <span class="n">nintegrations</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># The time in the spitzer fits header is -2400000.5 and</span>
        <span class="c1"># it is the time at the start of the ramp</span>
        <span class="c1"># As we are using fitted ramps,</span>
        <span class="c1"># shift time by half ramp of length framtime</span>
        <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span> <span class="o">+</span> <span class="mf">2400000.5</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.50</span><span class="o">*</span><span class="n">framtime</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">24.0</span><span class="o">*</span><span class="mf">3600.0</span><span class="p">)</span>  <span class="c1"># in days</span>
        <span class="c1"># orbital phase</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obj_ephemeris&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obj_period&#39;</span><span class="p">]</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">phase</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">+</span> <span class="mf">1.0</span>

        <span class="c1"># adjust time stamp for each sample up the ramp</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="p">(</span><span class="n">nframes</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">time_shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nframes</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">samptime</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.50</span><span class="o">*</span><span class="n">framtime</span><span class="p">)</span>
        <span class="n">time_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">time_shift</span><span class="p">,</span> <span class="p">(</span><span class="n">nintegrations</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">time_shift</span> <span class="o">=</span> <span class="n">time_shift</span> <span class="o">/</span> <span class="p">(</span><span class="mf">24.0</span><span class="o">*</span><span class="mf">3600.0</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obj_period&#39;</span><span class="p">]</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">+</span> <span class="n">time_shift</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_define_convolution_kernel</span><span class="p">()</span>

        <span class="c1"># ROI</span>
        <span class="c1">#self._define_region_of_interest(data)</span>

        <span class="n">SpectralTimeSeries</span> <span class="o">=</span> <span class="n">SpectralDataTimeSeries</span><span class="p">(</span><span class="n">wavelength</span><span class="o">=</span><span class="n">wave_cal</span><span class="p">,</span>
                                                    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">phase</span><span class="p">,</span>
                                                    <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                                                    <span class="n">isRampFitted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                    <span class="n">isNodded</span><span class="o">=</span><span class="n">isNodded</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SpectralTimeSeries</span></div>

<div class="viewcode-block" id="SpitzerIRS.get_spectral_trace"><a class="viewcode-back" href="../../../cascade.instruments.html#cascade.instruments.instruments.SpitzerIRS.get_spectral_trace">[docs]</a>    <span class="k">def</span> <span class="nf">get_spectral_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get spectral trace</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">wavelength_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">wavelength_unit</span>

        <span class="n">wave_pixel_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s2">&quot;obs_data&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SPECTRUM&#39;</span><span class="p">:</span>
            <span class="n">position_pixel_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">wave_pixel_grid</span><span class="p">)</span>
            <span class="n">spectral_trace</span> <span class="o">=</span> \
                <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="n">wavelength_pixel</span><span class="o">=</span><span class="n">wave_pixel_grid</span><span class="p">,</span>
                                        <span class="n">positional_pixel</span><span class="o">=</span><span class="n">position_pixel_grid</span><span class="p">,</span>
                                        <span class="n">wavelength</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">wavelength</span><span class="o">.</span>
                                        <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">spectral_trace</span>

        <span class="n">wave_cal_name</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_cal_path&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_cal_version&#39;</span><span class="p">]</span> <span class="o">+</span> \
            <span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="s1">&#39;IRSX_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_mode&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;obs_cal_version&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_cal.wavsamp.tbl&#39;</span>
        <span class="n">wavesamp</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">wave_cal_name</span><span class="p">)</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">wavesamp</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span>
        <span class="n">spatial_pos</span> <span class="o">=</span> <span class="n">wavesamp</span><span class="p">[</span><span class="s1">&#39;x_center&#39;</span><span class="p">]</span>
        <span class="n">wavelength_pos</span> <span class="o">=</span> <span class="n">wavesamp</span><span class="p">[</span><span class="s1">&#39;y_center&#39;</span><span class="p">]</span>
        <span class="n">wavelength</span> <span class="o">=</span> <span class="n">wavesamp</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_order&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">order</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_order&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;inst_order&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">order</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">order</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">spatial_pos</span> <span class="o">=</span> <span class="n">spatial_pos</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">wavelength_pos</span> <span class="o">=</span> <span class="n">wavelength_pos</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">wavelength</span> <span class="o">=</span> <span class="n">wavelength</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">wavelength_pos</span><span class="p">,</span> <span class="n">spatial_pos</span><span class="p">,</span>
                                 <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
        <span class="n">spatial_pos_interpolated</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">wave_pixel_grid</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">wavelength_pos</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span>
                                 <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
        <span class="n">wavelength_interpolated</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">wave_pixel_grid</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span> <span class="n">wavelength_unit</span>

        <span class="n">spectral_trace</span> <span class="o">=</span> \
            <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="n">wavelength_pixel</span><span class="o">=</span><span class="n">wave_pixel_grid</span><span class="p">,</span>
                                    <span class="n">positional_pixel</span><span class="o">=</span><span class="n">spatial_pos_interpolated</span><span class="p">,</span>
                                    <span class="n">wavelength</span><span class="o">=</span><span class="n">wavelength_interpolated</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">spectral_trace</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/Exoplanets-A_Ecusson_Blanc_Alpha.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../../index.html">CASCADe</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cascade.html">Modules of the CASCADe package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../howto.html">Using Cascade</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Jeroen Bouwman.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>