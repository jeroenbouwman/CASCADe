
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>cascade.TSO.TSO &#8212; CASCADe 0.9 beta documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
              <div class="related top">
                &nbsp;
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
              </div>
          

          <div class="body" role="main">
            
  <h1>Source code for cascade.TSO.TSO</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># This file is part of CASCADe package</span>
<span class="c1">#</span>
<span class="c1"># Developed within the ExoplANETS-A H2020 program.</span>
<span class="c1">#</span>
<span class="c1"># See the COPYRIGHT file at the top-level directory of this distribution</span>
<span class="c1"># for details of code ownership.</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The TSO module is the main module of the CASCADe package.</span>
<span class="sd">The classes defined in this module define the time series object and</span>
<span class="sd">all routines acting upon the TSO instance to extract the spectrum of the</span>
<span class="sd">transiting exoplanet.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="k">import</span> <span class="n">SimpleNamespace</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="k">import</span> <span class="n">interpolate_replace_nans</span>
<span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="k">import</span> <span class="n">Gaussian1DKernel</span>
<span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="k">import</span> <span class="n">convolve</span> <span class="k">as</span> <span class="n">ap_convolve</span>
<span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="k">import</span> <span class="n">Kernel</span> <span class="k">as</span> <span class="n">apKernel</span>
<span class="c1"># from skimage.feature import register_translation</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="k">import</span> <span class="n">sigma_clip</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="k">import</span> <span class="n">akaike_info_criterion</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="k">import</span> <span class="n">MaskedColumn</span><span class="p">,</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="k">import</span> <span class="n">quantity_support</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="k">import</span> <span class="n">MaxNLocator</span><span class="p">,</span> <span class="n">ScalarFormatter</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">interpolate</span>
<span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="k">import</span> <span class="n">pinv2</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="k">import</span> <span class="n">binary_dilation</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="k">import</span> <span class="n">RobustScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="k">import</span> <span class="n">PCA</span>

<span class="kn">from</span> <span class="nn">..cpm_model</span> <span class="k">import</span> <span class="n">solve_linear_equation</span>
<span class="kn">from</span> <span class="nn">..data_model</span> <span class="k">import</span> <span class="n">SpectralData</span>
<span class="kn">from</span> <span class="nn">..exoplanet_tools</span> <span class="k">import</span> <span class="p">(</span><span class="n">convert_spectrum_to_brighness_temperature</span><span class="p">,</span>
                               <span class="n">lightcuve</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">..initialize</span> <span class="k">import</span> <span class="p">(</span><span class="n">cascade_configuration</span><span class="p">,</span> <span class="n">configurator</span><span class="p">,</span>
                          <span class="n">default_initialization_path</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">..instruments</span> <span class="k">import</span> <span class="n">Observation</span>
<span class="kn">from</span> <span class="nn">..data_model</span> <span class="k">import</span> <span class="n">SpectralDataTimeSeries</span>
<span class="kn">from</span> <span class="nn">..utilities</span> <span class="k">import</span> <span class="n">write_timeseries_to_fits</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TSOSuite&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="TSOSuite"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite">[docs]</a><span class="k">class</span> <span class="nc">TSOSuite</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transit Spectroscopy Object Suite class.</span>

<span class="sd">    This is the main class containing the ligth curve data of and transiting</span>
<span class="sd">    exoplanet and all functionality to calibrate and analyse the light curves</span>
<span class="sd">    and to extractthe spectrum of the transiting exoplanet.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    init_files: &#39;list&#39; of &#39;str&#39;</span>
<span class="sd">        List containing all the initialization files needed to run the</span>
<span class="sd">        CASCADe code.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Raised when commands not recognized as valid</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    To make instance of TSOSuite class</span>

<span class="sd">    &gt;&gt;&gt; tso = cascade.TSO.TSOSuite()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">init_files</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">default_initialization_path</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">init_files</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">init_files_path</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">init_files</span><span class="p">:</span>
                <span class="n">init_files_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="n">file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span> <span class="o">=</span> <span class="n">configurator</span><span class="p">(</span><span class="o">*</span><span class="n">init_files_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span> <span class="o">=</span> <span class="n">cascade_configuration</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__valid_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary with all the valid commands which can be parsed to the</span>
<span class="sd">        instance of the TSO object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;initialize&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_TSO</span><span class="p">,</span> <span class="s2">&quot;reset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_TSO</span><span class="p">,</span>
                <span class="s2">&quot;load_data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">,</span>
                <span class="s2">&quot;subtract_background&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtract_background</span><span class="p">,</span>
                <span class="s2">&quot;sigma_clip_data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_clip_data</span><span class="p">,</span>
                <span class="s2">&quot;create_cleaned_dataset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_cleaned_dataset</span><span class="p">,</span>
                <span class="s2">&quot;define_eclipse_model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_eclipse_model</span><span class="p">,</span>
                <span class="s2">&quot;determine_source_position&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_source_position</span><span class="p">,</span>
                <span class="s2">&quot;set_extraction_mask&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_extraction_mask</span><span class="p">,</span>
                <span class="s2">&quot;optimal_extraction&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimal_extraction</span><span class="p">,</span>
                <span class="s2">&quot;select_regressors&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_regressors</span><span class="p">,</span>
                <span class="s2">&quot;calibrate_timeseries&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrate_timeseries</span><span class="p">,</span>
                <span class="s2">&quot;extract_spectrum&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_spectrum</span><span class="p">,</span>
                <span class="s2">&quot;correct_extracted_spectrum&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">correct_extracted_spectrum</span><span class="p">,</span>
                <span class="s2">&quot;save_results&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_results</span><span class="p">,</span>
                <span class="s2">&quot;plot_results&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_results</span><span class="p">}</span>

<div class="viewcode-block" id="TSOSuite.execute"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="o">*</span><span class="n">init_files</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if command is valid and excecute if True</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        command:</span>
<span class="sd">            Command to be excecuted. If valid the method corresponding</span>
<span class="sd">            to the command will be excecuted</span>
<span class="sd">        *init_files</span>
<span class="sd">            Single or multiple file names of the .ini files containing the</span>
<span class="sd">            parameters defining the observation and calibration settings.</span>
<span class="sd">        path</span>
<span class="sd">            (optional) Filepath to the .ini files, standard value in None</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            error is raised if command is not valid</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; tso.execute(&#39;reset&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">command</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valid_commands</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Command not recognized, </span><span class="se">\</span>
<span class="s2">                             check your data reduction command for the </span><span class="se">\</span>
<span class="s2">                             following valid commands: </span><span class="si">{}</span><span class="s2">. Aborting </span><span class="se">\</span>
<span class="s2">                             command&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__valid_commands</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;initialize&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__valid_commands</span><span class="p">[</span><span class="n">command</span><span class="p">](</span><span class="o">*</span><span class="n">init_files</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__valid_commands</span><span class="p">[</span><span class="n">command</span><span class="p">]()</span></div>

<div class="viewcode-block" id="TSOSuite.initialize_TSO"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite.initialize_TSO">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_TSO</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">init_files</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the TSO object by reading in a single or</span>
<span class="sd">        multiple .ini files</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        *init_files</span>
<span class="sd">            Single or multiple file names of the .ini files containing the</span>
<span class="sd">            parameters defining the observation and calibration settings.</span>
<span class="sd">        path</span>
<span class="sd">            (optional) Filepath to the .ini files, standard value in None</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        cascade_parameters</span>
<span class="sd">            cascade.initialize.initialize.configurator</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        FileNotFoundError</span>
<span class="sd">            Raises error if .ini file is not found</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; tso.execute(&quot;initialize&quot;, init_flle_name)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">default_initialization_path</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">init_files</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">init_files_path</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">init_files</span><span class="p">:</span>
                <span class="n">init_files_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="n">file</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="n">file</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;ini file </span><span class="si">{}</span><span class="s1"> does not </span><span class="se">\</span>
<span class="s1">                                            excist. Aborting </span><span class="se">\</span>
<span class="s1">                                            initialization&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="n">file</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span> <span class="o">=</span> <span class="n">configurator</span><span class="p">(</span><span class="o">*</span><span class="n">init_files_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span> <span class="o">=</span> <span class="n">cascade_configuration</span></div>

<div class="viewcode-block" id="TSOSuite.reset_TSO"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite.reset_TSO">[docs]</a>    <span class="k">def</span> <span class="nf">reset_TSO</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset initialization of TSO object by removing all loaded parameters.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; tso.execute(&quot;reset&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span></div>

<div class="viewcode-block" id="TSOSuite.load_data"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite.load_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the transit time series observations from file, for the</span>
<span class="sd">        object, observatory, instrument and file location specified in the</span>
<span class="sd">        loaded initialization files</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        observation</span>
<span class="sd">            cascade.instruments.instruments.Observation</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        To load the observed data into the tso object:</span>

<span class="sd">        &gt;&gt;&gt; tso.execute(&quot;load_data&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observation</span> <span class="o">=</span> <span class="n">Observation</span><span class="p">()</span></div>

<div class="viewcode-block" id="TSOSuite.subtract_background"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite.subtract_background">[docs]</a>    <span class="k">def</span> <span class="nf">subtract_background</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subtract median background determined from data or background model</span>
<span class="sd">        from the science observations.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        isBackgroundSubtracted</span>
<span class="sd">            True if background is subtracted</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AttributeError</span>
<span class="sd">           In case no background data is defined</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        To subtract the background from the spectral images:</span>

<span class="sd">        &gt;&gt;&gt; tso.execute(&quot;subtract_background&quot;)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obs_has_backgr</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span>
                                              <span class="n">observations_has_background</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obs_has_backgr</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Background subtraction not needed: returning&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;backgound switch not defined. </span><span class="se">\</span>
<span class="s2">                                 Aborting background subtraction&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">background</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset_background</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No Background data found. </span><span class="se">\</span>
<span class="s2">                                 Aborting background subtraction&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cpm_sigma</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Sigma clip value not defined. </span><span class="se">\</span>
<span class="s2">                                 Aborting background subtraction&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obs_uses_backgr_model</span> <span class="o">=</span> \
                <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span>
                                 <span class="n">observations_uses_background_model</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;observations_uses_background_model parameter </span><span class="se">\</span>
<span class="s1">                          not defined, assuming it to be False&#39;</span><span class="p">)</span>
            <span class="n">obs_uses_backgr_model</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">obs_uses_backgr_model</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span>\
                <span class="n">background</span><span class="o">.</span><span class="n">data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">isBackgroundSubtracted</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>

        <span class="c1"># mask cosmic hits</span>
        <span class="n">input_background_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">background</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                            <span class="n">mask</span><span class="o">=</span><span class="n">background</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">sigma_cliped_mask</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">sigma_clip_data_cosmic</span><span class="p">(</span><span class="n">input_background_data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="c1"># update mask</span>
        <span class="n">updated_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mask_or</span><span class="p">(</span><span class="n">background</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">sigma_cliped_mask</span><span class="p">)</span>
        <span class="n">background</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">updated_mask</span>
        <span class="c1"># calculate median (over time) background</span>
        <span class="n">median_background</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">background</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                         <span class="n">axis</span><span class="o">=</span><span class="n">background</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># tile to format of science data</span>
        <span class="n">tiling</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">([(</span><span class="n">background</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span> <span class="o">+</span>
                  <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">background</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)))</span>
        <span class="n">median_background</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">median_background</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">tiling</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># subtract background</span>
        <span class="c1"># update TSOtimeseries object with background subtracted data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span>\
            <span class="n">median_background</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">isBackgroundSubtracted</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="TSOSuite.sigma_clip_data_cosmic"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite.sigma_clip_data_cosmic">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">sigma_clip_data_cosmic</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sigma clip of time series data cube allong the time axis.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        data : &#39;array_like&#39;</span>
<span class="sd">            Input data to be cliped, last axis of data to be assumed the time</span>
<span class="sd">        sigma : &#39;float&#39;</span>
<span class="sd">            Sigma value of sigmaclip</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sigma_clip_mask : &#39;array_like&#39;</span>
<span class="sd">            Updated mask for input data wiith bad data points flagged (=1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># time axis always the last axis in data,</span>
        <span class="c1"># or the first in the transposed array</span>
        <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sigma_clip_mask</span> <span class="o">=</span> <span class="n">filtered_data</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">sigma_clip_mask</span></div>

<div class="viewcode-block" id="TSOSuite.sigma_clip_data"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite.sigma_clip_data">[docs]</a>    <span class="k">def</span> <span class="nf">sigma_clip_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform sigma clip on science data to flag bad data.</span>

<span class="sd">        Attibutes</span>
<span class="sd">        ---------</span>
<span class="sd">        isSigmaCliped : &#39;bool&#39;</span>
<span class="sd">            Set to True if bad data has been masked using sigma clip</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AttributeError</span>
<span class="sd">            Error is raised if sigma value, the filter length or</span>
<span class="sd">            the convolution kernel are not defined.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        To sigma clip the observation data stored in an instance of a TSO</span>
<span class="sd">        object, run the following example:</span>

<span class="sd">        &gt;&gt;&gt; tso.execute(&quot;sigma_clip_data&quot;)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No Valid data found. </span><span class="se">\</span>
<span class="s2">                                 Aborting sigma clip on data.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cpm_sigma</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Sigma clip value not defined. </span><span class="se">\</span>
<span class="s2">                                 Aborting sigma clip on data.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nfilter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cpm_nfilter</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nfilter</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1"># even</span>
                <span class="n">nfilter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Filter length for sigma clip not defined. </span><span class="se">\</span>
<span class="s2">                                 Aborting sigma clip on data.&quot;</span><span class="p">)</span>

        <span class="c1"># mask cosmic hits</span>
        <span class="n">temp_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_in</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">data_in</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">sigma_cliped_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_clip_data_cosmic</span><span class="p">(</span><span class="n">temp_data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="c1"># update mask</span>
        <span class="n">updated_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mask_or</span><span class="p">(</span><span class="n">data_in</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">sigma_cliped_mask</span><span class="p">)</span>
        <span class="n">data_in</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">updated_mask</span>

        <span class="n">dim</span> <span class="o">=</span> <span class="n">data_in</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="n">data_in</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">data_in</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">il</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="o">+</span><span class="p">(</span><span class="n">nfilter</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">nfilter</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">filter_index</span> <span class="o">=</span> \
                <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="n">il</span> <span class="o">-</span> <span class="p">(</span><span class="n">nfilter</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">il</span><span class="o">+</span><span class="p">(</span><span class="n">nfilter</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span> <span class="o">+</span> \
                <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span><span class="o">*</span><span class="p">(</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">filter_index</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">filter_index</span><span class="p">)</span>
            <span class="c1"># reformat to masked array without quantity</span>
            <span class="n">temp_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_in</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">data_in</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
            <span class="c1"># median along time axis</span>
            <span class="n">temp_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">temp_data</span><span class="p">[</span><span class="n">filter_index</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># filter in box in the wavelength direction</span>
            <span class="n">temp_data</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">temp_data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ndim</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># specra:  tiling=(dim[1], 1)</span>
            <span class="c1"># spectral images:  tiling=(dim[2], 1, 1)</span>
            <span class="c1"># spectral data cubes: tiling=(dim[3], 1, 1, 1)</span>
            <span class="n">tiling</span> <span class="o">=</span> <span class="n">dim</span><span class="p">[</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
            <span class="n">mask_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">temp_data</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">tiling</span><span class="p">)</span>
            <span class="c1"># add to mask</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">filter_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mask_or</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">filter_index</span><span class="p">],</span> <span class="n">mask_new</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="c1"># update mask and set flag</span>
        <span class="n">updated_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mask_or</span><span class="p">(</span><span class="n">data_in</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">isSigmaCliped</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="TSOSuite.create_cleaned_dataset"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite.create_cleaned_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">create_cleaned_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a cleaned dataset to be used in regresion analysis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Spectral dataset not found. Aborting &quot;</span>
                                 <span class="s2">&quot;the creation of a cleaned dataset.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obs_has_backgr</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span>
                                              <span class="n">observations_has_background</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obs_has_backgr</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">dataset</span><span class="o">.</span><span class="n">isBackgroundSubtracted</span> <span class="ow">is</span> <span class="kc">True</span>
            <span class="k">assert</span> <span class="n">dataset</span><span class="o">.</span><span class="n">isSigmaCliped</span> <span class="ow">is</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Spectral dataset not background subtracted &quot;</span>
                                 <span class="s2">&quot;and/or sigma clipped. Aborting the &quot;</span>
                                 <span class="s2">&quot;creation of a cleaned dataset.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">roi_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">instrument_calibration</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Region of interest not set. Aborting the &quot;</span>
                                 <span class="s2">&quot;creation of a cleaned dataset.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">instrument_calibration</span><span class="o">.</span><span class="n">convolution_kernel</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Convolution kernel not set. Aborting the &quot;</span>
                                 <span class="s2">&quot;creation of a cleaned dataset.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stdv_kernel_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span>
                                     <span class="n">cpm_stdv_kernel_time_axis</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Parameters for time dependenccy &quot;</span>
                                 <span class="s2">&quot;convolution kernel not set. &quot;</span>
                                 <span class="s2">&quot;Aborting optimal extraction.&quot;</span><span class="p">)</span>

        <span class="n">spectral_image_using_roi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                               <span class="n">mask</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                               <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="n">ndim</span> <span class="o">=</span> <span class="n">spectral_image_using_roi</span><span class="o">.</span><span class="n">ndim</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">spectral_image_using_roi</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">data_unit</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">unit</span>

        <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">RS</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">(</span><span class="n">with_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">RS</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">spectral_image_using_roi</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">spectral_image_using_roi</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_scaled</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">spectral_image_using_roi</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>

        <span class="n">spectral_image_using_roi</span><span class="p">[</span><span class="n">roi_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">spectral_image_using_roi</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">roi_mask</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">spectral_image_using_roi</span><span class="o">.</span><span class="n">set_fill_value</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="n">kernel_size</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">kernel_1d</span> <span class="o">=</span> <span class="n">Gaussian1DKernel</span><span class="p">(</span><span class="n">stdv_kernel_time</span><span class="p">,</span> <span class="n">x_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">)</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="n">kernel_size</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)])</span><span class="o">+</span><span class="nb">tuple</span><span class="p">([</span><span class="kc">None</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">*</span><span class="n">kernel_1d</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">selection</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>

        <span class="n">cleaned_spectral_image_using_roi</span> <span class="o">=</span> \
            <span class="n">interpolate_replace_nans</span><span class="p">(</span><span class="n">spectral_image_using_roi</span><span class="o">.</span><span class="n">filled</span><span class="p">(),</span>
                                     <span class="n">kernel</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;extend&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">cleaned_spectral_image_using_roi</span> <span class="o">=</span> \
                <span class="n">RS</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">cleaned_spectral_image_using_roi</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">roi_mask</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">cleaned_data</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cleaned_spectral_image_using_roi</span><span class="o">*</span><span class="n">data_unit</span><span class="p">,</span>
                            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span></div>

<div class="viewcode-block" id="TSOSuite.define_eclipse_model"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite.define_eclipse_model">[docs]</a>    <span class="k">def</span> <span class="nf">define_eclipse_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function defines the light curve model used to analize the</span>
<span class="sd">        transit or eclipse. We define both the actual trasit/eclipse signal</span>
<span class="sd">        as wel as an calibration signal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">isNodded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">isNodded</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Observational strategy not properly set. </span><span class="se">\</span>
<span class="s2">                                 Aborting definition of eclipse model.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cal_signal_pos</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cpm_calibration_signal_position</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Calibration signal parameters not set. </span><span class="se">\</span>
<span class="s2">                                 Aborting definition of eclipse model.&quot;</span><span class="p">)</span>
        <span class="c1"># define ligthcurve model</span>
        <span class="n">lc_model</span> <span class="o">=</span> <span class="n">lightcuve</span><span class="p">()</span>
        <span class="n">times_during_transit</span> <span class="o">=</span> <span class="n">lc_model</span><span class="o">.</span><span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">lc_model</span><span class="o">.</span><span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)]</span>
        <span class="n">Tstart</span> <span class="o">=</span> <span class="n">times_during_transit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Tend</span> <span class="o">=</span> <span class="n">times_during_transit</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># interpoplate light curve model to observed phases</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">lc_model</span><span class="o">.</span><span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lc_model</span><span class="o">.</span><span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># use interpolation function returned by `interp1d`</span>
        <span class="n">lcmodel_obs</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># define a calibration signal which can be used to inject a</span>
        <span class="c1"># artificial signal into the data. The shape of the calibration</span>
        <span class="c1"># signal is a box car.</span>
        <span class="n">lcmodel_cal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lcmodel_obs</span><span class="p">)</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="n">lcmodel_cal</span><span class="o">.</span><span class="n">ndim</span>
        <span class="n">selection1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span><span class="o">*</span><span class="p">(</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span>
        <span class="n">time_cal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span>
                              <span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">selection1</span><span class="p">)])</span>
        <span class="c1"># select data before and after transit</span>
        <span class="n">idx_before</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">time_cal</span> <span class="o">&lt;</span> <span class="n">Tstart</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">idx_after</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">time_cal</span> <span class="o">&gt;</span> <span class="n">Tend</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># check the duration of the time series out of transit</span>
        <span class="n">max_cal_points_before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_before</span><span class="p">)</span>
        <span class="n">max_cal_points_after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_after</span><span class="p">)</span>
        <span class="c1"># inject signal of half the the duration of the transit</span>
        <span class="c1"># place calibration signal in the midle of the time sequence before</span>
        <span class="c1"># or after the actual transit.</span>
        <span class="k">if</span> <span class="n">cal_signal_pos</span> <span class="o">==</span> <span class="s1">&#39;before&#39;</span><span class="p">:</span>
            <span class="n">idx_end</span> <span class="o">=</span> <span class="n">idx_before</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">max_cal_points_before</span><span class="o">//</span><span class="mi">4</span>
            <span class="n">idx_start</span> <span class="o">=</span> <span class="n">idx_end</span> <span class="o">-</span> <span class="n">max_cal_points_before</span><span class="o">//</span><span class="mi">2</span>
            <span class="n">selection1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span><span class="o">*</span><span class="p">(</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> \
                <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="n">idx_start</span><span class="p">,</span> <span class="n">idx_end</span><span class="p">)]</span>
            <span class="n">lcmodel_cal</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">selection1</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx_start</span> <span class="o">=</span> <span class="n">idx_after</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">max_cal_points_after</span><span class="o">//</span><span class="mi">4</span>
            <span class="n">idx_end</span> <span class="o">=</span> <span class="n">idx_start</span> <span class="o">+</span> <span class="n">max_cal_points_after</span><span class="o">//</span><span class="mi">2</span>
            <span class="n">selection2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span><span class="o">*</span><span class="p">(</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> \
                <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="n">idx_start</span><span class="p">,</span> <span class="n">idx_end</span><span class="p">)]</span>
            <span class="n">lcmodel_cal</span><span class="p">[</span><span class="n">selection2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

        <span class="k">if</span> <span class="n">isNodded</span><span class="p">:</span>
            <span class="n">ntime</span> <span class="o">=</span> <span class="n">lcmodel_obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">mask_nod1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ntime</span><span class="p">)</span>
            <span class="n">mask_nod1</span><span class="p">[</span><span class="n">ntime</span><span class="o">//</span><span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">mask_nod2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ntime</span><span class="p">)</span>
            <span class="n">mask_nod2</span><span class="p">[:</span><span class="n">ntime</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">lcmodel_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">lcmodel_obs</span><span class="o">*</span><span class="n">mask_nod1</span><span class="p">,</span> <span class="n">lcmodel_obs</span><span class="o">*</span><span class="n">mask_nod2</span><span class="p">]</span>
            <span class="n">lcmodel_cal_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">lcmodel_cal</span><span class="o">*</span><span class="n">mask_nod1</span><span class="p">,</span> <span class="n">lcmodel_cal</span><span class="o">*</span><span class="n">mask_nod2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lcmodel_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">lcmodel_obs</span><span class="p">]</span>
            <span class="n">lcmodel_cal_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">lcmodel_cal</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">light_curve</span> <span class="o">=</span> <span class="n">lc_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">transit_timing</span> <span class="o">=</span> <span class="p">[</span><span class="n">Tstart</span><span class="p">,</span> <span class="n">Tend</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">light_curve_interpolated</span> <span class="o">=</span> <span class="n">lcmodel_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">calibration_signal</span> <span class="o">=</span> <span class="n">lcmodel_cal_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">transittype</span> <span class="o">=</span> <span class="n">lc_model</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;transittype&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="TSOSuite.determine_source_position"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite.determine_source_position">[docs]</a>    <span class="k">def</span> <span class="nf">determine_source_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function determines the position of the source in the slit</span>
<span class="sd">        over time and the spectral trace.</span>

<span class="sd">        We check if trace and position are already set, if not, determine them</span>
<span class="sd">        from the data by deriving the &quot;center of light&quot; of the dispersed</span>
<span class="sd">        light.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        spectral_trace :</span>
<span class="sd">            The trace of the dispersed light on the detector normalized</span>
<span class="sd">            to its median position. In case the data are extracted spectra,</span>
<span class="sd">            the trace is zero.</span>
<span class="sd">        position :</span>
<span class="sd">            Postion of the source on the detector in the cross dispersion</span>
<span class="sd">            directon as a function of time, normalized to the</span>
<span class="sd">            median position.</span>
<span class="sd">        median_position :</span>
<span class="sd">            median source position.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        position</span>
<span class="sd">            position of source in time</span>
<span class="sd">        med_position</span>
<span class="sd">            median (in time) position of source</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">ndim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">instrument_calibration</span><span class="o">.</span><span class="n">roi</span>
<span class="c1">#            data_in = self.cpm.cleaned_data</span>
<span class="c1">#            dim = data_in.shape</span>
<span class="c1">#            ndim = data_in.data.ndim</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No Valid data found. </span><span class="se">\</span>
<span class="s2">                                 Aborting position determination&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">isNodded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">isNodded</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Observational strategy not properly set. </span><span class="se">\</span>
<span class="s2">                                 Aborting position determination&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">spectral_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">spectral_trace</span>
            <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">position</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Position and trace are not both defined yet. Calculating.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Position and trace already set in dataset. </span><span class="se">\</span>
<span class="s2">                  Using that in further analysis.&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">temp0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">spectral_trace</span><span class="p">[</span><span class="s1">&#39;positional_pixel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">isNodded</span><span class="p">:</span>
                    <span class="n">new_shape</span> <span class="o">=</span> <span class="n">dim</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">axis_selection</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
                    <span class="n">temp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                                 <span class="n">new_shape</span><span class="p">),</span>
                                      <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="n">axis_selection</span><span class="p">))</span>
                    <span class="n">normalized_pos</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">nod_index</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span><span class="o">*</span><span class="p">(</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> \
                        <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dim</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
                    <span class="n">normalized_pos</span><span class="p">[</span><span class="n">nod_index</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">normalized_pos</span><span class="p">[</span><span class="n">nod_index</span><span class="p">]</span> <span class="o">-</span> <span class="n">temp1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">nod_index</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span><span class="o">*</span><span class="p">(</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> \
                        <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
                    <span class="n">normalized_pos</span><span class="p">[</span><span class="n">nod_index</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">normalized_pos</span><span class="p">[</span><span class="n">nod_index</span><span class="p">]</span> <span class="o">-</span> <span class="n">temp1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">temp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">)])</span>
                    <span class="n">normalized_pos</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">normalized_pos</span> <span class="o">=</span> <span class="n">normalized_pos</span> <span class="o">-</span> <span class="n">temp1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">spectral_trace</span> <span class="o">=</span> \
                    <span class="n">spectral_trace</span><span class="p">[</span><span class="s1">&#39;positional_pixel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">temp0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">normalized_pos</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">median_position</span> <span class="o">=</span> <span class="n">temp0</span> <span class="o">+</span> <span class="n">temp1</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sigma_clip_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">isSigmaCliped</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Data not sigma clipped, which can result </span><span class="se">\</span>
<span class="s2">                                 in wrong positions&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sigma_clip_flag</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Data not sigma clipped, </span><span class="se">\</span>
<span class="s2">                                     which can result in wrong positions&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ramp_fitted_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">isRampFitted</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;type of data not properly set, </span><span class="se">\</span>
<span class="s2">                                 or not consistent with spectral images </span><span class="se">\</span>
<span class="s2">                                 or cubes. Aborting position determination&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ramp_fitted_flag</span><span class="p">:</span>
            <span class="c1"># determine ramp slope from 2 point difference and collapse image</span>
            <span class="c1"># in detector cubes, last index is time,</span>
            <span class="c1"># and the prelast index samples up the ramp</span>
            <span class="n">data_use</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data_in</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ndim</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">#            data_use = np.ma.median(data_in, axis=ndim-2)</span>
            <span class="n">data_use</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">data_use</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">time_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span>
            <span class="n">time_use</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">time_in</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ndim</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_use</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_in</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                   <span class="n">mask</span><span class="o">=</span><span class="n">data_in</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="n">data_use</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">data_use</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1">#            data_use = data_in</span>
            <span class="n">time_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span>
            <span class="n">time_use</span> <span class="o">=</span> <span class="n">time_in</span>

        <span class="n">npix</span><span class="p">,</span> <span class="n">mpix</span><span class="p">,</span> <span class="n">nintegrations</span> <span class="o">=</span> <span class="n">data_use</span><span class="o">.</span><span class="n">shape</span>
        <span class="c1"># check if data is nodded or not</span>
        <span class="k">if</span> <span class="n">isNodded</span><span class="p">:</span>
            <span class="n">time_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nintegrations</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nintegrations</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span>
                        <span class="n">nintegrations</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nintegrations</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
        <span class="c1"># determine source position in time and source trace for</span>
        <span class="c1"># each nod seperately.</span>
        <span class="n">pos_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">trace_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">median_pos_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">inod</span> <span class="ow">in</span> <span class="n">time_idx</span><span class="p">:</span>
            <span class="n">nint_use</span> <span class="o">=</span> <span class="n">inod</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pos_trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npix</span><span class="p">))</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nint_use</span><span class="p">))</span>

            <span class="n">prof_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data_use</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">inod</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">grid_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mpix</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">mpix</span><span class="p">)</span>
            <span class="n">array_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">grid_temp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">tile_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">array_temp</span><span class="p">,</span> <span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">pos_trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">prof_temp</span> <span class="o">*</span> <span class="n">tile_temp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">prof_temp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">array_temp</span><span class="p">,</span>
                                            <span class="p">(</span><span class="n">nint_use</span><span class="p">,</span> <span class="n">npix</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data_use</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">inod</span><span class="p">]</span> <span class="o">*</span>
                                          <span class="n">weight</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data_use</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">inod</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">pos_trace</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nint_use</span><span class="p">)),</span>
                               <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># add 0.5 pix to shift position to center of pixel</span>
            <span class="n">pos_trace</span> <span class="o">=</span> <span class="n">pos_trace</span><span class="o">+</span><span class="mf">0.5</span>

            <span class="n">pos_slit</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">pos_trace</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">pos_trace</span><span class="p">)</span>
            <span class="n">pos_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_slit</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">median_pos_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">pos_trace</span><span class="p">))</span>
            <span class="n">pos_trace</span> <span class="o">=</span> <span class="n">pos_trace</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">pos_trace</span><span class="p">)</span>
            <span class="n">trace_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_trace</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="n">pos_slit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">pos_list</span>
                               <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">median_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">median_pos_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="c1"># if nodded combine traces.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trace_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">pos_trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">trace_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pos_trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">trace_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>

        <span class="c1"># make sure position is given on time grid acociated with data</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">time_use</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">pos_slit</span><span class="p">,</span>
                                 <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
        <span class="n">pos_slit_interpolated</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">time_in</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">spectral_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">spectral_trace</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using calculated trace&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">spectral_trace</span> <span class="o">=</span> <span class="n">pos_trace</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">temp0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">spectral_trace</span><span class="p">[</span><span class="s1">&#39;positional_pixel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">spectral_trace</span> <span class="o">=</span> \
                    <span class="n">spectral_trace</span><span class="p">[</span><span class="s1">&#39;positional_pixel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">temp0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">pos_slit_interpolated</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">median_position</span> <span class="o">=</span> <span class="n">median_pos</span></div>

<div class="viewcode-block" id="TSOSuite.set_extraction_mask"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite.set_extraction_mask">[docs]</a>    <span class="k">def</span> <span class="nf">set_extraction_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set mask which defines the area of interest within which</span>
<span class="sd">        a transit signal will be determined. The mask is set along the</span>
<span class="sd">        spectral trace with a pixel width of nExtractionWidth</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mask</span>
<span class="sd">            In case data are Spectra : 1D mask</span>
<span class="sd">            In case data are Spectral images or cubes: 2D mask</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nExtractionWidth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cpm_nextraction</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;The width of the extraction mask </span><span class="se">\</span>
<span class="s2">                                 is not define. Check the initialiation </span><span class="se">\</span>
<span class="s2">                                 of the TSO object. </span><span class="se">\</span>
<span class="s2">                                 Aborting setting extraction mask&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">spectral_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">spectral_trace</span>
            <span class="n">median_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">median_position</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No spectral trace or source position </span><span class="se">\</span>
<span class="s2">                                 found. Aborting setting extraction mask&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No Valid data found. </span><span class="se">\</span>
<span class="s2">                                 Aborting setting extraction mask&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">instrument_calibration</span><span class="o">.</span><span class="n">roi</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No ROI defined. &quot;</span>
                                 <span class="s2">&quot;Aborting setting extraction mask&quot;</span><span class="p">)</span>

        <span class="n">dim</span> <span class="o">=</span> <span class="n">data_in</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="n">data_in</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">data_in</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">ndim_extractionMask</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">select_axis</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ndim</span><span class="p">))</span>

        <span class="n">ExtractionMask</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">select_axis</span><span class="p">[</span><span class="n">ndim_extractionMask</span><span class="p">:])]</span>
        <span class="n">ExtractionMask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="n">ExtractionMask</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">ndim_extractionMask</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">idx_mask_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">nExtractionWidth</span><span class="p">)))</span><span class="o">.</span>
                                 <span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">nExtractionWidth</span><span class="p">))</span><span class="o">//</span><span class="mi">2</span>

            <span class="n">idx_mask_x</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">nExtractionWidth</span><span class="p">)),</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

<span class="c1">#            extraction_mask = np.ones_like(ExtractionMask[0]).astype(bool)</span>

            <span class="n">ExtractionMaskperNod</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ipos</span> <span class="ow">in</span> <span class="n">median_position</span><span class="p">:</span>
                <span class="n">extraction_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ExtractionMask</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
                <span class="n">idx_mask_y_shifted</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">spectral_trace</span> <span class="o">+</span> <span class="n">ipos</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">nExtractionWidth</span><span class="p">)),</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">idx_mask_y</span>
                <span class="n">idx_fix</span> <span class="o">=</span> <span class="n">idx_mask_y_shifted</span> <span class="o">&lt;</span> <span class="mi">0</span>
                <span class="n">idx_mask_y_shifted</span><span class="p">[</span><span class="n">idx_fix</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">idx_fix</span> <span class="o">=</span> <span class="n">idx_mask_y_shifted</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">idx_mask_y_shifted</span><span class="p">[</span><span class="n">idx_fix</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">extraction_mask</span><span class="p">[</span><span class="n">idx_mask_x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                                <span class="n">idx_mask_y_shifted</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> \
                    <span class="kc">False</span>
                <span class="n">ExtractionMaskperNod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">extraction_mask</span><span class="p">,</span>
                                                          <span class="n">ExtractionMask</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">ExtractionMask</span> <span class="o">=</span> <span class="n">ExtractionMaskperNod</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">extraction_mask</span> <span class="o">=</span> <span class="n">ExtractionMask</span></div>

<div class="viewcode-block" id="TSOSuite._create_edge_mask"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite._create_edge_mask">[docs]</a>    <span class="k">def</span> <span class="nf">_create_edge_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">roi_mask_cube</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an edge mask to mask all pixels for which the convolution kernel</span>
<span class="sd">        extends beyond the ROI</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kernel</span>
<span class="sd">        roi_mask</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        edge_mask</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dilation_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">edge_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">binary_dilation</span><span class="p">(</span><span class="n">roi_mask_cube</span><span class="p">,</span>  <span class="n">structure</span><span class="o">=</span><span class="n">dilation_mask</span><span class="p">,</span>
                                     <span class="n">border_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">^</span> <span class="n">roi_mask_cube</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">edge_mask</span></div>

<div class="viewcode-block" id="TSOSuite._create_extraction_profile"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite._create_extraction_profile">[docs]</a>    <span class="k">def</span> <span class="nf">_create_extraction_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cleaned_data_with_roi_mask</span><span class="p">,</span>
                                   <span class="n">extracted_spectra</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span>
                                   <span class="n">mask_for_extraction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the normilzed source profile used for optimal extraction.</span>
<span class="sd">        The cleaned data is convolved with an appropriate kernel to smooth the</span>
<span class="sd">        profile and to increase the SNR. On the edges, where the kernel extends</span>
<span class="sd">        over the boundary, non convolved data is used to prevent edge effects</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cleaned_data_with_roi_mask</span>

<span class="sd">        extracted_spectra</span>

<span class="sd">        kernel</span>

<span class="sd">        mask_for_extraction</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        extraction_profile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">npix</span><span class="p">,</span> <span class="n">mpix</span><span class="p">,</span> <span class="n">ntime</span> <span class="o">=</span> <span class="n">cleaned_data_with_roi_mask</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">roi_mask</span> <span class="o">=</span> <span class="n">cleaned_data_with_roi_mask</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">extraction_profile_nc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">cleaned_data_with_roi_mask</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">/</span>
            <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">extracted_spectra</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                      <span class="p">(</span><span class="n">mpix</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">edge_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_edge_mask</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">roi_mask</span><span class="p">)</span>

        <span class="n">extraction_profile</span> <span class="o">=</span> <span class="n">ap_convolve</span><span class="p">(</span><span class="n">extraction_profile_nc</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span>
                                         <span class="n">mask</span><span class="o">=</span><span class="n">mask_for_extraction</span><span class="p">,</span>
                                         <span class="n">boundary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                         <span class="n">nan_treatment</span><span class="o">=</span><span class="s1">&#39;interpolate&#39;</span><span class="p">,</span>
                                         <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
        <span class="n">extraction_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">extraction_profile</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">roi_mask</span><span class="p">,</span>
                                         <span class="n">hard_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
        <span class="n">extraction_profile</span><span class="p">[</span><span class="n">edge_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">extraction_profile_nc</span><span class="p">[</span><span class="n">edge_mask</span><span class="p">]</span>
        <span class="n">extraction_profile</span><span class="o">.</span><span class="n">harden_mask</span><span class="p">()</span>
        <span class="n">extraction_profile</span><span class="p">[</span><span class="n">extraction_profile</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">extraction_profile</span> <span class="o">=</span> <span class="n">extraction_profile</span> <span class="o">/</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">extraction_profile</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">extraction_profile</span></div>

<div class="viewcode-block" id="TSOSuite._create_3dKernel"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite._create_3dKernel">[docs]</a>    <span class="k">def</span> <span class="nf">_create_3dKernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a 3d Kernel from 2d Instrument specific Kernel</span>
<span class="sd">        to include time dimention</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sigma_time</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        3dKernel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">instrument_calibration</span><span class="o">.</span><span class="n">convolution_kernel</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No Kernel found. </span><span class="se">\</span>
<span class="s2">                                 Aborting 3d Kernel creation&quot;</span><span class="p">)</span>

        <span class="n">kernel_size</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">kernel_time_dimension</span> <span class="o">=</span> <span class="n">Gaussian1DKernel</span><span class="p">(</span><span class="n">sigma_time</span><span class="p">,</span>
                                                 <span class="n">x_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">)</span>
        <span class="n">kernel3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                             <span class="p">(</span><span class="n">kernel_size</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">kernel3d</span> <span class="o">=</span> <span class="n">kernel3d</span><span class="o">*</span><span class="n">kernel_time_dimension</span><span class="o">.</span><span class="n">array</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">kernel3d</span> <span class="o">=</span> <span class="n">apKernel</span><span class="p">(</span><span class="n">kernel3d</span><span class="p">)</span>
        <span class="n">kernel3d</span><span class="o">.</span><span class="n">_separable</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">kernel3d</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">kernel3d</span></div>

<div class="viewcode-block" id="TSOSuite.optimal_extraction"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite.optimal_extraction">[docs]</a>    <span class="k">def</span> <span class="nf">optimal_extraction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optimally extract spectrum using procedure of</span>
<span class="sd">        Horne 1986, PASP 98, 609</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Optimally extracted 1d Spectra</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obs_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">observations_data</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No observation data type set. &quot;</span>
                                 <span class="s2">&quot;Aborting optimal extraction&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obs_data</span> <span class="o">==</span> <span class="s2">&quot;SPECTRAL_IMAGE&quot;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Data are no spectral images. &quot;</span>
                          <span class="s2">&quot;Aborting optimal extraction&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Spectral dataset not found. Aborting &quot;</span>
                                 <span class="s2">&quot;optimal extraction.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obs_has_backgr</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span>
                                              <span class="n">observations_has_background</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obs_has_backgr</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">dataset</span><span class="o">.</span><span class="n">isBackgroundSubtracted</span> <span class="ow">is</span> <span class="kc">True</span>
            <span class="k">assert</span> <span class="n">dataset</span><span class="o">.</span><span class="n">isSigmaCliped</span> <span class="ow">is</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Spectral dataset not background subtracted &quot;</span>
                                 <span class="s2">&quot;and/or sigma clipped. Aborting &quot;</span>
                                 <span class="s2">&quot;optimal extraction.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ExtractionMask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">extraction_mask</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No extraction mask found. &quot;</span>
                                 <span class="s2">&quot;Aborting optimal extraction&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cleaned_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">cleaned_data</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No cleaned data found. &quot;</span>
                                 <span class="s2">&quot;Aborting optimal extraction&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">isNodded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">isNodded</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Observational strategy not properly set. &quot;</span>
                                 <span class="s2">&quot;Aborting optimal extraction.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">max_iter</span> <span class="o">=</span> \
                <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cpm_max_iter_optimal_extraction</span><span class="p">)</span>
            <span class="n">nsigma</span> <span class="o">=</span> \
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cpm_sigma_optimal_extraction</span><span class="p">)</span>
            <span class="n">stdv_kernel_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span>
                                     <span class="n">cpm_stdv_kernel_time_axis</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Parameters for optimal extraction not set. &quot;</span>
                                 <span class="s2">&quot;Aborting optimal extraction.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">position</span>
            <span class="n">median_pos</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="k">for</span> <span class="n">mp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">median_position</span><span class="p">]</span>
            <span class="n">position_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Source position is not determined. &quot;</span>
                                 <span class="s2">&quot;Aborting optimal extraction.&quot;</span><span class="p">)</span>

        <span class="n">data_cleaned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                   <span class="n">mask</span><span class="o">=</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                           <span class="n">mask</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">data_unit</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">data_unit</span>
        <span class="n">variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">uncertainty</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                               <span class="n">mask</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">wavelength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">wavelength</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                 <span class="n">mask</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">wavelength_unit</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">wavelength_unit</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                           <span class="n">mask</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">time_unit</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">time_unit</span>
        <span class="n">time_bjd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time_bjd</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                               <span class="n">mask</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">time_bjd_unit</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">time_bjd_unit</span>

        <span class="n">kernel3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_3dKernel</span><span class="p">(</span><span class="n">stdv_kernel_time</span><span class="p">)</span>

        <span class="n">npix</span><span class="p">,</span> <span class="n">mpix</span><span class="p">,</span> <span class="n">ntime</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isNodded</span><span class="p">:</span>
            <span class="n">ntime_max</span> <span class="o">=</span> <span class="n">ntime</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ntime_max</span> <span class="o">=</span> <span class="n">ntime</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">inod</span><span class="p">,</span> <span class="n">extr_mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ExtractionMask</span><span class="p">):</span>
            <span class="n">extr_mask_cube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="o">~</span><span class="n">extr_mask</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                     <span class="p">(</span><span class="n">ntime_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">mask_for_extraction</span> <span class="o">=</span> \
                <span class="n">data_cleaned</span><span class="o">.</span><span class="n">mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">inod</span><span class="o">*</span><span class="n">ntime_max</span><span class="p">:(</span><span class="n">inod</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ntime_max</span><span class="p">]</span>
            <span class="n">data_for_profile</span> <span class="o">=</span> \
                <span class="n">data_cleaned</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">inod</span><span class="o">*</span><span class="n">ntime_max</span><span class="p">:(</span><span class="n">inod</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ntime_max</span><span class="p">]</span>

            <span class="c1"># initial guess of extracted spectra and extraction profile</span>
            <span class="n">extracted_spectra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data_for_profile</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">extraction_profile</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_extraction_profile</span><span class="p">(</span><span class="n">data_for_profile</span><span class="p">,</span>
                                                <span class="n">extracted_spectra</span><span class="p">,</span>
                                                <span class="n">kernel3d</span><span class="p">,</span> <span class="n">mask_for_extraction</span><span class="p">)</span>

            <span class="c1"># Equivalent to Iteration over step 5 to 7 in Horne et al 1986</span>
            <span class="n">iiter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mask_save</span> <span class="o">=</span> <span class="n">mask_for_extraction</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">number_different_masked</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">max_iter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Creating extracton profile&#39;</span><span class="p">)</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">number_different_masked</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">iiter</span> <span class="o">&lt;=</span> <span class="n">max_iter</span><span class="p">):</span>

                <span class="n">mask_flaged_data</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">data</span> <span class="o">-</span> <span class="n">extraction_profile</span> <span class="o">*</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">extracted_spectra</span><span class="p">,</span>
                                                            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">mpix</span><span class="p">),</span>
                                             <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                 <span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="n">nsigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">variance</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">mask_flaged_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_flaged_data</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                                            <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">number_different_masked</span> <span class="o">=</span> \
                    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask_save</span> <span class="o">!=</span> <span class="n">mask_flaged_data</span><span class="p">))</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix_str</span><span class="p">(</span><span class="s1">&#39;# of pixels not previously masked: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span>
                                     <span class="nb">format</span><span class="p">(</span><span class="n">number_different_masked</span><span class="p">))</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
                <span class="n">mask_save</span> <span class="o">=</span> <span class="n">mask_flaged_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">mask_flaged_data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">extr_mask_cube</span>
                <span class="n">mask_for_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">mask_for_extraction</span><span class="p">,</span>
                                                    <span class="n">mask_flaged_data</span><span class="p">)</span>

                <span class="n">extraction_profile</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">_create_extraction_profile</span><span class="p">(</span><span class="n">data_for_profile</span><span class="p">,</span>
                                                    <span class="n">extracted_spectra</span><span class="p">,</span>
                                                    <span class="n">kernel3d</span><span class="p">,</span>
                                                    <span class="n">mask_for_profile</span><span class="p">)</span>

                <span class="n">iiter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">number_different_masked</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Mask not converged in optimal spectral &quot;</span>
                              <span class="s2">&quot;extraction. </span><span class="si">{}</span><span class="s2"> mask values not converged. An &quot;</span>
                              <span class="s2">&quot;increase of the maximum number of iteration &quot;</span>
                              <span class="s2">&quot;steps might be advisable.&quot;</span><span class="o">.</span>
                              <span class="nb">format</span><span class="p">(</span><span class="n">number_different_masked</span><span class="p">))</span>

            <span class="c1"># Equivalent to Iteration over step 7 and 8 in Horne et al 1986</span>
            <span class="n">iiter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mask_save</span> <span class="o">=</span> <span class="n">mask_for_extraction</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">number_different_masked</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">max_iter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Optimally extracting spectra&#39;</span><span class="p">)</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">number_different_masked</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">iiter</span> <span class="o">&lt;=</span> <span class="n">max_iter</span><span class="p">):</span>

                <span class="n">mask_flaged_data</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">data</span> <span class="o">-</span> <span class="n">extraction_profile</span> <span class="o">*</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                                              <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">extracted_spectra</span><span class="p">,</span>
                                                             <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                              <span class="p">(</span><span class="n">mpix</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                 <span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="n">nsigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">variance</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">mask_flaged_data</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_flaged_data</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">number_different_masked</span> <span class="o">=</span> \
                    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask_save</span> <span class="o">!=</span> <span class="n">mask_flaged_data</span><span class="p">))</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix_str</span><span class="p">(</span><span class="s1">&#39;# of pixels not previously masked: &#39;</span>
                                     <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number_different_masked</span><span class="p">))</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
                <span class="n">mask_save</span> <span class="o">=</span> <span class="n">mask_flaged_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">mask_flaged_data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">extr_mask_cube</span>

                <span class="n">extracted_spectra</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="o">*</span><span class="n">extraction_profile</span><span class="o">*</span><span class="n">data</span><span class="o">/</span><span class="n">variance</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span>\
                    <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="o">*</span><span class="n">extraction_profile</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">variance</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">variance_extracted_spectrum</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="o">*</span><span class="n">extraction_profile</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="o">*</span><span class="n">extraction_profile</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">variance</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">iiter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">number_different_masked</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Mask not converged in optimal spectral &quot;</span>
                              <span class="s2">&quot;extraction. </span><span class="si">{}</span><span class="s2"> mask values not converged. &quot;</span>
                              <span class="s2">&quot;An increase of the maximum number of &quot;</span>
                              <span class="s2">&quot;iteration steps might be advisable.&quot;</span><span class="o">.</span>
                              <span class="nb">format</span><span class="p">(</span><span class="n">number_different_masked</span><span class="p">))</span>

<span class="c1"># TEST</span>
        <span class="n">median_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">extracted_spectra</span><span class="p">)</span>
        <span class="n">extracted_spectra</span> <span class="o">=</span> <span class="n">extracted_spectra</span><span class="o">/</span><span class="n">median_signal</span>
        <span class="n">variance_extracted_spectrum</span> <span class="o">=</span> <span class="p">(</span><span class="n">variance_extracted_spectrum</span> <span class="o">/</span>
                                       <span class="n">median_signal</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">data_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">median_signal</span><span class="o">*</span><span class="n">data_unit</span><span class="p">)</span>

        <span class="n">wavelength_extracted_spectrum</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="o">*</span><span class="n">extraction_profile</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">wavelength</span><span class="o">/</span><span class="n">variance</span><span class="p">,</span>
                      <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span>\
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="o">*</span><span class="n">extraction_profile</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">variance</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">uncertainty_extracted_spectrum</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance_extracted_spectrum</span><span class="p">)</span>
        <span class="n">time_extracted_spectrum</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="o">*</span><span class="n">extraction_profile</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">time</span><span class="o">/</span><span class="n">variance</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span>\
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="o">*</span><span class="n">extraction_profile</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">variance</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">time_bjd_extracted_spectrum</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="o">*</span><span class="n">extraction_profile</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">time_bjd</span><span class="o">/</span><span class="n">variance</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span>\
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="o">*</span><span class="n">extraction_profile</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">variance</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">position_extracted_spectrum</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="o">*</span><span class="n">extraction_profile</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">position</span><span class="o">/</span><span class="n">variance</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span>\
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="o">*</span><span class="n">extraction_profile</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">variance</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">data_product</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset_parameters</span><span class="p">[</span><span class="s1">&#39;obs_data_product&#39;</span><span class="p">]</span>
        <span class="n">data_product_optimal</span> <span class="o">=</span> <span class="s1">&#39;COE&#39;</span>
        <span class="n">dataFileNames</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dataFiles</span>
        <span class="n">dataFileNameNew</span> <span class="o">=</span> <span class="p">[</span><span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">data_product</span><span class="p">,</span>
                           <span class="n">data_product_optimal</span><span class="p">)</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">dataFileNames</span><span class="p">]</span>

        <span class="n">target_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset_parameters</span><span class="p">[</span><span class="s1">&#39;obs_target_name&#39;</span><span class="p">]</span>
        <span class="n">observation_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset_parameters</span><span class="p">[</span><span class="s1">&#39;obs_path&#39;</span><span class="p">]</span>
        <span class="n">instrument_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset_parameters</span><span class="p">[</span><span class="s1">&#39;inst_inst_name&#39;</span><span class="p">]</span>
        <span class="n">path_to_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">observation_path</span><span class="p">,</span>
                                     <span class="n">instrument_name</span><span class="p">,</span>
                                     <span class="n">target_name</span><span class="p">,</span>
                                     <span class="s1">&#39;SPECTRA/&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path_to_files</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">SpectralTimeSeries</span> <span class="o">=</span> \
            <span class="n">SpectralDataTimeSeries</span><span class="p">(</span><span class="n">wavelength</span><span class="o">=</span><span class="n">wavelength_extracted_spectrum</span><span class="p">,</span>
                                   <span class="n">wavelength_unit</span><span class="o">=</span><span class="n">wavelength_unit</span><span class="p">,</span>
                                   <span class="n">data</span><span class="o">=</span><span class="n">extracted_spectra</span><span class="p">,</span>
                                   <span class="n">data_unit</span><span class="o">=</span><span class="n">data_unit</span><span class="p">,</span>
                                   <span class="n">time</span><span class="o">=</span><span class="n">time_extracted_spectrum</span><span class="p">,</span>
                                   <span class="n">time_unit</span><span class="o">=</span><span class="n">time_unit</span><span class="p">,</span>
                                   <span class="n">uncertainty</span><span class="o">=</span><span class="n">uncertainty_extracted_spectrum</span><span class="p">,</span>
                                   <span class="n">position</span><span class="o">=</span><span class="n">position_extracted_spectrum</span><span class="p">,</span>
                                   <span class="n">position_unit</span><span class="o">=</span><span class="n">position_unit</span><span class="p">,</span>
                                   <span class="n">median_position</span><span class="o">=</span><span class="n">median_pos</span><span class="p">[</span><span class="n">inod</span><span class="p">],</span>
                                   <span class="n">time_bjd</span><span class="o">=</span><span class="n">time_bjd_extracted_spectrum</span><span class="p">,</span>
                                   <span class="n">time_bjd_unit</span><span class="o">=</span><span class="n">time_bjd_unit</span><span class="p">,</span>
                                   <span class="n">target_name</span><span class="o">=</span><span class="n">target_name</span><span class="p">,</span>
                                   <span class="n">isRampFitted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">isNodded</span><span class="o">=</span><span class="n">isNodded</span><span class="p">,</span>
                                   <span class="n">dataFiles</span><span class="o">=</span><span class="n">dataFileNameNew</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">extraction_profile</span> <span class="o">=</span> <span class="n">extraction_profile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">extraction_profile_mask</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">observation</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">observation</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset_optimal_extracted</span> <span class="o">=</span> <span class="n">SpectralTimeSeries</span>

        <span class="n">write_timeseries_to_fits</span><span class="p">(</span><span class="n">SpectralTimeSeries</span><span class="p">,</span> <span class="n">path_to_files</span><span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="TSOSuite.select_regressors"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite.select_regressors">[docs]</a>    <span class="k">def</span> <span class="nf">select_regressors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select pixels which will be used as regressors.</span>

<span class="sd">        Output:</span>
<span class="sd">        -------</span>
<span class="sd">        List of regressors, using the following list index:</span>
<span class="sd">            first index: [# nod]</span>
<span class="sd">            second index: [# valid pixel in extraction mask]</span>
<span class="sd">            third index: [0=pixel coord; 1=list of regressors]</span>
<span class="sd">            forth index: [0=coordinate wave direction;</span>
<span class="sd">                          1=coordinate spatial direction]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">spectral_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">spectral_trace</span>
            <span class="n">median_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">median_position</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No spectral trace or source position </span><span class="se">\</span>
<span class="s2">                                 found. Aborting setting regressors&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No Valid data found. </span><span class="se">\</span>
<span class="s2">                                 Aborting setting regressors&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ExtractionMask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">extraction_mask</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No extraction mask found. </span><span class="se">\</span>
<span class="s2">                                 Aborting setting regressors&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">DeltaPix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cpm_deltapix</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;The exclusion region is not defined. </span><span class="se">\</span>
<span class="s2">                                 Check the initialiation of the TSO object. </span><span class="se">\</span>
<span class="s2">                                 Aborting setting regressors&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nrebin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cpm_nrebin</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;The rebin factor regressors is not defined. </span><span class="se">\</span>
<span class="s2">                                 Check the initialiation of the TSO object. </span><span class="se">\</span>
<span class="s2">                                 Aborting setting regressors&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cpm_use_pca</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cpm_use_pca</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Use PCA switch not defined. &quot;</span>
                          <span class="s2">&quot;Assuming direct regression model&quot;</span><span class="p">)</span>
            <span class="n">cpm_use_pca</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">dim</span> <span class="o">=</span> <span class="n">data_in</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">regressor_list_nod</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">extracton_mask</span> <span class="ow">in</span> <span class="n">ExtractionMask</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">extracton_mask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">extracton_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">extracton_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># all pixels of interest defined by the extraction mask</span>
            <span class="n">idx_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">extracton_mask</span><span class="p">))</span>
            <span class="c1"># index in wavelength and spatial direction for pixels of interest</span>
            <span class="n">idx_all_wave</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">][:])</span>
            <span class="n">idx_all_spatial</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_pixels</span><span class="p">[</span><span class="mi">1</span><span class="p">][:])</span>

            <span class="c1"># index of all pixels in the wavelength direction</span>
            <span class="n">idx_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">regressor_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># loop over all not masked data in the extraction window</span>
            <span class="k">for</span> <span class="n">il</span><span class="p">,</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">idx_all_wave</span><span class="p">,</span> <span class="n">idx_all_spatial</span><span class="p">):</span>

                <span class="c1"># define wavelength range to use for calibration</span>
                <span class="n">il_cal_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">il</span><span class="o">-</span><span class="n">DeltaPix</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">il_cal_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">il</span><span class="o">+</span><span class="n">DeltaPix</span><span class="p">,</span> <span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">cpm_use_pca</span><span class="p">:</span>
                    <span class="n">idx_select</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">idx_all_wave</span> <span class="o">&lt;</span> <span class="n">il_cal_min</span><span class="p">)</span> <span class="o">|</span>
                                          <span class="p">(</span><span class="n">idx_all_wave</span> <span class="o">&gt;</span> <span class="n">il_cal_max</span><span class="p">)))</span>
                    <span class="n">regressor_list</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">),</span>
                                           <span class="p">(</span><span class="n">idx_all_wave</span><span class="p">[</span><span class="n">idx_select</span><span class="p">],</span>
                                            <span class="n">idx_all_spatial</span><span class="p">[</span><span class="n">idx_select</span><span class="p">])])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">idx_cal</span> <span class="o">=</span> <span class="n">idx_all</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">idx_all</span> <span class="o">&lt;</span> <span class="n">il_cal_min</span><span class="p">)</span> <span class="o">|</span>
                                                <span class="p">(</span><span class="n">idx_all</span> <span class="o">&gt;</span> <span class="n">il_cal_max</span><span class="p">)))]</span>

                    <span class="c1"># trace at source position</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">spectral_trace</span> <span class="o">+</span>
                                    <span class="n">median_position</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">trace</span> <span class="o">-</span> <span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="n">il</span><span class="p">]</span> <span class="o">-</span> <span class="n">ir</span><span class="p">)</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">trace</span><span class="p">[</span><span class="n">idx_cal</span><span class="p">]</span>

                    <span class="c1"># get all pixels following trace within Extraction Aperture</span>
                    <span class="n">index_in_aperture</span> <span class="o">=</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">extracton_mask</span><span class="p">[</span><span class="n">idx_cal</span><span class="p">,</span> <span class="n">trace</span><span class="p">])</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">trace</span><span class="p">[</span><span class="n">index_in_aperture</span><span class="p">]</span>
                    <span class="n">idx_cal</span> <span class="o">=</span> <span class="n">idx_cal</span><span class="p">[</span><span class="n">index_in_aperture</span><span class="p">]</span>

                    <span class="c1"># check if number of calibration pixels can be rebinned</span>
                    <span class="c1"># by factor nrebin</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_cal</span><span class="p">)</span> <span class="o">%</span> <span class="n">nrebin</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ncut</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_cal</span><span class="p">)</span> <span class="o">%</span> <span class="n">nrebin</span><span class="p">)</span>
                        <span class="n">idx_cal</span> <span class="o">=</span> <span class="n">idx_cal</span><span class="p">[:</span><span class="n">ncut</span><span class="p">]</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">trace</span><span class="p">[:</span><span class="n">ncut</span><span class="p">]</span>

                    <span class="n">regressor_list</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">),</span> <span class="p">(</span><span class="n">idx_cal</span><span class="p">,</span> <span class="n">trace</span><span class="p">)])</span>

            <span class="n">regressor_list_nod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">regressor_list</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">regressor_list</span> <span class="o">=</span> <span class="n">regressor_list_nod</span></div>

<div class="viewcode-block" id="TSOSuite.get_design_matrix"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite.get_design_matrix">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_design_matrix</span><span class="p">(</span><span class="n">cleaned_data_in</span><span class="p">,</span> <span class="n">original_mask_in</span><span class="p">,</span>
                          <span class="n">regressor_selection</span><span class="p">,</span> <span class="n">nrebin</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">clip_pctl_time</span><span class="o">=</span><span class="mf">0.00</span><span class="p">,</span> <span class="n">clip_pctl_regressors</span><span class="o">=</span><span class="mf">0.00</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the design matrix based on the data set itself</span>

<span class="sd">        Input:</span>
<span class="sd">        ------</span>
<span class="sd">            cleaned_data_in</span>
<span class="sd">                time series data with bad pixels corrected</span>
<span class="sd">            original_mask_in</span>
<span class="sd">                data mask before cleaning</span>
<span class="sd">            regressor_selection</span>
<span class="sd">            nrebin</span>
<span class="sd">            clip</span>
<span class="sd">            clip_pctl_time</span>
<span class="sd">            clip_pctl_regressors</span>

<span class="sd">        Output:</span>
<span class="sd">        ------</span>
<span class="sd">            Design Matirx</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="n">cleaned_data_in</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">data_unit</span> <span class="o">=</span> <span class="n">cleaned_data_in</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">unit</span>
        <span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">),</span> <span class="p">(</span><span class="n">idx_cal</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span> <span class="o">=</span> <span class="n">regressor_selection</span>
        <span class="n">ncal</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_cal</span><span class="p">)</span>
        <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">cleaned_data_in</span><span class="p">[</span><span class="n">idx_cal</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">original_mask_design_matrix</span> <span class="o">=</span> \
            <span class="n">original_mask_in</span><span class="p">[</span><span class="n">idx_cal</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">clip</span><span class="p">:</span>
            <span class="c1"># clip the worst data along time axis</span>
            <span class="c1"># number of good measurements at a given time</span>
            <span class="n">number_of_bad_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">original_mask_design_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">idx_bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">number_of_bad_data</span><span class="p">)</span>
            <span class="n">nclip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">clip_pctl_time</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nclip</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">idx_clip_time</span> <span class="o">=</span> <span class="n">idx_bad</span><span class="p">[</span><span class="o">-</span><span class="n">nclip</span><span class="p">:]</span>
                <span class="n">design_matrix</span><span class="o">.</span><span class="n">mask</span><span class="p">[:,</span> <span class="n">idx_clip_time</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># clip the worst regressors</span>
            <span class="c1"># number of good measurements for regressor.</span>
            <span class="n">number_of_bad_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">original_mask_design_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">idx_bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">number_of_bad_data</span><span class="p">)</span>
            <span class="n">nclip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">clip_pctl_regressors</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nclip</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">idx_clip_regressor</span> <span class="o">=</span> <span class="n">idx_bad</span><span class="p">[</span><span class="o">-</span><span class="n">nclip</span><span class="p">:]</span>
                <span class="n">design_matrix</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">idx_clip_regressor</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ncal</span><span class="o">//</span><span class="n">nrebin</span><span class="p">,</span> <span class="n">nrebin</span><span class="p">,</span> <span class="n">dim</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)),</span>
                                     <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">data</span><span class="o">*</span><span class="n">data_unit</span><span class="p">,</span>
                                    <span class="n">mask</span><span class="o">=</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">design_matrix</span></div>

<div class="viewcode-block" id="TSOSuite.reshape_data"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite.reshape_data">[docs]</a>    <span class="k">def</span> <span class="nf">reshape_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_in</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reshape the time series data to a uniform dimentional shape</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_in</span><span class="p">:</span>
                <span class="n">dim</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">ndim</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span>
                <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">data_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">data_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                                             <span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data_out</span> <span class="o">=</span> <span class="n">data</span>
                <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_out</span><span class="p">)</span>
            <span class="n">data_out</span> <span class="o">=</span> <span class="n">data_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">data_in</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">ndim</span> <span class="o">=</span> <span class="n">data_in</span><span class="o">.</span><span class="n">ndim</span>
            <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">data_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">data_in</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">data_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data_in</span><span class="p">,</span>
                                         <span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_out</span> <span class="o">=</span> <span class="n">data_in</span>
        <span class="k">return</span> <span class="n">data_out</span></div>

<div class="viewcode-block" id="TSOSuite.return_all_design_matrices"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite.return_all_design_matrices">[docs]</a>    <span class="k">def</span> <span class="nf">return_all_design_matrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">clip_pctl_time</span><span class="o">=</span><span class="mf">0.00</span><span class="p">,</span>
                                   <span class="n">clip_pctl_regressors</span><span class="o">=</span><span class="mf">0.00</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup the regression matrix based on the sub set of the data slected</span>
<span class="sd">        to be used as calibrators.</span>

<span class="sd">        Output:</span>
<span class="sd">        -------</span>
<span class="sd">        list with design matrici with the following index convention:</span>
<span class="sd">               first index: [# nods]</span>
<span class="sd">               second index : [# of valid pixels within extraction mask]</span>
<span class="sd">               third index : [0]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span>
            <span class="n">cleaned_data_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">cleaned_data</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No Valid data found. </span><span class="se">\</span>
<span class="s2">                                 Aborting setting up of regression matrix&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">regressor_list_nods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">regressor_list</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No regressor selection list found. </span><span class="se">\</span>
<span class="s2">                                 Aborting setting up of regression matrix&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nrebin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cpm_nrebin</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;The rebin factor regressors is not defined. </span><span class="se">\</span>
<span class="s2">                                 Check the initialiation of the TSO object. </span><span class="se">\</span>
<span class="s2">                                 Aborting setting regressors&quot;</span><span class="p">)</span>

        <span class="n">original_mask_data_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reshape_data</span><span class="p">(</span><span class="n">data_in</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span>
        <span class="n">data_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reshape_data</span><span class="p">(</span><span class="n">cleaned_data_in</span><span class="p">)</span>
        <span class="n">design_matrix_list_nod</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">regressor_list</span> <span class="ow">in</span> <span class="n">regressor_list_nods</span><span class="p">:</span>
            <span class="n">design_matrix_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">regressor_selection</span> <span class="ow">in</span> <span class="n">regressor_list</span><span class="p">:</span>
                <span class="n">regressor_matrix</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_design_matrix</span><span class="p">(</span>
                            <span class="n">data_use</span><span class="p">,</span> <span class="n">original_mask_data_use</span><span class="p">,</span>
                            <span class="n">regressor_selection</span><span class="p">,</span>
                            <span class="n">nrebin</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span>
                            <span class="n">clip_pctl_time</span><span class="o">=</span><span class="n">clip_pctl_time</span><span class="p">,</span>
                            <span class="n">clip_pctl_regressors</span><span class="o">=</span><span class="n">clip_pctl_regressors</span><span class="p">)</span>
                <span class="n">design_matrix_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">regressor_matrix</span><span class="p">])</span>
            <span class="n">design_matrix_list_nod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">design_matrix_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">design_matrix</span> <span class="o">=</span> <span class="n">design_matrix_list_nod</span></div>

<div class="viewcode-block" id="TSOSuite.calibrate_timeseries"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite.calibrate_timeseries">[docs]</a>    <span class="k">def</span> <span class="nf">calibrate_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calibrate the ligth curve data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span>
            <span class="n">data_in_clean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">cleaned_data</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No Valid data found. </span><span class="se">\</span>
<span class="s2">                                 Aborting time series calibration&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">regressor_list_nods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">regressor_list</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No regressor selection list found. </span><span class="se">\</span>
<span class="s2">                                 Aborting time series calibration&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ExtractionMask_nods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">extraction_mask</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No extraction mask found. </span><span class="se">\</span>
<span class="s2">                                 Aborting time series calibration&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nrebin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cpm_nrebin</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;The rebin factor regressors is not defined. </span><span class="se">\</span>
<span class="s2">                                 Check the initialiation of the TSO object. </span><span class="se">\</span>
<span class="s2">                                 Aborting time series calibration&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">add_time</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cpm_add_time</span><span class="p">)</span>
            <span class="n">add_position</span> <span class="o">=</span> \
                <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cpm_add_postition</span><span class="p">)</span>
            <span class="n">add_calibration_signal</span> <span class="o">=</span> \
                <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span>
                                 <span class="n">cpm_add_calibration_signal</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;The switches for aditional regression </span><span class="se">\</span>
<span class="s2">                                 parameters are not defined. </span><span class="se">\</span>
<span class="s2">                                 Check the initialiation of the TSO object. </span><span class="se">\</span>
<span class="s2">                                 Aborting time series calibration&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">position</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No source position found </span><span class="se">\</span>
<span class="s2">                                Aborting time series calibration&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">calibration_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">calibration_signal</span>
            <span class="n">calibration_signal_depth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span>
                                             <span class="n">cpm_calibration_signal_depth</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No calibration signal defined </span><span class="se">\</span>
<span class="s2">                                Aborting time series calibration&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">clip_pctl_time</span> <span class="o">=</span> \
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cpm_clip_percentile_time</span><span class="p">)</span>
            <span class="n">clip_pctl_regressors</span> <span class="o">=</span> \
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cpm_clip_percentile_regressors</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;The clipping percentiles for the cleaning </span><span class="se">\</span>
<span class="s2">                                 of the design matrix are not defined. </span><span class="se">\</span>
<span class="s2">                                 Check the initialiation of the TSO object. </span><span class="se">\</span>
<span class="s2">                                 Aborting time series calibration&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lightcurve_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">light_curve_interpolated</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No lightcurve model defined. </span><span class="se">\</span>
<span class="s2">                                 Aborting time series calibration&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cv_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cpm_cv_method</span>
            <span class="n">reg_par</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lam0&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cpm_lam0</span><span class="p">),</span>
                       <span class="s2">&quot;lam1&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cpm_lam1</span><span class="p">),</span>
                       <span class="s2">&quot;nlam&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cpm_nlam</span><span class="p">)}</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Regularization parameters not found. </span><span class="se">\</span>
<span class="s2">                                 Aborting time series calibration&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">use_pca</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cpm_use_pca</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Use PCA switch not defined. &quot;</span>
                          <span class="s2">&quot;Assuming direct regression model&quot;</span><span class="p">)</span>
            <span class="n">use_pca</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_pca</span><span class="p">:</span>
                <span class="n">add_offset</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">number_of_pca_components</span> <span class="o">=</span> \
                        <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span>
                            <span class="n">cpm_number_of_pca_components</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Number of PCA components need &quot;</span>
                                         <span class="s2">&quot;to be set when using use_pca=True. &quot;</span>
                                         <span class="s2">&quot;Aborting time series calibration&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">add_offset</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">use_pca_filter</span> <span class="o">=</span> \
               <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cpm_use_pca_filter</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Use PCA as filter switch not defined. &quot;</span>
                          <span class="s2">&quot;Assuming no filtering direct regression model&quot;</span><span class="p">)</span>
            <span class="n">use_pca_filter</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_pca_filter</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">number_of_pca_components</span> <span class="o">=</span> \
                        <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span>
                            <span class="n">cpm_number_of_pca_components</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Number of PCA components need &quot;</span>
                                         <span class="s2">&quot;to be set when using &quot;</span>
                                         <span class="s2">&quot;use_pca_filter=True. &quot;</span>
                                         <span class="s2">&quot;Aborting time series calibration&quot;</span><span class="p">)</span>

        <span class="c1"># reshape input data to general 3D shape.</span>
        <span class="n">original_mask_data_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reshape_data</span><span class="p">(</span><span class="n">data_in</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span>
        <span class="n">data_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reshape_data</span><span class="p">(</span><span class="n">data_in_clean</span><span class="p">)</span>
        <span class="n">unc_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reshape_data</span><span class="p">(</span><span class="n">data_in</span><span class="o">.</span><span class="n">uncertainty</span><span class="p">)</span>
        <span class="n">time_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reshape_data</span><span class="p">(</span><span class="n">data_in</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="n">position_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reshape_data</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
        <span class="n">lightcurve_model_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reshape_data</span><span class="p">(</span><span class="n">lightcurve_model</span><span class="p">)</span>
        <span class="n">calibration_signal_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reshape_data</span><span class="p">(</span><span class="n">calibration_signal</span><span class="p">)</span>
        <span class="n">data_unit</span> <span class="o">=</span> <span class="n">data_use</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">nlambda</span><span class="p">,</span> <span class="n">nspatial</span><span class="p">,</span> <span class="n">ntime</span> <span class="o">=</span> <span class="n">data_use</span><span class="o">.</span><span class="n">shape</span>

<span class="c1"># TEST</span>
        <span class="c1"># add_offset = True</span>

        <span class="c1"># number of additional regressors</span>
        <span class="n">nadd</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">add_offset</span><span class="p">:</span>
            <span class="n">nadd</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">add_time</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">add_offset</span><span class="p">:</span>
            <span class="n">nadd</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">add_time</span> <span class="ow">and</span> <span class="n">add_offset</span><span class="p">:</span>
            <span class="n">nadd</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">add_position</span><span class="p">:</span>
            <span class="n">nadd</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">add_calibration_signal</span><span class="p">:</span>
            <span class="n">nadd</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># all detector area used to extract signal</span>
        <span class="n">Combined_ExtractionMask</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="n">ExtractionMask_nods</span><span class="p">)</span>

        <span class="c1"># create arrays to store results</span>
        <span class="n">data_driven_image</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nlambda</span><span class="p">,</span> <span class="n">nspatial</span><span class="p">),</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                        <span class="n">mask</span><span class="o">=</span><span class="n">Combined_ExtractionMask</span><span class="p">)</span>
        <span class="n">error_data_driven_image</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nlambda</span><span class="p">,</span> <span class="n">nspatial</span><span class="p">),</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                        <span class="n">mask</span><span class="o">=</span><span class="n">Combined_ExtractionMask</span><span class="p">)</span>
        <span class="n">calibration_image</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nlambda</span><span class="p">,</span> <span class="n">nspatial</span><span class="p">),</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                        <span class="n">mask</span><span class="o">=</span><span class="n">Combined_ExtractionMask</span><span class="p">)</span>
        <span class="n">error_calibration_image</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nlambda</span><span class="p">,</span> <span class="n">nspatial</span><span class="p">),</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                        <span class="n">mask</span><span class="o">=</span><span class="n">Combined_ExtractionMask</span><span class="p">)</span>
        <span class="n">optimal_regularization_parameter</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nlambda</span><span class="p">,</span> <span class="n">nspatial</span><span class="p">),</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                        <span class="n">mask</span><span class="o">=</span><span class="n">Combined_ExtractionMask</span><span class="p">)</span>
        <span class="n">fitted_parameters</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nadd</span><span class="p">,</span> <span class="n">nlambda</span><span class="p">,</span> <span class="n">nspatial</span><span class="p">),</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                        <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">Combined_ExtractionMask</span><span class="p">,</span>
                                     <span class="p">(</span><span class="n">nadd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">error_fitted_parameters</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nadd</span><span class="p">,</span> <span class="n">nlambda</span><span class="p">,</span> <span class="n">nspatial</span><span class="p">),</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                        <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">Combined_ExtractionMask</span><span class="p">,</span>
                                     <span class="p">(</span><span class="n">nadd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">fitted_parameters_normed</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nlambda</span><span class="o">+</span><span class="n">nadd</span><span class="p">,</span> <span class="n">nlambda</span><span class="p">,</span> <span class="n">nspatial</span><span class="p">),</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                        <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">Combined_ExtractionMask</span><span class="p">,</span>
                                     <span class="p">(</span><span class="n">nlambda</span><span class="o">+</span><span class="n">nadd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">calibrated_time_series</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nlambda</span><span class="p">,</span> <span class="n">nspatial</span><span class="p">,</span> <span class="n">ntime</span><span class="p">),</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                        <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">Combined_ExtractionMask</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                     <span class="p">(</span><span class="n">ntime</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">model_time_series</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nlambda</span><span class="p">,</span> <span class="n">nspatial</span><span class="p">,</span> <span class="n">ntime</span><span class="p">),</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">*</span><span class="n">data_unit</span><span class="p">,</span>
                        <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">Combined_ExtractionMask</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                     <span class="p">(</span><span class="n">ntime</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">residual_time_series</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nlambda</span><span class="p">,</span> <span class="n">nspatial</span><span class="p">,</span> <span class="n">ntime</span><span class="p">),</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">*</span><span class="n">data_unit</span><span class="p">,</span>
                        <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">Combined_ExtractionMask</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                     <span class="p">(</span><span class="n">ntime</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">AIC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nlambda</span><span class="p">,</span> <span class="n">nspatial</span><span class="p">),</span>
                                   <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                          <span class="n">mask</span><span class="o">=</span><span class="n">Combined_ExtractionMask</span><span class="p">)</span>

        <span class="c1"># loop over nods</span>
        <span class="k">for</span> <span class="n">inod</span><span class="p">,</span> <span class="p">(</span><span class="n">ExtractionMask</span><span class="p">,</span> <span class="n">regressor_list</span><span class="p">)</span> <span class="ow">in</span> \
                <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ExtractionMask_nods</span><span class="p">,</span> <span class="n">regressor_list_nods</span><span class="p">)):</span>

            <span class="c1"># loop over pixels</span>
            <span class="c1"># regressor list contains tuples ;isting pixel indx and</span>
            <span class="c1"># the indici of the calibration pixels</span>
            <span class="n">iter_bad_reg</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">max_iter_bad_reg</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">do_iter_bad_regressor</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">iter_bad_reg</span> <span class="o">&lt;=</span> <span class="n">max_iter_bad_reg</span><span class="p">)</span> <span class="ow">and</span> <span class="n">do_iter_bad_regressor</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">regressor_selection</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">regressor_list</span><span class="p">,</span>
                                                <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">),</span> <span class="p">(</span><span class="n">idx_cal</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span> <span class="o">=</span> <span class="n">regressor_selection</span>
                    <span class="n">regressor_matrix</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">get_design_matrix</span><span class="p">(</span>
                                <span class="n">data_use</span><span class="p">,</span> <span class="n">original_mask_data_use</span><span class="p">,</span>
                                <span class="n">regressor_selection</span><span class="p">,</span>
                                <span class="n">nrebin</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">clip_pctl_time</span><span class="o">=</span><span class="n">clip_pctl_time</span><span class="p">,</span>
                                <span class="n">clip_pctl_regressors</span><span class="o">=</span><span class="n">clip_pctl_regressors</span><span class="p">)</span>
                    <span class="c1"># remove bad regressors</span>
                    <span class="n">idx_cut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">regressor_matrix</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">idx_regressors_used</span> <span class="o">=</span> <span class="n">idx_cal</span><span class="p">[</span><span class="o">~</span><span class="n">idx_cut</span><span class="p">]</span>
                    <span class="n">regressor_matrix</span> <span class="o">=</span> <span class="n">regressor_matrix</span><span class="p">[</span><span class="o">~</span><span class="n">idx_cut</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="c1"># add calibration signal to all regressors</span>
                    <span class="k">if</span> <span class="n">add_calibration_signal</span><span class="p">:</span>
                        <span class="n">temp_cal</span> <span class="o">=</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">calibration_signal_use</span><span class="p">[</span><span class="n">inod</span><span class="p">][</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="p">:],</span>
                                    <span class="p">(</span><span class="n">regressor_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="n">temp_cal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="n">temp_cal</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
                        <span class="n">regressor_matrix</span> <span class="o">=</span> <span class="n">regressor_matrix</span> <span class="o">+</span> \
                            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">regressor_matrix</span> <span class="o">*</span>
                                          <span class="n">calibration_signal_depth</span><span class="o">*</span><span class="n">temp_cal</span><span class="p">,</span>
                                          <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp_cal</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> \
                            <span class="n">regressor_matrix</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">unit</span>

                    <span class="c1"># select data (y=signal, yerr = error signal)</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">data_use</span><span class="p">[</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">y</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">original_mask_data_use</span><span class="p">[</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">yerr</span> <span class="o">=</span> <span class="n">unc_use</span><span class="p">[</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">set_fill_value</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">set_fill_value</span><span class="p">(</span><span class="n">yerr</span><span class="p">,</span> <span class="mf">1.0e8</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">add_calibration_signal</span><span class="p">:</span>
                        <span class="n">zcal</span> <span class="o">=</span> <span class="n">calibration_signal_use</span><span class="p">[</span><span class="n">inod</span><span class="p">][</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">idx_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">zcal</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
                        <span class="n">temp_ma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">calibration_signal_depth</span><span class="o">*</span><span class="n">zcal</span><span class="p">)</span>
                        <span class="n">temp_ma</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">idx_temp</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">temp_ma</span><span class="p">)</span><span class="o">*</span><span class="n">zcal</span>

                    <span class="c1"># select aditional regressors (x: orbital phase,</span>
                    <span class="c1"># z: ligthcurve model, r: source position)</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">time_use</span><span class="p">[</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">lightcurve_model_use</span><span class="p">[</span><span class="n">inod</span><span class="p">][</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">position_use</span><span class="p">[</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                    <span class="c1"># flag bad data in time and give low weight</span>
                    <span class="n">idx_bad_time</span> <span class="o">=</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">regressor_matrix</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                    <span class="n">y</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">idx_bad_time</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">yerr</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">idx_bad_time</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">set_fill_value</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">set_fill_value</span><span class="p">(</span><span class="n">yerr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="mf">1.e3</span><span class="p">)</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">yerr</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="o">**</span><span class="mi">2</span>

                    <span class="c1"># create design matrix using either the timeseries</span>
                    <span class="c1"># directly or the PCA components</span>
                    <span class="c1"># uses clean data</span>
                    <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">regressor_matrix</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">use_pca</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">use_pca_filter</span><span class="p">):</span>
                        <span class="n">RS</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">(</span><span class="n">with_scaling</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">X_scaled</span> <span class="o">=</span> <span class="n">RS</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                        <span class="n">pca</span> <span class="o">=</span> \
                            <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">number_of_pca_components</span><span class="p">,</span>
                                                     <span class="nb">len</span><span class="p">(</span><span class="n">idx_regressors_used</span><span class="p">)]</span>
                                                    <span class="p">),</span>
                                <span class="n">whiten</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">svd_solver</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
                        <span class="n">Xtransformed</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>
                        <span class="n">Xback</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">Xtransformed</span><span class="p">)</span>
                        <span class="n">Xback</span> <span class="o">=</span> <span class="n">RS</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">Xback</span><span class="p">)</span>
                        <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">Xback</span><span class="o">.</span><span class="n">T</span>
                    <span class="c1"># add other regressors: constant, time,</span>
                    <span class="c1"># position along slit, lightcure model</span>
                    <span class="k">if</span> <span class="n">add_offset</span><span class="p">:</span>
                        <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">design_matrix</span><span class="p">,</span>
                                                   <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">add_time</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">add_offset</span><span class="p">:</span>
                        <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">design_matrix</span><span class="p">,</span>
                                                   <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">x</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">add_time</span> <span class="ow">and</span> <span class="n">add_offset</span><span class="p">:</span>
                        <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">design_matrix</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">add_position</span><span class="p">:</span>
                        <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">design_matrix</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">add_calibration_signal</span><span class="p">:</span>
                        <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">design_matrix</span><span class="p">,</span> <span class="n">zcal</span><span class="p">))</span>
                    <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">design_matrix</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

                    <span class="k">if</span> <span class="n">use_pca</span><span class="p">:</span>
                        <span class="n">design_matrix_direct</span> <span class="o">=</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">additional_components</span> <span class="o">=</span> \
                            <span class="n">design_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="n">nadd</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">regressor_matrix</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span>
                        <span class="n">RS</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">(</span><span class="n">with_scaling</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">X_scaled</span> <span class="o">=</span> <span class="n">RS</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                        <span class="n">pca</span> <span class="o">=</span> \
                            <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">number_of_pca_components</span><span class="p">,</span>
                                                     <span class="nb">len</span><span class="p">(</span><span class="n">idx_regressors_used</span><span class="p">)</span>
                                                     <span class="p">]),</span>
                                <span class="n">whiten</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">svd_solver</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
                        <span class="n">Xtransformed</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>
                        <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">Xtransformed</span><span class="o">.</span><span class="n">T</span>
                        <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">design_matrix</span><span class="p">,</span>
                                                   <span class="n">additional_components</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">)):</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

                    <span class="c1"># solve linear Eq.</span>
                    <span class="n">P</span><span class="p">,</span> <span class="n">Perr</span><span class="p">,</span> <span class="n">opt_reg_par</span><span class="p">,</span> <span class="n">pc_matrix_sle</span><span class="p">,</span> <span class="n">Pnormed</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> \
                        <span class="n">solve_linear_equation</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">,</span>
                                              <span class="n">y</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span>
                                              <span class="n">cv_method</span><span class="o">=</span><span class="n">cv_method</span><span class="p">,</span>
                                              <span class="n">reg_par</span><span class="o">=</span><span class="n">reg_par</span><span class="p">,</span>
                                              <span class="n">degrees_of_freedom</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

                    <span class="c1"># store results</span>
                    <span class="n">optimal_regularization_parameter</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt_reg_par</span>
                    <span class="k">if</span> <span class="n">use_pca</span><span class="p">:</span>
                        <span class="c1"># back transform</span>
                        <span class="n">par_trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">((</span><span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="p">[:</span><span class="o">-</span><span class="n">nadd</span><span class="p">])</span>
                        <span class="n">par_trans2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">par_trans</span><span class="p">,</span> <span class="n">P</span><span class="p">[</span><span class="o">-</span><span class="n">nadd</span><span class="p">:])</span>
                        <span class="n">par_trans_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">((</span><span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                               <span class="n">P</span><span class="p">[:</span><span class="o">-</span><span class="n">nadd</span><span class="p">]</span><span class="o">+</span><span class="n">Perr</span><span class="p">[:</span><span class="o">-</span><span class="n">nadd</span><span class="p">])</span>
                        <span class="n">par_trans_err2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">par_trans_err</span><span class="p">,</span>
                                                   <span class="n">P</span><span class="p">[</span><span class="o">-</span><span class="n">nadd</span><span class="p">:]</span><span class="o">+</span><span class="n">Perr</span><span class="p">[</span><span class="o">-</span><span class="n">nadd</span><span class="p">:])</span>
                        <span class="c1"># constant offset always present as</span>
                        <span class="c1"># first additional regr.</span>
                        <span class="n">par_trans2</span><span class="p">[</span><span class="o">-</span><span class="n">nadd</span><span class="p">]</span> <span class="o">=</span> <span class="n">par_trans2</span><span class="p">[</span><span class="o">-</span><span class="n">nadd</span><span class="p">]</span> <span class="o">-</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">RS</span><span class="o">.</span><span class="n">center_</span> <span class="o">*</span> <span class="n">par_trans</span><span class="p">)</span>
                        <span class="n">par_trans_err2</span><span class="p">[</span><span class="o">-</span><span class="n">nadd</span><span class="p">]</span> <span class="o">=</span> <span class="n">par_trans_err2</span><span class="p">[</span><span class="o">-</span><span class="n">nadd</span><span class="p">]</span> <span class="o">-</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">RS</span><span class="o">.</span><span class="n">center_</span> <span class="o">*</span> <span class="n">par_trans_err</span><span class="p">)</span>
                        <span class="n">fitted_parameters</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">par_trans2</span><span class="p">[</span><span class="o">-</span><span class="n">nadd</span><span class="p">:]</span>
                        <span class="n">error_fitted_parameters</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">par_trans2</span><span class="p">[</span><span class="o">-</span><span class="n">nadd</span><span class="p">:]</span><span class="o">-</span><span class="n">par_trans_err2</span><span class="p">[</span><span class="o">-</span><span class="n">nadd</span><span class="p">:])</span>
                        <span class="n">pc_matrix</span> <span class="o">=</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">design_matrix_direct</span><span class="p">,</span>
                                                       <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                        <span class="n">fitted_parameters_normed</span><span class="o">.</span>\
                            <span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx_regressors_used</span><span class="p">,</span>
                                           <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">nadd</span><span class="p">),</span> <span class="mi">0</span><span class="p">)),</span> <span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">pc_matrix</span><span class="p">),</span> <span class="n">par_trans2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fitted_parameters</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">P</span><span class="p">)</span><span class="o">-</span><span class="n">nadd</span><span class="p">:]</span>
                        <span class="n">error_fitted_parameters</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="n">Perr</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">P</span><span class="p">)</span><span class="o">-</span><span class="n">nadd</span><span class="p">:]</span>
                        <span class="n">fitted_parameters_normed</span><span class="o">.</span>\
                            <span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx_regressors_used</span><span class="p">,</span>
                                           <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">nadd</span><span class="p">),</span> <span class="mi">0</span><span class="p">)),</span> <span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="n">Pnormed</span>

                    <span class="n">model_time_series</span><span class="p">[</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span><span class="o">*</span><span class="n">data_unit</span>
                    <span class="n">model_time_series</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="n">idx_bad_time</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">residual</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span><span class="o">*</span><span class="n">data_unit</span>
                    <span class="n">residual_time_series</span><span class="p">[</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
                    <span class="n">lnL</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="p">(</span><span class="n">residual</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">n_samples</span><span class="p">,</span> <span class="n">n_params</span> <span class="o">=</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span>
                    <span class="n">AIC</span><span class="p">[</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">akaike_info_criterion</span><span class="p">(</span><span class="n">lnL</span><span class="p">,</span> <span class="n">n_params</span><span class="p">,</span>
                                                        <span class="n">n_samples</span><span class="p">)</span>
                    <span class="c1">##################################</span>
                    <span class="c1"># calculate the spectrum!!!!!!!!!#</span>
                    <span class="c1">##################################</span>
                    <span class="c1"># Here we only need to use the fittted model not the actual</span>
                    <span class="c1"># data. First, define model fit without lightcurve model</span>
                    <span class="n">Ptemp</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">add_calibration_signal</span><span class="p">:</span>
                        <span class="n">Ptemp</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Ptemp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="c1"># Then calculate the calibrated normalized lightcurve</span>
                    <span class="c1"># for eiter eclipse or transit</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">transittype</span> <span class="o">==</span> <span class="s1">&#39;secondary&#39;</span><span class="p">:</span>
                        <span class="c1"># eclipse is normalized to stellar flux</span>
                        <span class="n">calibrated_lightcurve</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">,</span>
                                                             <span class="n">Ptemp</span><span class="p">)</span> <span class="o">/</span> \
                                                      <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># transit is normalized to flux-baseline</span>
                        <span class="c1"># outside transit</span>
                        <span class="n">calibrated_lightcurve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span> <span class="o">/</span> \
                                                <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">,</span>
                                                       <span class="n">Ptemp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span>
                    <span class="n">calibrated_lightcurve</span> <span class="o">=</span>\
                        <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">calibrated_lightcurve</span><span class="p">)</span>
                    <span class="n">calibrated_lightcurve</span><span class="o">.</span><span class="n">set_fill_value</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">calibrated_time_series</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> \
                        <span class="n">calibrated_lightcurve</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span>
                    <span class="c1"># fit again for final normalized transit/eclipse depth</span>
                    <span class="k">if</span> <span class="n">add_calibration_signal</span><span class="p">:</span>
                        <span class="n">final_lc_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">zcal</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">final_lc_model</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

                    <span class="n">P_final</span><span class="p">,</span> <span class="n">Perr_final</span><span class="p">,</span> <span class="n">opt_reg_par_final</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> \
                        <span class="n">solve_linear_equation</span><span class="p">(</span><span class="n">final_lc_model</span><span class="p">,</span>
                                              <span class="n">calibrated_lightcurve</span><span class="o">.</span><span class="n">filled</span><span class="p">(),</span>
                                              <span class="n">weights</span><span class="p">,</span>
                                              <span class="n">cv_method</span><span class="o">=</span><span class="n">cv_method</span><span class="p">,</span>
                                              <span class="n">reg_par</span><span class="o">=</span><span class="n">reg_par</span><span class="p">)</span>
                    <span class="c1"># transit/eclipse signal</span>
                    <span class="n">data_driven_image</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_final</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c1"># combine errors of lightcurve calibration and</span>
                    <span class="c1"># transit/eclipse fit</span>
                    <span class="n">error_data_driven_image</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">Perr_final</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                                <span class="p">((</span><span class="n">error_fitted_parameters</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">]</span> <span class="o">/</span>
                                  <span class="n">fitted_parameters</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">])</span> <span class="o">*</span>
                                 <span class="n">data_driven_image</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">#                        Perr[-1] / (P[-1]/P_final[-1])</span>
                    <span class="c1"># fit results to the injected calibration signal</span>
                    <span class="k">if</span> <span class="n">add_calibration_signal</span><span class="p">:</span>
                        <span class="n">calibration_image</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_final</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                        <span class="c1"># combine errors of lightcurve calibration and</span>
                        <span class="c1"># transit/eclipse fit</span>
                        <span class="n">error_calibration_image</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">Perr_final</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                                    <span class="p">((</span><span class="n">error_fitted_parameters</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">]</span> <span class="o">/</span>
                                      <span class="n">fitted_parameters</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">])</span> <span class="o">*</span>
                                     <span class="n">calibration_image</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">il</span><span class="p">,</span> <span class="n">ir</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="c1"># loop end pixels</span>
                <span class="n">idx_bad</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">AIC</span><span class="p">,</span> <span class="n">endwith</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                   <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">AIC</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">nbad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">AIC</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.00</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nbad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">iter_bad_reg</span> <span class="o">&lt;</span> <span class="n">max_iter_bad_reg</span><span class="p">):</span>
                    <span class="n">bad_reg</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">idx_bad</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">nbad</span><span class="p">],</span> <span class="n">idx_bad</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">nbad</span><span class="p">]))</span>
                    <span class="c1"># update regressor_list</span>
                    <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">regressor_selection</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">regressor_list</span><span class="p">):</span>
                        <span class="n">idx_good_reg</span> <span class="o">=</span> \
                            <span class="p">[</span><span class="ow">not</span> <span class="p">(</span><span class="n">reg_indx</span> <span class="ow">in</span> <span class="n">bad_reg</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">reg_indx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">regressor_selection</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                 <span class="n">regressor_selection</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])]</span>
                        <span class="n">regressor_list</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="p">(</span><span class="n">regressor_selection</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">idx_good_reg</span><span class="p">],</span>
                             <span class="n">regressor_selection</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">idx_good_reg</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">do_iter_bad_regressor</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># loop end nods</span>
                <span class="n">iter_bad_reg</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># end while</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calibration_results</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calibration_results</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calibration_results</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">fitted_parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calibration_results</span><span class="o">.</span><span class="n">error_parameters</span> <span class="o">=</span> <span class="n">error_fitted_parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calibration_results</span><span class="o">.</span><span class="n">fitted_parameters_normed</span> <span class="o">=</span> \
                <span class="n">fitted_parameters_normed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calibration_results</span><span class="o">.</span><span class="n">regularization</span> <span class="o">=</span> \
                <span class="n">optimal_regularization_parameter</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calibration_results</span><span class="o">.</span><span class="n">signal</span> <span class="o">=</span> <span class="n">data_driven_image</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calibration_results</span><span class="o">.</span><span class="n">error_signal</span> <span class="o">=</span> <span class="n">error_data_driven_image</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calibration_results</span><span class="o">.</span><span class="n">calibration_signal</span> <span class="o">=</span> <span class="n">calibration_image</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calibration_results</span><span class="o">.</span><span class="n">error_calibration_signal</span> <span class="o">=</span> \
                <span class="n">error_calibration_image</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calibration_results</span><span class="o">.</span><span class="n">calibrated_time_series</span> <span class="o">=</span> \
                <span class="n">calibrated_time_series</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calibration_results</span><span class="o">.</span><span class="n">model_time_series</span> <span class="o">=</span> <span class="n">model_time_series</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calibration_results</span><span class="o">.</span><span class="n">residual</span> <span class="o">=</span> <span class="n">residual_time_series</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calibration_results</span><span class="o">.</span><span class="n">aic</span> <span class="o">=</span> <span class="n">AIC</span></div>

<div class="viewcode-block" id="TSOSuite.extract_spectrum"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite.extract_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">extract_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract the planetary spectrum from the calibrated ligth curve data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">add_calibration_signal</span> <span class="o">=</span> \
                <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span>
                                 <span class="n">cpm_add_calibration_signal</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;The switch for using a calibration </span><span class="se">\</span>
<span class="s2">                                 signal is not defined. </span><span class="se">\</span>
<span class="s2">                                 Check the initialiation of the TSO object. </span><span class="se">\</span>
<span class="s2">                                 Aborting extraction of planetary spectrum&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_calibration_signal</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cal_signal_depth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span>
                                         <span class="n">cpm_calibration_signal_depth</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;The the depth of the calibration </span><span class="se">\</span>
<span class="s2">                                     signal is not defined. Check the </span><span class="se">\</span>
<span class="s2">                                     initialiation of the TSO object. </span><span class="se">\</span>
<span class="s2">                                     Aborting extraction of planetary </span><span class="se">\</span>
<span class="s2">                                     spectrum&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">calibrated_cal_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_results</span><span class="o">.</span>\
                    <span class="n">calibration_signal</span>
                <span class="n">calibrated_cal_signal_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_results</span><span class="o">.</span>\
                    <span class="n">error_calibration_signal</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;The the extracted calibration </span><span class="se">\</span>
<span class="s2">                                     signal is not defined. Check the </span><span class="se">\</span>
<span class="s2">                                     initialiation of the TSO object. </span><span class="se">\</span>
<span class="s2">                                     Aborting extraction of planetary </span><span class="se">\</span>
<span class="s2">                                     spectrum&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">calibrated_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_results</span><span class="o">.</span><span class="n">signal</span>
            <span class="n">calibrated_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_results</span><span class="o">.</span><span class="n">error_signal</span>
            <span class="n">residual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_results</span><span class="o">.</span><span class="n">residual</span>
            <span class="n">aic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_results</span><span class="o">.</span><span class="n">aic</span>
            <span class="n">par_normed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_results</span><span class="o">.</span><span class="n">fitted_parameters_normed</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No calibrated data found. </span><span class="se">\</span>
<span class="s2">                                 Aborting extraction of planetary spectrum&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">median_eclipse_depth</span> <span class="o">=</span> \
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">observations_median_signal</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No median signal depth defined. </span><span class="se">\</span>
<span class="s2">                                 Aborting extraction of planetary spectrum&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">transittype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">transittype</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Type of observaton unknown. </span><span class="se">\</span>
<span class="s2">                                 Aborting extraction of planetary spectrum&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">planet_radius</span> <span class="o">=</span> \
                <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">object_radius</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span> <span class="o">/</span>
                 <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span>
                            <span class="n">object_radius_host_star</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">))</span>
            <span class="n">planet_radius</span> <span class="o">=</span> <span class="n">planet_radius</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Planet or Stellar radius not defined. </span><span class="se">\</span>
<span class="s2">                                 Aborting extraction of planetary spectrum&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stellar_temperature</span> <span class="o">=</span> \
                <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span>
                            <span class="n">object_temperature_host_star</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">))</span>
            <span class="n">stellar_radius</span> <span class="o">=</span> \
                <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span>
                            <span class="n">object_radius_host_star</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">R_sun</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Stellar radius or temperature not defined. </span><span class="se">\</span>
<span class="s2">                                 Aborting extraction of planetary spectrum&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ramp_fitted_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">isRampFitted</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;type of data not properly set, </span><span class="se">\</span>
<span class="s2">                                 or not consistent with spectral images or </span><span class="se">\</span>
<span class="s2">                                 cubes. Aborting extraction of </span><span class="se">\</span>
<span class="s2">                                 planetary spectrum&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">extraction_weights</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">extraction_profile</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">extraction_weigths_mask</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpm</span><span class="o">.</span><span class="n">extraction_profile_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">extraction_weights</span> <span class="o">=</span> <span class="n">extraction_weights</span> <span class="o">/</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">extraction_weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">extraction_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">calibrated_error</span><span class="p">)</span>
            <span class="n">extraction_weights</span> <span class="o">=</span> <span class="n">extraction_weights</span> <span class="o">/</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">extraction_weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">extraction_weigths_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">calibrated_error</span><span class="p">)</span>

        <span class="n">calibrated_weighted_image</span> <span class="o">=</span> <span class="n">calibrated_signal</span><span class="o">/</span><span class="n">calibrated_error</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">extraction_mask</span> <span class="o">=</span> <span class="n">calibrated_signal</span><span class="o">.</span><span class="n">mask</span>

        <span class="n">ndim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">wavelength</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span>
        <span class="n">wavelength_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">wavelength</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">unit</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ramp_fitted_flag</span><span class="p">:</span>
            <span class="n">selection1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span><span class="o">*</span><span class="p">(</span><span class="n">ndim</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selection1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span><span class="o">*</span><span class="p">(</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">wavelength_image</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">wavelength</span><span class="o">.</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">selection1</span><span class="p">)],</span>
                        <span class="n">mask</span><span class="o">=</span><span class="n">extraction_mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wavelength_image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">wavelength_image</span> <span class="o">=</span> <span class="n">wavelength_image</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

        <span class="n">npix</span><span class="p">,</span> <span class="n">mpix</span> <span class="o">=</span> <span class="n">wavelength_image</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># mask_temp = np.logical_or(self.cpm.extraction_mask[0],</span>
        <span class="c1">#                               calibrated_signal.mask)</span>
        <span class="c1"># calibrated_signal.mask = mask_temp</span>
        <span class="c1"># calibrated_error.mask = mask_temp</span>
        <span class="n">weighted_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">extraction_weigths_mask</span> <span class="o">*</span>
                                    <span class="n">calibrated_signal</span> <span class="o">*</span> <span class="n">extraction_weights</span> <span class="o">/</span>
                                    <span class="n">calibrated_error</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">extraction_weigths_mask</span> <span class="o">*</span> <span class="n">extraction_weights</span> <span class="o">*</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">npix</span><span class="p">,</span> <span class="n">mpix</span><span class="p">))</span> <span class="o">/</span>
                      <span class="n">calibrated_error</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">weighted_signal_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">extraction_weigths_mask</span> <span class="o">*</span>
                                          <span class="n">extraction_weights</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">extraction_weigths_mask</span> <span class="o">*</span> <span class="n">extraction_weights</span> <span class="o">*</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">npix</span><span class="p">,</span> <span class="n">mpix</span><span class="p">))</span> <span class="o">/</span>
                      <span class="n">calibrated_error</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">weighted_signal_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">weighted_signal_error</span><span class="p">)</span>

        <span class="n">weighted_signal_wavelength</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">wavelength_image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">weights</span><span class="o">=</span><span class="p">(</span><span class="n">extraction_weigths_mask</span> <span class="o">*</span>
                                   <span class="n">extraction_weights</span> <span class="o">*</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">npix</span><span class="p">,</span> <span class="n">mpix</span><span class="p">))</span> <span class="o">/</span>
                                   <span class="n">calibrated_error</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">nintegrations</span> <span class="o">=</span> <span class="n">residual</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="c1">#        residual_unit = residual.data.unit</span>
<span class="c1">#        residual_cube = np.ma.array(residual.data.value,</span>
<span class="c1">#                                    mask = residual.mask)</span>
        <span class="n">weighted_residual</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">weights</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">((</span><span class="n">extraction_weigths_mask</span> <span class="o">*</span>
                                           <span class="n">extraction_weights</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                           <span class="p">(</span><span class="n">nintegrations</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">npix</span><span class="p">,</span> <span class="n">mpix</span><span class="p">,</span> <span class="n">nintegrations</span><span class="p">))</span> <span class="o">/</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">calibrated_error</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                           <span class="p">(</span><span class="n">nintegrations</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">weighted_normed_parameters</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">par_normed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                          <span class="n">weights</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">extraction_weigths_mask</span> <span class="o">*</span>
                                           <span class="n">extraction_weights</span><span class="p">,</span>
                                           <span class="p">(</span><span class="n">par_normed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">par_normed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">calibrated_error</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                           <span class="p">(</span><span class="n">par_normed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">weighted_aic</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">aic</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="p">(</span><span class="n">extraction_weigths_mask</span> <span class="o">*</span>
                                                <span class="n">extraction_weights</span> <span class="o">*</span>
                                                <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">npix</span><span class="p">,</span> <span class="n">mpix</span><span class="p">))</span> <span class="o">/</span>
                                                <span class="n">calibrated_error</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">add_calibration_signal</span><span class="p">:</span>
            <span class="c1"># mask_temp = np.logical_or(self.cpm.extraction_mask[0],</span>
            <span class="c1">#                           calibrated_cal_signal.mask)</span>
            <span class="c1"># calibrated_cal_signal.mask = mask_temp</span>
            <span class="c1"># calibrated_cal_signal_error.mask = mask_temp</span>
            <span class="n">weighted_cal_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">calibrated_cal_signal</span> <span class="o">*</span>
                                            <span class="n">extraction_weigths_mask</span> <span class="o">*</span>
                                            <span class="n">extraction_weights</span> <span class="o">/</span>
                                            <span class="n">calibrated_cal_signal_error</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                                            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">extraction_weigths_mask</span> <span class="o">*</span> <span class="n">extraction_weights</span> <span class="o">*</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">npix</span><span class="p">,</span> <span class="n">mpix</span><span class="p">))</span> <span class="o">/</span>
                          <span class="n">calibrated_cal_signal_error</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">weighted_cal_signal_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">extraction_weigths_mask</span> <span class="o">*</span>
                                                  <span class="n">extraction_weights</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                                                  <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">extraction_weigths_mask</span> <span class="o">*</span> <span class="n">extraction_weights</span> <span class="o">*</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">npix</span><span class="p">,</span> <span class="n">mpix</span><span class="p">))</span> <span class="o">/</span>
                          <span class="n">calibrated_cal_signal_error</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">weighted_cal_signal_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">weighted_cal_signal_error</span><span class="p">)</span>

<span class="c1">#            weighted_cal_signal = \</span>
<span class="c1">#                np.ma.average(calibrated_cal_signal, axis=1,</span>
<span class="c1">#                              weights=(np.ma.ones((npix, mpix)) /</span>
<span class="c1">#                                       calibrated_cal_signal_error)**2)</span>

<span class="c1">#            weighted_cal_signal_error = np.ma.ones((npix)) / \</span>
<span class="c1">#                np.ma.sum((np.ma.ones((npix, mpix)) /</span>
<span class="c1">#                           calibrated_cal_signal_error)**2, axis=1)</span>
<span class="c1">#            weighted_cal_signal_error = np.ma.sqrt(weighted_cal_signal_error)</span>

        <span class="k">if</span> <span class="n">transittype</span> <span class="o">==</span> <span class="s1">&#39;secondary&#39;</span><span class="p">:</span>
            <span class="c1"># Eclipse</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="p">(</span><span class="n">weighted_signal</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">median_eclipse_depth</span><span class="p">)</span> <span class="o">+</span>
                        <span class="n">median_eclipse_depth</span><span class="p">)</span>
            <span class="n">error_spectrum</span> <span class="o">=</span> <span class="n">weighted_signal_error</span> <span class="o">*</span> \
                <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">median_eclipse_depth</span><span class="p">)</span>

            <span class="c1"># Calibration</span>
            <span class="k">if</span> <span class="n">add_calibration_signal</span><span class="p">:</span>
                <span class="n">scaled_weighted_cal_signal</span> <span class="o">=</span> \
                    <span class="p">(</span><span class="n">weighted_cal_signal</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="n">cal_signal_depth</span><span class="p">)</span> <span class="o">+</span>
                     <span class="n">cal_signal_depth</span><span class="p">)</span>
                <span class="n">scaled_weighted_cal_signal_error</span> <span class="o">=</span> \
                    <span class="p">(</span><span class="n">weighted_cal_signal_error</span> <span class="o">*</span>
                     <span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="n">cal_signal_depth</span><span class="p">))</span>
                <span class="n">calibration_correction</span> <span class="o">=</span> \
                    <span class="p">(</span><span class="n">median_eclipse_depth</span> <span class="o">-</span> <span class="n">median_eclipse_depth</span> <span class="o">/</span>
                     <span class="p">(</span><span class="n">scaled_weighted_cal_signal</span><span class="o">/</span><span class="n">cal_signal_depth</span><span class="p">))</span>
                <span class="n">calibration_correction_error</span> <span class="o">=</span> \
                    <span class="p">(</span><span class="n">scaled_weighted_cal_signal_error</span> <span class="o">/</span>
                     <span class="n">scaled_weighted_cal_signal</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">median_eclipse_depth</span> <span class="o">/</span>
                                                  <span class="p">(</span><span class="n">scaled_weighted_cal_signal</span> <span class="o">/</span>
                                                   <span class="n">cal_signal_depth</span><span class="p">))</span>
                <span class="n">spectrum</span> <span class="o">=</span> <span class="n">spectrum</span> <span class="o">-</span> <span class="n">calibration_correction</span>
                <span class="n">error_spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_spectrum</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                                         <span class="n">calibration_correction_error</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># transit</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="p">(</span><span class="n">weighted_signal</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">planet_radius</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
                        <span class="n">planet_radius</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">error_spectrum</span> <span class="o">=</span> <span class="n">weighted_signal_error</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">planet_radius</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Calibration</span>
            <span class="k">if</span> <span class="n">add_calibration_signal</span><span class="p">:</span>
                <span class="n">scaled_weighted_cal_signal</span> <span class="o">=</span> \
                    <span class="p">(</span><span class="n">weighted_cal_signal</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">cal_signal_depth</span><span class="p">)</span> <span class="o">+</span>
                     <span class="n">cal_signal_depth</span><span class="p">)</span>
                <span class="n">scaled_weighted_cal_signal_error</span> <span class="o">=</span> \
                    <span class="p">(</span><span class="n">weighted_cal_signal_error</span> <span class="o">*</span>
                     <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">cal_signal_depth</span><span class="p">))</span>
                <span class="n">calibration_correction</span> <span class="o">=</span> \
                    <span class="p">(</span><span class="n">planet_radius</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">planet_radius</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span>
                     <span class="p">(</span><span class="n">scaled_weighted_cal_signal</span><span class="o">/</span><span class="n">cal_signal_depth</span><span class="p">))</span>
                <span class="n">calibration_correction_error</span> <span class="o">=</span> \
                    <span class="p">(</span><span class="n">scaled_weighted_cal_signal_error</span> <span class="o">/</span>
                     <span class="n">scaled_weighted_cal_signal</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">planet_radius</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span>
                                                  <span class="p">(</span><span class="n">scaled_weighted_cal_signal</span> <span class="o">/</span>
                                                   <span class="n">cal_signal_depth</span><span class="p">))</span>
                <span class="n">spectrum</span> <span class="o">=</span> <span class="n">spectrum</span> <span class="o">-</span> <span class="n">calibration_correction</span>
                <span class="n">error_spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_spectrum</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                                         <span class="n">calibration_correction_error</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">exoplanet_spectrum</span> <span class="o">=</span> \
            <span class="n">SpectralData</span><span class="p">(</span><span class="n">wavelength</span><span class="o">=</span><span class="n">weighted_signal_wavelength</span><span class="p">,</span>
                         <span class="n">wavelength_unit</span><span class="o">=</span><span class="n">wavelength_unit</span><span class="p">,</span>
                         <span class="n">data</span><span class="o">=</span><span class="n">spectrum</span><span class="p">,</span>
                         <span class="n">uncertainty</span><span class="o">=</span><span class="n">error_spectrum</span><span class="p">,</span>
                         <span class="n">data_unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span><span class="p">)</span>
        <span class="n">exoplanet_spectrum</span><span class="o">.</span><span class="n">data_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">percent</span>
        <span class="k">if</span> <span class="n">add_calibration_signal</span><span class="p">:</span>
            <span class="n">calibration_correction_spectrum</span> <span class="o">=</span> \
                <span class="n">SpectralData</span><span class="p">(</span><span class="n">wavelength</span><span class="o">=</span><span class="n">weighted_signal_wavelength</span><span class="p">,</span>
                             <span class="n">wavelength_unit</span><span class="o">=</span><span class="n">wavelength_unit</span><span class="p">,</span>
                             <span class="n">data</span><span class="o">=</span><span class="n">calibration_correction</span><span class="p">,</span>
                             <span class="n">uncertainty</span><span class="o">=</span><span class="n">calibration_correction_error</span><span class="p">,</span>
                             <span class="n">data_unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span><span class="p">)</span>
            <span class="n">calibration_correction_spectrum</span><span class="o">.</span><span class="n">data_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">percent</span>
        <span class="k">if</span> <span class="n">transittype</span> <span class="o">==</span> <span class="s1">&#39;secondary&#39;</span><span class="p">:</span>
            <span class="n">brightness_temperature</span><span class="p">,</span> <span class="n">error_brightness_temperature</span> <span class="o">=</span> \
             <span class="n">convert_spectrum_to_brighness_temperature</span><span class="p">(</span>
                     <span class="n">exoplanet_spectrum</span><span class="o">.</span>
                     <span class="n">wavelength</span><span class="p">,</span>
                     <span class="n">exoplanet_spectrum</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                     <span class="n">stellar_temperature</span><span class="p">,</span>
                     <span class="n">stellar_radius</span><span class="p">,</span>
                     <span class="n">planet_radius</span> <span class="o">*</span>
                     <span class="n">stellar_radius</span><span class="p">,</span>
                     <span class="n">error</span><span class="o">=</span><span class="n">exoplanet_spectrum</span><span class="o">.</span><span class="n">uncertainty</span><span class="p">)</span>
            <span class="n">exoplanet_spectrum_in_brightnes_temperature</span> <span class="o">=</span> \
                <span class="n">SpectralData</span><span class="p">(</span><span class="n">wavelength</span><span class="o">=</span><span class="n">exoplanet_spectrum</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span>
                             <span class="n">wavelength_unit</span><span class="o">=</span><span class="n">wavelength_unit</span><span class="p">,</span>
                             <span class="n">data</span><span class="o">=</span><span class="n">brightness_temperature</span><span class="p">,</span>
                             <span class="n">uncertainty</span><span class="o">=</span><span class="n">error_brightness_temperature</span><span class="p">)</span>
            <span class="n">exoplanet_spectrum_in_brightnes_temperature</span><span class="o">.</span><span class="n">wavelength_unit</span> <span class="o">=</span> \
                <span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="o">**-</span><span class="mi">1</span>
            <span class="n">exoplanet_spectrum_in_brightnes_temperature</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> \
                <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">exoplanet_spectrum_in_brightnes_temperature</span><span class="o">.</span>
                             <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exoplanet_spectrum</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exoplanet_spectrum</span> <span class="o">=</span> <span class="n">SimpleNamespace</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exoplanet_spectrum</span><span class="o">.</span><span class="n">weighted_image</span> <span class="o">=</span> <span class="n">calibrated_weighted_image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exoplanet_spectrum</span><span class="o">.</span><span class="n">weighted_residual</span> <span class="o">=</span> <span class="n">weighted_residual</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exoplanet_spectrum</span><span class="o">.</span><span class="n">weighted_aic</span> <span class="o">=</span> <span class="n">weighted_aic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exoplanet_spectrum</span><span class="o">.</span><span class="n">weighted_normed_parameters</span> <span class="o">=</span> \
            <span class="n">weighted_normed_parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exoplanet_spectrum</span><span class="o">.</span><span class="n">weighted_signal</span> <span class="o">=</span> <span class="n">weighted_signal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exoplanet_spectrum</span><span class="o">.</span><span class="n">spectrum</span> <span class="o">=</span> <span class="n">exoplanet_spectrum</span>
        <span class="k">if</span> <span class="n">transittype</span> <span class="o">==</span> <span class="s1">&#39;secondary&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exoplanet_spectrum</span><span class="o">.</span><span class="n">brightness_temperature</span> <span class="o">=</span> \
                <span class="n">exoplanet_spectrum_in_brightnes_temperature</span>
        <span class="k">if</span> <span class="n">add_calibration_signal</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exoplanet_spectrum</span><span class="o">.</span><span class="n">calibration_correction</span> <span class="o">=</span> \
                <span class="n">calibration_correction_spectrum</span></div>

<div class="viewcode-block" id="TSOSuite.correct_extracted_spectrum"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite.correct_extracted_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">correct_extracted_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make correction for non-uniform subtraction of transit signal due to</span>
<span class="sd">        differences in the relative weighting of the regressors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">median_eclipse_depth</span> <span class="o">=</span> \
                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">observations_median_signal</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No median signal depth defined. </span><span class="se">\</span>
<span class="s2">                                 Aborting correcting planetary spectrum&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">transittype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">transittype</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Type of observaton unknown. </span><span class="se">\</span>
<span class="s2">                                 Aborting correcting planetary spectrum&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">planet_radius</span> <span class="o">=</span> \
                <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">object_radius</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span> <span class="o">/</span>
                 <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span>
                            <span class="n">object_radius_host_star</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">))</span>
            <span class="n">planet_radius</span> <span class="o">=</span> <span class="n">planet_radius</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Planet or Stellar radius not defined. </span><span class="se">\</span>
<span class="s2">                                 Aborting correcting planetary spectrum&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exoplanet_spectrum</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No planetery spectectrum defined </span><span class="se">\</span>
<span class="s2">                                 Aborting correcting planetary spectrum&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rcond_limit</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span>
                                <span class="n">cpm_relative_sig_value_limit</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">rcond_limit</span> <span class="o">=</span> <span class="mf">1.e-2</span>

        <span class="n">ndim_reg</span><span class="p">,</span> <span class="n">ndim_lam</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">exoplanet_spectrum</span><span class="o">.</span><span class="n">weighted_normed_parameters</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">ndim_diff</span> <span class="o">=</span> <span class="n">ndim_reg</span> <span class="o">-</span> <span class="n">ndim_lam</span>
        <span class="n">W</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exoplanet_spectrum</span><span class="o">.</span>
             <span class="n">weighted_normed_parameters</span><span class="p">[:</span><span class="o">-</span><span class="n">ndim_diff</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span>
             <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exoplanet_spectrum</span><span class="o">.</span>
                       <span class="n">weighted_normed_parameters</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">W</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">K</span><span class="o">.</span><span class="n">set_fill_value</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">weighted_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exoplanet_spectrum</span><span class="o">.</span><span class="n">weighted_signal</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">weighted_signal</span><span class="o">.</span><span class="n">set_fill_value</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="k">import</span> <span class="n">RidgeCV</span>

<span class="c1">#        clf = RidgeCV(alphas=[1e-9, 1e-7, 1e-6, 1e-4, 1e-3, 1e-2, 1e-1, 1, 10],</span>
<span class="c1">#                      gcv_mode=&#39;svd&#39;,</span>
<span class="c1">#                      cv=5,</span>
<span class="c1">#                      fit_intercept=False).fit(K.filled(),</span>
<span class="c1">#                                               weighted_signal.filled())</span>
<span class="c1">#        corrected_spectrum = clf.predict(K.filled())</span>
<span class="c1">#        corrected_spectrum = np.linalg.lstsq(K.filled(),</span>
<span class="c1">#                                             -weighted_signal.filled(),</span>
<span class="c1">#                                             rcond=rcond_limit)[0]</span>
        <span class="n">corrected_spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pinv2</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">filled</span><span class="p">(),</span> <span class="n">rcond</span><span class="o">=</span><span class="n">rcond_limit</span><span class="p">),</span>
                                    <span class="o">-</span><span class="n">weighted_signal</span><span class="o">.</span><span class="n">filled</span><span class="p">())</span>
        <span class="n">corrected_spectrum</span> <span class="o">=</span> <span class="n">corrected_spectrum</span> <span class="o">-</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">corrected_spectrum</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">transittype</span> <span class="o">==</span> <span class="s1">&#39;secondary&#39;</span><span class="p">:</span>
            <span class="c1"># eclipse</span>
            <span class="n">corrected_spectrum</span> <span class="o">=</span> <span class="p">(</span><span class="n">corrected_spectrum</span> <span class="o">*</span>
                                  <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">median_eclipse_depth</span><span class="p">)</span> <span class="o">+</span>
                                  <span class="n">median_eclipse_depth</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># transit</span>
            <span class="n">corrected_spectrum</span> <span class="o">=</span> <span class="p">(</span><span class="n">corrected_spectrum</span> <span class="o">*</span>
                                  <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">planet_radius</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
                                  <span class="n">planet_radius</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">corrected_exoplanet_spectrum</span> <span class="o">=</span> \
            <span class="n">SpectralData</span><span class="p">(</span><span class="n">wavelength</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span>
                         <span class="n">wavelength_unit</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">wavelength_unit</span><span class="p">,</span>
                         <span class="n">data</span><span class="o">=</span><span class="n">corrected_spectrum</span><span class="p">,</span>
                         <span class="n">uncertainty</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">uncertainty</span><span class="p">,</span>
                         <span class="n">data_unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span><span class="p">,</span>
                         <span class="n">mask</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">corrected_exoplanet_spectrum</span><span class="o">.</span><span class="n">data_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">percent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exoplanet_spectrum</span><span class="o">.</span><span class="n">corrected_spectrum</span> <span class="o">=</span> \
            <span class="n">corrected_exoplanet_spectrum</span></div>

<div class="viewcode-block" id="TSOSuite.save_results"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite.save_results">[docs]</a>    <span class="k">def</span> <span class="nf">save_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">transittype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">transittype</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Type of observaton unknown. </span><span class="se">\</span>
<span class="s2">                                 Aborting saving results&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exoplanet_spectrum</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No results defined </span><span class="se">\</span>
<span class="s2">                                 Aborting saving results&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cascade_save_path</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No save path defined</span><span class="se">\</span>
<span class="s2">                                 Aborting saving results&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">observations_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">observations_id</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No uniq id defined for observation </span><span class="se">\</span>
<span class="s2">                                 Aborting saving results&quot;</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">MaskedColumn</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span>
                           <span class="n">unit</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">wavelength_unit</span><span class="p">,</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Wavelength&#39;</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">MaskedColumn</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                           <span class="n">unit</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">data_unit</span><span class="p">,</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Flux&#39;</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">MaskedColumn</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">uncertainty</span><span class="p">,</span>
                           <span class="n">unit</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">data_unit</span><span class="p">,</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">save_path</span><span class="o">+</span><span class="n">observations_id</span><span class="o">+</span><span class="s1">&#39;_exoplanet_spectra.fits&#39;</span><span class="p">,</span>
                <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">MaskedColumn</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">corrected_spectrum</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span>
                               <span class="n">unit</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">corrected_spectrum</span><span class="o">.</span><span class="n">wavelength_unit</span><span class="p">,</span>
                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Wavelength&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">MaskedColumn</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">corrected_spectrum</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                               <span class="n">unit</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">corrected_spectrum</span><span class="o">.</span><span class="n">data_unit</span><span class="p">,</span>
                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Flux&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">MaskedColumn</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">corrected_spectrum</span><span class="o">.</span><span class="n">uncertainty</span><span class="p">,</span>
                               <span class="n">unit</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">corrected_spectrum</span><span class="o">.</span><span class="n">data_unit</span><span class="p">,</span>
                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">save_path</span><span class="o">+</span><span class="n">observations_id</span> <span class="o">+</span>
                    <span class="s1">&#39;_corrected_exoplanet_spectra.fits&#39;</span><span class="p">,</span>
                    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">transittype</span> <span class="o">==</span> <span class="s1">&#39;secondary&#39;</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">MaskedColumn</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">brightness_temperature</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span>
                               <span class="n">unit</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">brightness_temperature</span><span class="o">.</span>
                               <span class="n">wavelength_unit</span><span class="p">,</span>
                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Wavelength&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">MaskedColumn</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">brightness_temperature</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                               <span class="n">unit</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">brightness_temperature</span><span class="o">.</span><span class="n">data_unit</span><span class="p">,</span>
                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Flux&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">MaskedColumn</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">brightness_temperature</span><span class="o">.</span><span class="n">uncertainty</span><span class="p">,</span>
                               <span class="n">unit</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">brightness_temperature</span><span class="o">.</span><span class="n">data_unit</span><span class="p">,</span>
                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">save_path</span><span class="o">+</span><span class="n">observations_id</span> <span class="o">+</span>
                    <span class="s1">&#39;_exoplanet_brightness_temperature.fits&#39;</span><span class="p">,</span>
                    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="TSOSuite.plot_results"><a class="viewcode-back" href="../../../cascade.TSO.html#cascade.TSO.TSO.TSOSuite.plot_results">[docs]</a>    <span class="k">def</span> <span class="nf">plot_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the extracted planetary spectrum and scaled signal on the</span>
<span class="sd">        detector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exoplanet_spectrum</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No results defined </span><span class="se">\</span>
<span class="s2">                                 Aborting plotting results&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">cascade_save_path</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No save path defined</span><span class="se">\</span>
<span class="s2">                                 Aborting plotting results&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">observations_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">observations_id</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No uniq id defined for observation </span><span class="se">\</span>
<span class="s2">                                 Aborting plotting results&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">add_calibration_signal</span> <span class="o">=</span> \
                <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span>
                                 <span class="n">cpm_add_calibration_signal</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;The switch for using a calibration </span><span class="se">\</span>
<span class="s2">                                 signal is not defined. </span><span class="se">\</span>
<span class="s2">                                 Check the initialiation of the TSO object. </span><span class="se">\</span>
<span class="s2">                                 Aborting plotting results&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">median_eclipse_depth</span> <span class="o">=</span> \
                <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cascade_parameters</span><span class="o">.</span><span class="n">observations_median_signal</span><span class="p">)</span> <span class="o">*</span>
                 <span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">percent</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No median signal depth defined. </span><span class="se">\</span>
<span class="s2">                                 Aborting plotting results&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">transittype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">transittype</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Type of observaton unknown. </span><span class="se">\</span>
<span class="s2">                                 Aborting plotting results&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">dataset</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No dataset found. &quot;</span>
                                 <span class="s2">&quot;Aborting plotting results&quot;</span><span class="p">)</span>

        <span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s2">&quot;talk&quot;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;lines.linewidth&quot;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">})</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;xtick.bottom&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;ytick.left&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">residual_time_series</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">exoplanet_spectrum</span><span class="o">.</span><span class="n">weighted_residual</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No weighted residual data found. &quot;</span>
                                 <span class="s2">&quot;Aborting plotting results&quot;</span><span class="p">)</span>
        <span class="n">residual_unit</span> <span class="o">=</span> <span class="n">residual_time_series</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">image_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">residual_time_series</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                <span class="n">mask</span><span class="o">=</span><span class="n">residual_time_series</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">image_res</span><span class="o">.</span><span class="n">set_fill_value</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">image_res</span> <span class="o">=</span> <span class="n">image_res</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
        <span class="n">wave0</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">wavelength</span>
        <span class="n">wavelength_unit</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">wavelength_unit</span>
        <span class="n">wave0_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">wave0</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span>
        <span class="n">wave0_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">wave0</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">([</span><span class="n">ax</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">+</span>
                     <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
            <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_res</span><span class="p">,</span>
                      <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
                      <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">,</span>
                      <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                      <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                      <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">image_res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">wave0_min</span><span class="p">,</span> <span class="n">wave0_max</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Residual (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">residual_unit</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Integration Number&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Wavelength [</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wavelength_unit</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residual Image&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="o">+</span><span class="n">observations_id</span><span class="o">+</span><span class="s1">&#39;_residual_signal.png&#39;</span><span class="p">,</span>
                    <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">weighted_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="c1">#            for item in ([ax.title, ax.xaxis.label, ax.yaxis.label] +</span>
<span class="c1">#                         ax.get_xticklabels() + ax.get_yticklabels()):</span>
<span class="c1">#                item.set_fontsize(20)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">weighted_image</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;| Signal * weight |&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength [</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="o">.</span>
                                                   <span class="n">spectrum</span><span class="o">.</span><span class="n">wavelength_unit</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="c1">#            for item in ([ax.title, ax.xaxis.label, ax.yaxis.label] +</span>
<span class="c1">#                         ax.get_xticklabels() + ax.get_yticklabels()):</span>
<span class="c1">#                item.set_fontsize(20)</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_heat</span>
            <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">weighted_image</span><span class="p">),</span>
                          <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                          <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;&#39;| Signal * weight |&#39;&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel Number Spatial Direction&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pixel Number Wavelength Direction&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="o">+</span><span class="n">observations_id</span><span class="o">+</span><span class="s1">&#39;_weighted_signal.png&#39;</span><span class="p">,</span>
                    <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

        <span class="c1"># BUG FIX as errorbar does not support quantaties.</span>
        <span class="c1"># also the calculations with masked quantities ,</span>
        <span class="c1"># like subtraction of a constant quantity can lead to wrong results</span>
        <span class="n">err_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">uncertainty</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                               <span class="n">mask</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">uncertainty</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">wav_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">wavelength</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                               <span class="n">mask</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">wavelength</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">flux_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                <span class="n">mask</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wav_temp_corrected</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">corrected_spectrum</span><span class="o">.</span><span class="n">wavelength</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">mask</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">corrected_spectrum</span><span class="o">.</span><span class="n">wavelength</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">flux_temp_corrected</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">corrected_spectrum</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">mask</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">corrected_spectrum</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">err_temp_correced</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">corrected_spectrum</span><span class="o">.</span><span class="n">uncertainty</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">mask</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">corrected_spectrum</span><span class="o">.</span><span class="n">uncertainty</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
<span class="c1">#        with quantity_support():</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="c1">#        for item in ([ax.title, ax.xaxis.label, ax.yaxis.label] +</span>
<span class="c1">#                     ax.get_xticklabels() + ax.get_yticklabels()):</span>
<span class="c1">#            item.set_fontsize(20)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wav_temp</span><span class="p">,</span> <span class="n">flux_temp</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">err_temp</span><span class="p">,</span>
                    <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.k&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
                    <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
                    <span class="n">fillstyle</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Not-Corrected&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wav_temp_corrected</span><span class="p">,</span> <span class="n">flux_temp_corrected</span><span class="p">,</span>
                    <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wav_temp_corrected</span><span class="p">,</span> <span class="n">flux_temp_corrected</span><span class="p">,</span>
                        <span class="n">yerr</span><span class="o">=</span><span class="n">err_temp_correced</span><span class="p">,</span>
                        <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.k&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                        <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span>
                        <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span>
                        <span class="n">fillstyle</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Corrected&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mf">0.95</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">wav_temp</span><span class="p">),</span> <span class="mf">1.05</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">wav_temp</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">transittype</span> <span class="o">==</span> <span class="s1">&#39;secondary&#39;</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux_temp</span><span class="p">)])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Fplanet/Fstar [</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="o">.</span>
                          <span class="n">spectrum</span><span class="o">.</span><span class="n">data_unit</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux_temp</span><span class="p">)</span><span class="o">/</span><span class="mf">1.2</span><span class="p">,</span>
                           <span class="mf">1.2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux_temp</span><span class="p">)])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Transit Depth [</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="o">.</span>
                          <span class="n">spectrum</span><span class="o">.</span><span class="n">data_unit</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength [</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="o">.</span>
                      <span class="n">spectrum</span><span class="o">.</span><span class="n">wavelength_unit</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">,</span> <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                  <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;expand&quot;</span><span class="p">,</span>
                  <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">handleheight</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">labelspacing</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                  <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="o">+</span><span class="n">observations_id</span><span class="o">+</span><span class="s1">&#39;_exoplanet_spectra.png&#39;</span><span class="p">,</span>
                    <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">transittype</span> <span class="o">==</span> <span class="s1">&#39;secondary&#39;</span><span class="p">:</span>
            <span class="c1"># BUG FIX as errorbar does not support quantaties.</span>
            <span class="c1"># also the calculations with masked quantities ,</span>
            <span class="c1"># like subtraction of a constant quantity can lead to wrong results</span>
            <span class="n">err_bt_temp</span> <span class="o">=</span> \
             <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">brightness_temperature</span><span class="o">.</span><span class="n">uncertainty</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                         <span class="n">mask</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">brightness_temperature</span><span class="o">.</span><span class="n">uncertainty</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">wav_bt_temp</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">brightness_temperature</span><span class="o">.</span>
                            <span class="n">wavelength</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">mask</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">brightness_temperature</span><span class="o">.</span>
                            <span class="n">wavelength</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">flux_bt_temp</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">brightness_temperature</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">mask</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">brightness_temperature</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>

            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="c1">#            for item in ([ax.title, ax.xaxis.label, ax.yaxis.label] +</span>
<span class="c1">#                         ax.get_xticklabels() + ax.get_yticklabels()):</span>
<span class="c1">#                item.set_fontsize(20)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">brightness_temperature</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">brightness_temperature</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                    <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wav_bt_temp</span><span class="p">,</span> <span class="n">flux_bt_temp</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">err_bt_temp</span><span class="p">,</span>
                        <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.k&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                        <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
                        <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
                        <span class="n">fillstyle</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mf">0.95</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">wav_bt_temp</span><span class="p">),</span>
                           <span class="mf">1.05</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">wav_bt_temp</span><span class="p">)])</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux_bt_temp</span><span class="p">)</span><span class="o">/</span><span class="mf">1.5</span><span class="p">,</span>
                           <span class="mf">1.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux_bt_temp</span><span class="p">)])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ScalarFormatter</span><span class="p">())</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Brightness Temperature [</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="o">.</span>
                          <span class="n">brightness_temperature</span><span class="o">.</span><span class="n">data_unit</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength [</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="o">.</span>
                          <span class="n">brightness_temperature</span><span class="o">.</span><span class="n">wavelength_unit</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="o">+</span><span class="n">observations_id</span> <span class="o">+</span>
                        <span class="s1">&#39;_exoplanet_brightness_temperature.png&#39;</span><span class="p">,</span>
                        <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">add_calibration_signal</span><span class="p">:</span>
            <span class="c1"># Bug FIX for errorbar not having quantity support</span>
            <span class="n">wav_corr_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">calibration_correction</span><span class="o">.</span>
                                        <span class="n">wavelength</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">results</span><span class="o">.</span>
                                        <span class="n">calibration_correction</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">cal_corr_temp</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">calibration_correction</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">mask</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">calibration_correction</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">error_corr_temp</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">calibration_correction</span><span class="o">.</span><span class="n">uncertainty</span><span class="o">.</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">mask</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">calibration_correction</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>

            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="c1">#            for item in ([ax.title, ax.xaxis.label, ax.yaxis.label] +</span>
<span class="c1">#                         ax.get_xticklabels() + ax.get_yticklabels()):</span>
<span class="c1">#                item.set_fontsize(20)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">calibration_correction</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">calibration_correction</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wav_corr_temp</span><span class="p">,</span> <span class="n">cal_corr_temp</span><span class="p">,</span>
                        <span class="n">yerr</span><span class="o">=</span><span class="n">error_corr_temp</span><span class="p">)</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mf">0.95</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">wav_corr_temp</span><span class="p">),</span>
                          <span class="mf">1.05</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">wav_corr_temp</span><span class="p">)])</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux_temp</span><span class="p">),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flux_temp</span><span class="p">)])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Calibration correction [</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="o">.</span>
                          <span class="n">calibration_correction</span><span class="o">.</span><span class="n">data_unit</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength [</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="o">.</span>
                          <span class="n">calibration_correction</span><span class="o">.</span><span class="n">wavelength_unit</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="o">+</span><span class="n">observations_id</span> <span class="o">+</span>
                        <span class="s1">&#39;_calibration_correction.png&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

            <span class="n">snr_cal</span> <span class="o">=</span> <span class="p">(</span><span class="n">median_eclipse_depth</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">cal_corr_temp</span><span class="p">)</span> <span class="o">/</span> \
                <span class="n">error_corr_temp</span>
            <span class="n">snr_signal</span> <span class="o">=</span> <span class="n">flux_temp</span> <span class="o">/</span> <span class="n">err_temp</span>

            <span class="k">with</span> <span class="n">quantity_support</span><span class="p">():</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="c1">#                for item in ([ax.title, ax.xaxis.label, ax.yaxis.label] +</span>
<span class="c1">#                             ax.get_xticklabels() + ax.get_yticklabels()):</span>
<span class="c1">#                    item.set_fontsize(20)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">snr_cal</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">snr_signal</span><span class="p">)</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mf">0.95</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">wav_temp</span><span class="p">),</span>
                              <span class="mf">1.05</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">wav_temp</span><span class="p">)])</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">snr_cal</span><span class="p">)])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;SNR&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength [</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="o">.</span>
                              <span class="n">calibration_correction</span><span class="o">.</span><span class="n">wavelength_unit</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="o">+</span><span class="n">observations_id</span> <span class="o">+</span>
                            <span class="s1">&#39;_calibration_SNR.png&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span></div></div>
</pre></div>

          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../index.html">
    <img class="logo" src="../../../_static/Exoplanets-A_Ecusson_Noir_Alpha.png" alt="Logo"/>
    
    <h1 class="logo logo-name">CASCADe</h1>
    
  </a>
</p>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Howto Install CASCADe</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../howto.html">Using Cascade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cascade.html">Modules of the CASCADe package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Jeroen Bouwman.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>